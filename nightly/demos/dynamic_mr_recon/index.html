
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Dynamic MR Reconstruction &#8212; CIL 25.0.1.dev17+g4e68c7d4c documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=085432a65528ed429d34" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=085432a65528ed429d34" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- So that users can add custom icons -->
  <script defer src="../../_static/scripts/fontawesome.js?digest=085432a65528ed429d34"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=085432a65528ed429d34" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=085432a65528ed429d34" />

    <script src="../../_static/documentation_options.js?v=3fe0d5fa"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'demos/dynamic_mr_recon';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.2dev0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = '/CIL/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '25.0.1.dev17+g4e68c7d4c';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <script>DOCUMENTATION_OPTIONS.search_as_you_type = false;</script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="a gVXR data reader for CIL" href="../CBCT-acquisition-with-noise-and-reconstruction/" />
    <link rel="prev" title="TV-regularized reconstruction of the dynamix STEMPO dataset in CIL" href="../stempo2d_v2_1/" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="25.0.1.dev17+g4e68c7d4c" />
  
    
    <script src="../../_static/searchtools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../searchindex.js"></script>
  
  </head>
  <body data-default-mode="">
  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>

  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header id="pst-header" class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
     
  

<a class="navbar-brand logo" href="https://tomographicimaging.github.io/CIL">
  
  
  
  
  
    
    
      
    
    
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB.svg" class="logo__image only-light" alt="CIL - Home"/>
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB-reversed.svg" class="logo__image only-dark pst-js-only" alt="CIL - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer_guide/">
    Developers’ Guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../">
    Tutorials
  </a>
</li>


<li class=" current active">
  <a class="nav-link dropdown-item nav-internal" href="../../usershowcase/">
    User showcase
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer_guide/">
    Developers’ Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../usershowcase/">
    User showcase
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        <div class="sidebar-primary-item">
<h3><a href="../../">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../framework/">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/">Read/ write AcquisitionData and ImageData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimisation/">Optimisation framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimisation/#block-framework">Block Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../processors/">Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recon/">Recon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities/">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/">CIL Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/">Developers’ Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../usershowcase/">User showcase</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Multibang_Hackathon2023/">Multibang Regularisation in CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Showcase_of_the_algorithms_for_deblurring_and_denoising/">Showcase of the algorithms for deblurring and denoising</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deriv2_cgls/">1D inverse problem demo using deriv2 from regtools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stempo2d_v2_1/">TV-regularized reconstruction of the dynamix STEMPO dataset in CIL</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Dynamic MR Reconstruction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#CIL-Version-22.2.0">CIL Version 22.2.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="#SIRF-Version-3.4.0">SIRF Version 3.4.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="#The-Dataset">The Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Load-and-inspect-the-data">Load and inspect the data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Prepare-dynamic-reconstruction">Prepare dynamic reconstruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Dynamic-reconstruction-without-regularisation">Dynamic reconstruction without regularisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Dynamic-reconstruction-with-TV-regularisation">Dynamic reconstruction with TV regularisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Visualise-results">Visualise results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/">a gVXR data reader for CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Aims-of-this-session">Aims of this session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Main-steps">Main steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Create-directories">Create directories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Import-packages">Import packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-1.-Download-and-extract-the-phantom-data-from-a-ZIP-file.">Step 1. Download and extract the phantom data from a ZIP file.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-2.-Extract-surface-meshes-from-the-voxelied-phantom.">Step 2. Extract surface meshes from the voxelied phantom.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-3.-Simulate-an-X-ray-radiograph-of-the-virtual-patient.">Step 3. Simulate an X-ray radiograph of the virtual patient.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-4.-Select-the-number-of-incident-photons-per-pixel">Step 4. Select the number of incident photons per pixel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-5.-Add-the-corresponding-amount-of-Photonic-noise">Step 5. Add the corresponding amount of Photonic noise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-6.-Create-the-flat-field-images-with-the-corresponding-amount-of-Photonic-noise.">Step 6. Create the flat-field images with the corresponding amount of Photonic noise.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-7.-Simulate-a-CT-scan">Step 7. Simulate a CT scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-8.-Reconstruct-the-CT-volume-using-the-Core-Imaging-Library-(CIL)">Step 8. Reconstruct the CT volume using the Core Imaging Library (CIL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Cleaning-up">Cleaning up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Hyperspectral_regularisation/">Reconstruction and regularisation for a hyperspectral dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/">Comparison between the Least Square and the Weighted Least Square and the Kullback Leibler Divergence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Reconstructing-the-noisy-data-using-KL-divergence-with-TV-regularisation">Reconstructing the noisy data using KL divergence with TV regularisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Compare-all-the-reconstructions">Compare all the reconstructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Comparisons-between-LS,-WLS-and-KL-loss-for-a-range-of-counts">Comparisons between LS, WLS and KL loss for a range of counts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Apple_offset_reconstruction/">Cone-beam offset reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/">microCT reconstruction with Bruker data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Set-variables-and-paths">Set variables and paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Create-acquisition-geometry">Create acquisition geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Read-files">Read files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Data-processing">Data processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Prepare-back-projection">Prepare back-projection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Review-projection-data-before-running-the-recontruction">Review projection data before running the recontruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Perform-reconstruction">Perform reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Display-results">Display results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Optional:-Save-results-as-tiff-files">Optional: Save results as tiff files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Optional:-Save-results-as-json-files">Optional: Save results as json files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../recon_phasecontrast_exciscope/">Exciscope Polaris phase contrast reconstruction with CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_2d/">Controlled Wavelet Sparsity using callbacks (2D data)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_2d/#Wavelet-based-regularization">Wavelet based regularization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_3d/">Controlled Wavelet Sparsity using callbacks (3D data)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_3d/#Wavelet-based-regularization">Wavelet based regularization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../013_Anisotropic_regularisation_FILD_measurements/">CIL User Showcase 13: Anisotropic Regularization for FILD Measurements using CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/">Simulation using gVXR and CPU reconstruction using CIL of a twisted hexagonal object with helical flow channels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Read-projections">Read projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Reconstruction">Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Conclusion">Conclusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory_profiling_sandstone/">Memory and Performance Profiling CIL Algorithms: CGLS vs. LSQR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fista_with_denoiser/">A CIL-pytorch example using DeepInverse using a pre-trained denoiser in the CIL FISTA algorithm</a></li>
</ul>
</li>
</ul>
</div>
        <div class="sidebar-primary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/TomographicImaging/CIL/edit/master/docs/source/demos/dynamic_mr_recon.ipynb">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../usershowcase/" class="nav-link">User showcase</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Dynamic MR Reconstruction</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#  Copyright 2023 Physikalisch-Technische Bundesanstalt (PTB)</span>
<span class="c1">#</span>
<span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#  you may not use this file except in compliance with the License.</span>
<span class="c1">#  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#  See the License for the specific language governing permissions and</span>
<span class="c1">#  limitations under the License.</span>
<span class="c1">#</span>
<span class="c1">#   Authored by:  Christoph Kolbitsch (PTB),</span>
<span class="c1">#   Edited by: Margaret Duff (STFC- UKRI), Letizia Protopapa (STFC- UKRI)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make sure figures appears inline</span>
<span class="o">%</span><span class="k">matplotlib</span> widget
</pre></div>
</div>
</div>
<section id="Dynamic-MR-Reconstruction">
<h1>Dynamic MR Reconstruction<a class="headerlink" href="#Dynamic-MR-Reconstruction" title="Link to this heading">#</a></h1>
<p>MR can be used to capture dynamic processes. These dynamic processes can be used to obtain information about quantitative (bio-)physical parameters. A common parameter important for clinical diagnosis is the longitudinal relaxation time <span class="math notranslate nohighlight">\(T_1\)</span>. In order to quantify <span class="math notranslate nohighlight">\(T_1\)</span> a MR-preparation pulse is used (e.g. inversion pulse) to disturb the equilibrium state of the MR spin system. After the preparation pulse the spin system relaxes back to the equilibrium state and this dynamic process
can be described by the relaxation time <span class="math notranslate nohighlight">\(T_1\)</span>. The dynamic acquisition after the preparation pulse therefore needs to be fast enough to capture the dynamic changes accurately.</p>
<p>Here we are going to reconstruct images covering such a dynamic process. Data is acquired continuously using a Golden radial acquisition scheme and we are going to split this data into different time frames and then reconstruct this data as 2D+t data block. The motivation for reconstructing one block is that we can utilise regularisation between different time points to reduce undersampling artefacts.</p>
<p>Because we are going to do MR image reconstruction we also need SIRF for this.</p>
<p>The imaged object is a phantom which consists of 9 tubes with different types of gel in them. Each tube has a different <span class="math notranslate nohighlight">\(T_1\)</span> time and hence the signal from each tube behaves differently over time.</p>
<section id="CIL-Version-22.2.0">
<h2>CIL Version 22.2.0<a class="headerlink" href="#CIL-Version-22.2.0" title="Link to this heading">#</a></h2>
</section>
<section id="SIRF-Version-3.4.0">
<h2>SIRF Version 3.4.0<a class="headerlink" href="#SIRF-Version-3.4.0" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cil</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cil</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sirf</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sirf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
22.2.0
3.4.0
</pre></div></div>
</div>
</section>
<section id="The-Dataset">
<h2>The Dataset<a class="headerlink" href="#The-Dataset" title="Link to this heading">#</a></h2>
<p>This requires the dataset <code class="docutils literal notranslate"><span class="pre">2D_Dyn_GRad.h5</span></code> from <a class="reference external" href="https://doi.org/10.5281/zenodo.7903233">https://doi.org/10.5281/zenodo.7903233</a>.</p>
<p>Please download the data and update the <code class="docutils literal notranslate"><span class="pre">filename</span></code> variable below to point to where you have the data saved:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;./2D_Dyn_GRad.h5&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import engine module</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sirf.Gadgetron</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pMR</span>

<span class="c1"># import CIL functionality for visualisation and iterative reconstruction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.algorithms</span><span class="w"> </span><span class="kn">import</span> <span class="n">FISTA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LeastSquares</span><span class="p">,</span> <span class="n">ZeroFunction</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cil.framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockDataContainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.operators</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockOperator</span><span class="p">,</span> <span class="n">ZeroOperator</span>

<span class="c1"># import further modules</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</pre></div>
</div>
</div>
</section>
<section id="Load-and-inspect-the-data">
<h2>Load and inspect the data<a class="headerlink" href="#Load-and-inspect-the-data" title="Link to this heading">#</a></h2>
<p>Let’s load the data and have a look at the data acquisition over time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load in the data</span>
<span class="n">acq_data</span> <span class="o">=</span> <span class="n">pMR</span><span class="o">.</span><span class="n">AcquisitionData</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Started reading acquisitions from ./2D_Dyn_GRad.h5
0%..10%..20%..31%..40%..50%..61%..70%..80%..90%..
Finished reading acquisitions from ./2D_Dyn_GRad.h5
</pre></div></div>
</div>
<p>Data is aquired by sampling radial angles in k-space in an order determined by the golden ratio. Here we plot the first 1,2,4, and 20 angles.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get k-space dimensions</span>
<span class="n">kdim</span> <span class="o">=</span> <span class="n">acq_data</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Get trajectory</span>
<span class="n">ktraj</span> <span class="o">=</span> <span class="n">pMR</span><span class="o">.</span><span class="n">get_data_trajectory</span><span class="p">(</span><span class="n">acq_data</span><span class="p">)</span>
<span class="n">ktraj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ktraj</span><span class="p">,</span> <span class="p">(</span><span class="n">kdim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kdim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>


<span class="c1"># Plot first 1,2,4 and 20 radial lines</span>
<span class="n">plot_nrad</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">titles</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1st angles&#39;</span><span class="p">,</span> <span class="s2">&quot;First 2 angles&quot;</span><span class="p">,</span> <span class="s2">&quot;First 4 angles&quot;</span><span class="p">,</span> <span class="s2">&quot;First 20 angles&quot;</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">cax</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
    <span class="n">cax</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
    <span class="n">cax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">jnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plot_nrad</span><span class="p">[</span><span class="n">jnd</span><span class="p">]):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">jnd</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ktraj</span><span class="p">[</span><span class="n">ind</span><span class="p">,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ktraj</span><span class="p">[</span><span class="n">ind</span><span class="p">,:,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">jnd</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">jnd</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9443d8903d90402ba827e9ba36ed8aac", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Before we continue with the dynamic reconstruction we need to calculate the coil sensitivity maps:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate coil sensitivity maps</span>
<span class="n">csm</span> <span class="o">=</span> <span class="n">pMR</span><span class="o">.</span><span class="n">CoilSensitivityData</span><span class="p">()</span>
<span class="n">csm</span><span class="o">.</span><span class="n">smoothness</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">csm</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">acq_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Prepare-dynamic-reconstruction">
<h2>Prepare dynamic reconstruction<a class="headerlink" href="#Prepare-dynamic-reconstruction" title="Link to this heading">#</a></h2>
<p>We are going to split the data into Ndyn dynamic frames each with <code class="docutils literal notranslate"><span class="pre">Nrad_per_dyn</span></code> radial lines. We chose <code class="docutils literal notranslate"><span class="pre">N_dyn</span></code> small here to speed things up and won’t be using all the data (1440 radial spokes) but feel free to adapt this.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters for dynamics</span>
<span class="n">Ndyn</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">Nrad_per_dyn</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>
</div>
</div>
<p>Now we are going to select the data <code class="docutils literal notranslate"><span class="pre">acq_data</span></code> and define the acquisition model <code class="docutils literal notranslate"><span class="pre">E_dyn</span></code> for each dynamic frame. A preliminary (i.e. pseudo-inverse) reconstruction is calculated in <code class="docutils literal notranslate"><span class="pre">im_dyn_inv</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Go through each dynamic, create corresponding k-space and acquisition model</span>
<span class="n">acq_dyn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ndyn</span>
<span class="n">E_dyn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ndyn</span>
<span class="n">im_dyn_inv</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ndyn</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ndyn</span><span class="p">):</span>
    <span class="n">acq_idx_dyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ind</span><span class="o">*</span><span class="n">Nrad_per_dyn</span><span class="p">,</span> <span class="p">(</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Nrad_per_dyn</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nrad_per_dyn</span><span class="p">)</span>
    <span class="n">acq_dyn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">acq_data</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">acq_idx_dyn</span><span class="p">)</span>
    <span class="n">acq_dyn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">sort_by_time</span><span class="p">()</span>

    <span class="c1"># Create acquisition model</span>
    <span class="n">E_tmp</span> <span class="o">=</span> <span class="n">pMR</span><span class="o">.</span><span class="n">AcquisitionModel</span><span class="p">(</span><span class="n">acqs</span><span class="o">=</span><span class="n">acq_dyn</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">imgs</span><span class="o">=</span><span class="n">csm</span><span class="p">)</span>
    <span class="n">E_tmp</span><span class="o">.</span><span class="n">set_coil_sensitivity_maps</span><span class="p">(</span><span class="n">csm</span><span class="p">)</span>
    <span class="n">im_dyn_inv</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_tmp</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">acq_dyn</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

    <span class="n">E_dyn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMR</span><span class="o">.</span><span class="n">AcquisitionModel</span><span class="p">(</span><span class="n">acqs</span><span class="o">=</span><span class="n">acq_dyn</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">imgs</span><span class="o">=</span><span class="n">im_dyn_inv</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="n">E_dyn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">set_coil_sensitivity_maps</span><span class="p">(</span><span class="n">csm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In order to be able to reconstruct all the dynamics at the same time, we have to create a diagonal matrix with all the acquisition models along the diagonal and zero-operators everywhere else. The acquisition data is also stacked in a block data container. The problem we want to solve in the end is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\min_{[x_0\cdots x_{NDyn}]^T} \left\Vert \begin{bmatrix}
    E_0 &amp; 0 &amp; 0\\
    0 &amp; \ddots &amp; 0 \\
    0 &amp; 0 &amp; E_{NDyn}
  \end{bmatrix}
  \begin{bmatrix}
    x_0 \\
    \vdots \\
    x_{NDyn}
  \end{bmatrix} -
  \begin{bmatrix}
    a_0 \\
    \vdots \\
    a_{NDyn}
  \end{bmatrix}
  \right\Vert_2^2\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(a\)</span> is <code class="docutils literal notranslate"><span class="pre">acq_data</span></code>, <span class="math notranslate nohighlight">\(E\)</span> is <code class="docutils literal notranslate"><span class="pre">E_dyn</span></code> and <span class="math notranslate nohighlight">\(x\)</span> are the reconstructed dynamic images.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># AcquisitionModel for each dynamic</span>

<span class="c1"># Create zero operator</span>
<span class="n">ZOp</span> <span class="o">=</span> <span class="n">ZeroOperator</span><span class="p">(</span><span class="n">E_dyn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">(),</span> <span class="n">E_dyn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">range_geometry</span><span class="p">())</span>

<span class="n">E_dyn_diag</span> <span class="o">=</span> <span class="p">[</span><span class="n">ZOp</span><span class="p">,]</span><span class="o">*</span><span class="p">(</span><span class="n">Ndyn</span><span class="o">*</span><span class="n">Ndyn</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ndyn</span><span class="p">):</span>
    <span class="n">E_dyn_diag</span><span class="p">[</span><span class="n">ind</span><span class="o">*</span><span class="n">Ndyn</span><span class="o">+</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_dyn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">BlockOperator</span><span class="p">(</span><span class="o">*</span><span class="n">E_dyn_diag</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Ndyn</span><span class="p">,</span> <span class="n">Ndyn</span><span class="p">))</span>

<span class="c1"># Put together all the raw k-space data for each motion state in a BlockDataContainer</span>
<span class="n">acq_dyn_block</span> <span class="o">=</span> <span class="n">BlockDataContainer</span><span class="p">(</span><span class="o">*</span><span class="n">acq_dyn</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>Initialise the reconstruction with the psuedo-inverse:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># Starting image</span>
<span class="n">x_init</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">acq_dyn_block</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Dynamic-reconstruction-without-regularisation">
<h2>Dynamic reconstruction without regularisation<a class="headerlink" href="#Dynamic-reconstruction-without-regularisation" title="Link to this heading">#</a></h2>
<p>We use CIL and the FISTA algorithm to solve the least squares problem</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up optimisation</span>
<span class="n">x_init_zero</span> <span class="o">=</span> <span class="n">x_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">x_init_zero</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># Objective function</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">LeastSquares</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">acq_dyn_block</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">calculate_Lipschitz</span><span class="p">()</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">ZeroFunction</span><span class="p">()</span>

<span class="c1"># Set up FISTA for least squares</span>
<span class="n">fista</span> <span class="o">=</span> <span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">x_init_zero</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">)</span>
<span class="n">fista</span><span class="o">.</span><span class="n">max_iteration</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">fista</span><span class="o">.</span><span class="n">update_objective_interval</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Run FISTA</span>
<span class="n">fista</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Get result</span>
<span class="n">im_fista</span> <span class="o">=</span> <span class="n">fista</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     Iter   Max Iter     Time/Iter            Objective
                               [s]
        0         60         0.000          8.05277e-03
       10         60         7.840          1.42176e-04
       20         60         7.683          2.79802e-05
       30         60         7.713          1.93923e-05
       40         60         7.783          1.72206e-05
       50         60         7.757          1.67181e-05
       60         60         7.674          1.65991e-05
-------------------------------------------------------
       60         60         7.674          1.65991e-05
Stop criterion has been reached.

</pre></div></div>
</div>
<p>With early stopping the results look look better:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up optimisation</span>
<span class="n">x_init_zero</span> <span class="o">=</span> <span class="n">x_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">x_init_zero</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># Objective function</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">LeastSquares</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">acq_dyn_block</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">calculate_Lipschitz</span><span class="p">()</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">ZeroFunction</span><span class="p">()</span>

<span class="c1"># Set up FISTA for least squares</span>
<span class="n">fista_early_stopping</span> <span class="o">=</span> <span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">x_init_zero</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">)</span>
<span class="n">fista_early_stopping</span><span class="o">.</span><span class="n">max_iteration</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">fista_early_stopping</span><span class="o">.</span><span class="n">update_objective_interval</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Run FISTA</span>
<span class="n">fista_early_stopping</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Get result</span>
<span class="n">im_fista_early_stopping</span> <span class="o">=</span> <span class="n">fista_early_stopping</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     Iter   Max Iter     Time/Iter            Objective
                               [s]
        0         10         0.000          8.05277e-03
       10         10         7.387          1.42176e-04
-------------------------------------------------------
       10         10         7.387          1.42176e-04
Stop criterion has been reached.

</pre></div></div>
</div>
</section>
<section id="Dynamic-reconstruction-with-TV-regularisation">
<h2>Dynamic reconstruction with TV regularisation<a class="headerlink" href="#Dynamic-reconstruction-with-TV-regularisation" title="Link to this heading">#</a></h2>
<p>In order to add TV-regularisation we need a bit of code which handles the diagonal structure of our image reconstruction problem. The main idea is to take the block data container and transform it into a 3d image, i.e. translate the “block-dimension” into the “channel-dimension” of a single image. Then we can apply the TV operator and afterwards we split it up again into different blocks. The code is found in <code class="docutils literal notranslate"><span class="pre">tv_for_bdc.py</span></code> so we simply import it.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;CIL-User-Showcase/dynamic_mr_recon/&#39;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tv_for_bdc</span><span class="w"> </span><span class="kn">import</span> <span class="n">FGP_TV_BDC</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up optimisation</span>
<span class="n">x_init_zero</span> <span class="o">=</span> <span class="n">x_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Objective function</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">LeastSquares</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">acq_dyn_block</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">calculate_Lipschitz</span><span class="p">()</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="mf">2e-5</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">FGP_TV_BDC</span><span class="p">(</span><span class="n">x_init_zero</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

<span class="c1"># Set up FISTA for least squares</span>
<span class="n">fista</span> <span class="o">=</span> <span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">x_init_zero</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">)</span>
<span class="n">fista</span><span class="o">.</span><span class="n">max_iteration</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">fista</span><span class="o">.</span><span class="n">update_objective_interval</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Run FISTA</span>
<span class="n">fista</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Get result</span>
<span class="n">im_fista_tv</span> <span class="o">=</span> <span class="n">fista</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     Iter   Max Iter     Time/Iter            Objective
                               [s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/SIRF-SuperBuild/INSTALL/python/cil/plugins/ccpi_regularisation/functions/regularisers.py:125: ComplexWarning: Casting complex values to real discards the imaginary part
  in_arr = np.asarray(x.as_array(), dtype=np.float32, order=&#39;C&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
        0         50         0.000          8.13893e-03
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
       10         50         7.901          1.57843e-04
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
       20         50         8.441          4.00597e-05
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
       30         50         8.611          3.31214e-05
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
       40         50         8.736          3.09825e-05
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
doing proximal_numpy, type of in_arr is  float32
doing _fista_on_dual_rof, type of in_arr is  float32
       50         50         8.860          3.05365e-05
-------------------------------------------------------
       50         50         8.860          3.05365e-05
Stop criterion has been reached.

</pre></div></div>
</div>
</section>
<section id="Visualise-results">
<h2>Visualise results<a class="headerlink" href="#Visualise-results" title="Link to this heading">#</a></h2>
<p>Here we plot in the rows the reconstruction from the psuedo inverse, least squares reconstruction with fista, and the TV regularised solution. The columns show reconstructions from 6 time frames, spread across the total range of time frames. The final column shows one column of the reconstruction at each step in time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List of images to 2D+t matrix</span>
<span class="n">im_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">im_dyn_inv</span><span class="p">,</span> <span class="n">im_fista</span><span class="p">,</span> <span class="n">im_fista_early_stopping</span><span class="p">,</span> <span class="n">im_fista_tv</span><span class="p">]</span>
<span class="n">im_2dt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)):</span>
    <span class="n">cim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">jnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">[</span><span class="n">ind</span><span class="p">])):</span>
        <span class="n">cim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">im_list</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">jnd</span><span class="p">]</span><span class="o">.</span><span class="n">as_array</span><span class="p">()))[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    <span class="n">im_2dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">cim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Normalise images</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">)):</span>
    <span class="n">im_2dt</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_2dt</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>

<span class="c1"># Plot images</span>
<span class="n">nplots</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Ndyn</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">),</span> <span class="n">nplots</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">constrained_layout</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nplots</span><span class="p">):</span>
    <span class="n">cidx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ind</span> <span class="o">/</span> <span class="n">nplots</span> <span class="o">*</span> <span class="n">Ndyn</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">jnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">)):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">jnd</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">[</span><span class="n">jnd</span><span class="p">][:,:,</span><span class="n">cidx</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">jnd</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">jnd</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pseudo Inv </span><span class="se">\n</span><span class="s1"> y&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;FISTA </span><span class="se">\n</span><span class="s1"> y&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;FISTA early stopping </span><span class="se">\n</span><span class="s1"> y&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;FISTA + TV </span><span class="se">\n</span><span class="s1"> y&#39;</span><span class="p">)</span>

<span class="c1"># Last column is a plot of space vs time</span>
<span class="k">for</span> <span class="n">jnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">)):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">jnd</span><span class="p">,</span><span class="n">nplots</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_2dt</span><span class="p">[</span><span class="n">jnd</span><span class="p">][</span><span class="mi">64</span><span class="p">,:,:],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">jnd</span><span class="p">,</span><span class="n">nplots</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">jnd</span><span class="p">,</span><span class="n">nplots</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "63d384922228446497a7531a765cedfc", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../stempo2d_v2_1/"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">TV-regularized reconstruction of the dynamix STEMPO dataset in CIL</p>
      </div>
    </a>
    <a class="right-next"
       href="../CBCT-acquisition-with-noise-and-reconstruction/"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">a gVXR data reader for CIL</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=085432a65528ed429d34"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=085432a65528ed429d34"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2017-2024.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>