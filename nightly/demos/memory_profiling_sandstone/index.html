
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Memory and Performance Profiling CIL Algorithms: CGLS vs. LSQR &#8212; CIL 25.0.1.dev16+g6550267a3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=085432a65528ed429d34" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=085432a65528ed429d34" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- So that users can add custom icons -->
  <script defer src="../../_static/scripts/fontawesome.js?digest=085432a65528ed429d34"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=085432a65528ed429d34" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=085432a65528ed429d34" />

    <script src="../../_static/documentation_options.js?v=e69036ae"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'demos/memory_profiling_sandstone';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.2dev0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = '/CIL/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '25.0.1.dev16+g6550267a3';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <script>DOCUMENTATION_OPTIONS.search_as_you_type = false;</script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="A CIL-pytorch example using DeepInverse using a pre-trained denoiser in the CIL FISTA algorithm" href="../fista_with_denoiser/" />
    <link rel="prev" title="Simulation using gVXR and CPU reconstruction using CIL of a twisted hexagonal object with helical flow channels" href="../Simulation_and_CPU_reconstruction/" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="25.0.1.dev16+g6550267a3" />
  
    
    <script src="../../_static/searchtools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../searchindex.js"></script>
  
  </head>
  <body data-default-mode="">
  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>

  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header id="pst-header" class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
     
  

<a class="navbar-brand logo" href="https://tomographicimaging.github.io/CIL">
  
  
  
  
  
    
    
      
    
    
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB.svg" class="logo__image only-light" alt="CIL - Home"/>
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB-reversed.svg" class="logo__image only-dark pst-js-only" alt="CIL - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer_guide/">
    Developers’ Guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../">
    Tutorials
  </a>
</li>


<li class=" current active">
  <a class="nav-link dropdown-item nav-internal" href="../../usershowcase/">
    User showcase
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer_guide/">
    Developers’ Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../usershowcase/">
    User showcase
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        <div class="sidebar-primary-item">
<h3><a href="../../">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../framework/">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/">Read/ write AcquisitionData and ImageData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimisation/">Optimisation framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimisation/#block-framework">Block Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../processors/">Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recon/">Recon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities/">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/">CIL Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/">Developers’ Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../usershowcase/">User showcase</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Multibang_Hackathon2023/">Multibang Regularisation in CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Showcase_of_the_algorithms_for_deblurring_and_denoising/">Showcase of the algorithms for deblurring and denoising</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deriv2_cgls/">1D inverse problem demo using deriv2 from regtools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stempo2d_v2_1/">TV-regularized reconstruction of the dynamix STEMPO dataset in CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamic_mr_recon/">Dynamic MR Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/">a gVXR data reader for CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Aims-of-this-session">Aims of this session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Main-steps">Main steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Create-directories">Create directories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Import-packages">Import packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-1.-Download-and-extract-the-phantom-data-from-a-ZIP-file.">Step 1. Download and extract the phantom data from a ZIP file.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-2.-Extract-surface-meshes-from-the-voxelied-phantom.">Step 2. Extract surface meshes from the voxelied phantom.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-3.-Simulate-an-X-ray-radiograph-of-the-virtual-patient.">Step 3. Simulate an X-ray radiograph of the virtual patient.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-4.-Select-the-number-of-incident-photons-per-pixel">Step 4. Select the number of incident photons per pixel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-5.-Add-the-corresponding-amount-of-Photonic-noise">Step 5. Add the corresponding amount of Photonic noise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-6.-Create-the-flat-field-images-with-the-corresponding-amount-of-Photonic-noise.">Step 6. Create the flat-field images with the corresponding amount of Photonic noise.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-7.-Simulate-a-CT-scan">Step 7. Simulate a CT scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-8.-Reconstruct-the-CT-volume-using-the-Core-Imaging-Library-(CIL)">Step 8. Reconstruct the CT volume using the Core Imaging Library (CIL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Cleaning-up">Cleaning up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Hyperspectral_regularisation/">Reconstruction and regularisation for a hyperspectral dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/">Comparison between the Least Square and the Weighted Least Square and the Kullback Leibler Divergence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Reconstructing-the-noisy-data-using-KL-divergence-with-TV-regularisation">Reconstructing the noisy data using KL divergence with TV regularisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Compare-all-the-reconstructions">Compare all the reconstructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Comparisons-between-LS,-WLS-and-KL-loss-for-a-range-of-counts">Comparisons between LS, WLS and KL loss for a range of counts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Apple_offset_reconstruction/">Cone-beam offset reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/">microCT reconstruction with Bruker data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Set-variables-and-paths">Set variables and paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Create-acquisition-geometry">Create acquisition geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Read-files">Read files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Data-processing">Data processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Prepare-back-projection">Prepare back-projection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Review-projection-data-before-running-the-recontruction">Review projection data before running the recontruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Perform-reconstruction">Perform reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Display-results">Display results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Optional:-Save-results-as-tiff-files">Optional: Save results as tiff files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Optional:-Save-results-as-json-files">Optional: Save results as json files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../recon_phasecontrast_exciscope/">Exciscope Polaris phase contrast reconstruction with CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_2d/">Controlled Wavelet Sparsity using callbacks (2D data)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_2d/#Wavelet-based-regularization">Wavelet based regularization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_3d/">Controlled Wavelet Sparsity using callbacks (3D data)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_3d/#Wavelet-based-regularization">Wavelet based regularization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../013_Anisotropic_regularisation_FILD_measurements/">CIL User Showcase 13: Anisotropic Regularization for FILD Measurements using CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/">Simulation using gVXR and CPU reconstruction using CIL of a twisted hexagonal object with helical flow channels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Read-projections">Read projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Reconstruction">Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Conclusion">Conclusion</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Memory and Performance Profiling CIL Algorithms: CGLS vs. LSQR</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Loading-The-Sandstone-Dataset">Loading The Sandstone Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Ground-Truth---FBP-Reconstruction-of-pre-processed-sandstone">Ground Truth - FBP Reconstruction of pre-processed sandstone</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Generating-Test-Sinogram---Apply-Noise:">Generating Test Sinogram - Apply Noise:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#CGLS-and-LSQR-without-regularisation">CGLS and LSQR without regularisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Memory-Profiling">Memory Profiling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Tikhonov-regularisation-using-CGLS-and-LSQR---with-or-without-a-block">Tikhonov regularisation using CGLS and LSQR - with or without a block</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Memory-costs-for-LSQR+Block,-CGLS+Block-and-LSQR+Tikhonov">Memory costs for LSQR+Block, CGLS+Block and LSQR+Tikhonov</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Conclusion:">Conclusion:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../fista_with_denoiser/">A CIL-pytorch example using DeepInverse using a pre-trained denoiser in the CIL FISTA algorithm</a></li>
</ul>
</li>
</ul>
</div>
        <div class="sidebar-primary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/TomographicImaging/CIL/edit/master/docs/source/demos/memory_profiling_sandstone.ipynb">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../usershowcase/" class="nav-link">User showcase</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Memory and Performance Profiling CIL Algorithms: CGLS vs. LSQR</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#  Copyright 2025 United Kingdom Research and Innovation</span>
<span class="c1">#</span>
<span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#  you may not use this file except in compliance with the License.</span>
<span class="c1">#  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#  See the License for the specific language governing permissions and</span>
<span class="c1">#  limitations under the License.</span>
<span class="c1">#</span>
<span class="c1">#   Authored by: Mariam Demir (STFC-UKRI)</span>
<span class="c1">#                Maike Meier (STFC-UKRI)</span>
</pre></div>
</div>
</div>
<section id="Memory-and-Performance-Profiling-CIL-Algorithms:-CGLS-vs.-LSQR">
<h1>Memory and Performance Profiling CIL Algorithms: CGLS vs. LSQR<a class="headerlink" href="#Memory-and-Performance-Profiling-CIL-Algorithms:-CGLS-vs.-LSQR" title="Link to this heading">#</a></h1>
<div class="line-block">
<div class="line">This notebook describes a newly-added CIL algorithm, LSQR, and compares its performance and memory usage to CGLS.</div>
<div class="line">The aims of this notebook are to:</div>
</div>
<ul class="simple">
<li><p>Introduce the LSQR algorithm, and the LSQR Tikhonov variant</p></li>
<li><p>Compare the reconstructions obtained from LSQR to CGLS, and to a ground truth (FBP reconstruction)</p></li>
<li><p>Compare LSQR’s running times across iterations with CGLS</p></li>
<li><p>Benchmark and validate two memory profiling techniques, using CGLS as an example</p></li>
<li><p>Use the memory profiling techniques to investigate where the LSQR algorithm increases the memory</p></li>
<li><p>Compare the memory usage of LSQR to CGLS</p></li>
<li><p>Compare and investigate the memory usages of CGLS and LSQR with block operators, and LSQR Tikhonov</p></li>
</ul>
<p>This notebook was tested and developed with the following package versions: | Package | Version | |———|———| | CIL (Core Imaging Library) | 24.2.0 | | NumPy | 1.26.4 | | Matplotlib | 3.10.1 | | memory-profiler | 0.61.0 | | astra-toolbox | 2.1.0 | | scipy | 1.15.2 | | ipp | 2021.12.1 | | jinja2 | 3.1.6 |</p>
<p>Create the environment using the command:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">create</span> <span class="pre">--name</span> <span class="pre">cil</span> <span class="pre">-c</span> <span class="pre">conda-forge</span> <span class="pre">-c</span> <span class="pre">https://software.repos.intel.com/python/conda</span> <span class="pre">-c</span> <span class="pre">ccpi</span> <span class="pre">cil=24.2.0</span> <span class="pre">ipp=2021.12</span> <span class="pre">astra-toolbox=*=cuda*</span> <span class="pre">ipykernel</span> <span class="pre">ipywidgets</span> <span class="pre">scipy</span> <span class="pre">Jinja2</span></code></p></li>
</ul>
<p>And install the following packages using pip:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-U</span> <span class="pre">memory_profiler</span></code></p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;./Algorithms&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;./Scripts&quot;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">LSQR</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">LSQR_Tikhonov</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">LSQRLP</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">LSQRMP</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">CGLSLP</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">CGLSMP</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># CIL core components needed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.processors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normaliser</span><span class="p">,</span> <span class="n">TransmissionAbsorptionConverter</span><span class="p">,</span> <span class="n">Padder</span><span class="p">,</span> <span class="n">CentreOfRotationCorrector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">AcquisitionGeometry</span><span class="p">,</span> <span class="n">AcquisitionData</span><span class="p">,</span> <span class="n">BlockDataContainer</span>

<span class="c1"># CIL optimisation algorithms and linear operators</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.algorithms</span><span class="w"> </span><span class="kn">import</span> <span class="n">CGLS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.operators</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockOperator</span><span class="p">,</span> <span class="n">IdentityOperator</span>

<span class="c1"># CIL example synthetic test image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataexample</span>

<span class="c1"># CIL display tools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.utilities.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">show2D</span>

<span class="c1"># CIL FBP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.recon</span><span class="w"> </span><span class="kn">import</span> <span class="n">FBP</span>

<span class="c1"># Forward/backprojector from CIL ASTRA plugin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.plugins.astra</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProjectionOperator</span>

<span class="c1"># Utility functions for this dataset &amp; notebook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">timed_iterations</span><span class="p">,</span> <span class="n">mem_prof_process</span><span class="p">,</span> <span class="n">line_prof_process</span><span class="p">,</span> <span class="n">line_peak_process</span><span class="p">,</span> <span class="n">plot_mem</span><span class="p">,</span> <span class="n">print_output_subset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="c1"># Third-party imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">MB</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">dtypeSize</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
<section id="Loading-The-Sandstone-Dataset">
<h2>Loading The Sandstone Dataset<a class="headerlink" href="#Loading-The-Sandstone-Dataset" title="Link to this heading">#</a></h2>
<p>The dataset used in this notebook is a 2D Tomogram of sandstone, containing:</p>
<ul class="simple">
<li><p>1500 projections</p></li>
<li><p>A single vertical slice</p></li>
<li><p>2560 horizontal pixels (which will later become padded to 3760 pixels)</p></li>
</ul>
<p>From this information, we can calculate the estimated sizes of the <strong>AcquisitionData</strong>, and the <strong>ImageData</strong> (a.k.a Reconstruction Volume). These values will be important when looking at memory usage:</p>
<ul class="simple">
<li><p>AcquisitionData size: (1500 * 3760 * <em>dtypeSize</em>) = 21.5 MB</p></li>
<li><p>ImageData size: (3760 * 3760 * <em>dtypeSize</em>) = 53.9 MB</p></li>
</ul>
<p>We will download the data using the method <code class="docutils literal notranslate"><span class="pre">dataexample.SANDSTONE.download_data()</span></code>. Then, we pre-process and reconstruct the data using Filtered Back Projection to get a ground truth. Finally, we apply noise to the dataset sinogram, which will be used when running the algorithms.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataexample</span><span class="o">.</span><span class="n">SANDSTONE</span><span class="o">.</span><span class="n">download_data</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dataset folder already exists in .
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datapath</span> <span class="o">=</span> <span class="s1">&#39;./sandstone&#39;</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;slice_0270_data.mat&quot;</span>
<span class="n">all_data</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sandstone</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;X_proj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sandstone</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(2560, 1500)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ag</span> <span class="o">=</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">create_Parallel2D</span><span class="p">()</span>  \
         <span class="o">.</span><span class="n">set_panel</span><span class="p">(</span><span class="n">num_pixels</span><span class="o">=</span><span class="p">(</span><span class="mi">2560</span><span class="p">))</span>        \
         <span class="o">.</span><span class="n">set_angles</span><span class="p">(</span><span class="n">angles</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">1500</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> \
         <span class="o">.</span><span class="n">set_labels</span><span class="p">([</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span><span class="s1">&#39;angle&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">)</span>

<span class="n">sandstone</span> <span class="o">=</span> <span class="n">AcquisitionData</span><span class="p">(</span><span class="n">sandstone</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">ag</span><span class="p">,</span> <span class="n">deep_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sandstone</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;astra&#39;</span><span class="p">)</span>

<span class="n">show2D</span><span class="p">(</span><span class="n">sandstone</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&lt;AcquisitionDimension.HORIZONTAL: &#39;horizontal&#39;&gt;, &lt;AcquisitionDimension.ANGLE: &#39;angle&#39;&gt;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_8_1.png" src="../../_images/demos_memory_profiling_sandstone_8_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;cil.utilities.display.show2D at 0x7f3d02c7dc40&gt;
</pre></div></div>
</div>
</section>
<section id="Ground-Truth---FBP-Reconstruction-of-pre-processed-sandstone">
<h2>Ground Truth - FBP Reconstruction of pre-processed sandstone<a class="headerlink" href="#Ground-Truth---FBP-Reconstruction-of-pre-processed-sandstone" title="Link to this heading">#</a></h2>
<section id="Pre-processing:">
<h3>Pre-processing:<a class="headerlink" href="#Pre-processing:" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flats</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;X_flat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">flats</span><span class="o">.</span><span class="n">shape</span>

<span class="n">darks</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;X_dark&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">darks</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(2560, 30)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sandstone_norm</span> <span class="o">=</span> <span class="n">Normaliser</span><span class="p">(</span><span class="n">flat_field</span><span class="o">=</span><span class="n">flats</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                   <span class="n">dark_field</span><span class="o">=</span><span class="n">darks</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))(</span><span class="n">sandstone</span><span class="p">)</span>

<span class="n">sandstone_norm</span> <span class="o">=</span> <span class="n">TransmissionAbsorptionConverter</span><span class="p">()(</span><span class="n">sandstone_norm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show2D</span><span class="p">([</span><span class="n">sandstone</span><span class="p">,</span> <span class="n">sandstone_norm</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Sandstone&#39;</span><span class="p">,</span> <span class="s1">&#39;Sandstone Normalised&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_13_0.png" src="../../_images/demos_memory_profiling_sandstone_13_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;cil.utilities.display.show2D at 0x7f3ce5ae2d50&gt;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">padsize</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">sandstone_pad</span> <span class="o">=</span> <span class="n">Padder</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">pad_width</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;horizontal&#39;</span><span class="p">:</span> <span class="n">padsize</span><span class="p">})(</span><span class="n">sandstone_norm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show2D</span><span class="p">(</span><span class="n">sandstone_pad</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_15_0.png" src="../../_images/demos_memory_profiling_sandstone_15_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;cil.utilities.display.show2D at 0x7f3d08465310&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sandstone_cor</span> <span class="o">=</span> <span class="n">CentreOfRotationCorrector</span><span class="o">.</span><span class="n">image_sharpness</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;astra&#39;</span><span class="p">,</span> <span class="n">search_range</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)(</span><span class="n">sandstone_pad</span><span class="p">)</span>
<span class="n">sandstone_cor</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_centre_of_rotation</span><span class="p">(</span><span class="n">distance_units</span><span class="o">=</span><span class="s1">&#39;pixels&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;offset&#39;: (44.48700388605622, &#39;pixels&#39;), &#39;angle&#39;: (0.0, &#39;radian&#39;)}
</pre></div></div>
</div>
</section>
<section id="Obtain-ground-truth-reconstruction:">
<h3>Obtain ground truth reconstruction:<a class="headerlink" href="#Obtain-ground-truth-reconstruction:" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ig</span> <span class="o">=</span> <span class="n">sandstone_norm</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_ImageGeometry</span><span class="p">()</span>
<span class="n">recon</span> <span class="o">=</span> <span class="n">FBP</span><span class="p">(</span><span class="n">sandstone_cor</span><span class="p">,</span> <span class="n">ig</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;astra&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
FBP recon

Input Data:
        angle: 1500
        horizontal: 3760

Reconstruction Volume:
        horizontal_y: 2560
        horizontal_x: 2560

Reconstruction Options:
        Backend: astra
        Filter: ram-lak
        Filter cut-off frequency: 1.0
        FFT order: 13
        Filter_inplace: False
        Split processing: 0

Reconstructing in 1 chunk(s):

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show2D</span><span class="p">(</span><span class="n">recon</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Sandstone Reconstruction (Ground Truth)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_19_0.png" src="../../_images/demos_memory_profiling_sandstone_19_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;cil.utilities.display.show2D at 0x7f3cdfea6b10&gt;
</pre></div></div>
</div>
</section>
</section>
<section id="Generating-Test-Sinogram---Apply-Noise:">
<h2>Generating Test Sinogram - Apply Noise:<a class="headerlink" href="#Generating-Test-Sinogram---Apply-Noise:" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Incident intensity: lower counts will increase the noise</span>
<span class="n">background_counts</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># Convert the simulated absorption sinogram to transmission values using Lambert-Beer.</span>
<span class="c1"># Use sandstone_cor as mean for Poisson data generation.</span>
<span class="c1"># Convert back to absorption sinogram.</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">background_counts</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sandstone_cor</span><span class="o">.</span><span class="n">as_array</span><span class="p">())</span>
<span class="n">noisy_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
<span class="n">sand_noisy_data</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">noisy_counts</span><span class="o">/</span><span class="n">background_counts</span><span class="p">)</span>

<span class="c1"># Create new AcquisitionData object with same geometry as sandstone_cor and fill with noisy data.</span>
<span class="n">sandstone_noisy</span> <span class="o">=</span> <span class="n">sandstone_cor</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
<span class="n">sandstone_noisy</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">sand_noisy_data</span><span class="p">)</span>

<span class="n">plots</span> <span class="o">=</span> <span class="p">[</span><span class="n">sandstone_cor</span><span class="p">,</span> <span class="n">sandstone_noisy</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sandstone sinogram&quot;</span><span class="p">,</span> <span class="s2">&quot;sandstone sinogram noisy&quot;</span><span class="p">]</span>
<span class="n">show2D</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span> <span class="n">titles</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_21_0.png" src="../../_images/demos_memory_profiling_sandstone_21_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;cil.utilities.display.show2D at 0x7f3cdffba030&gt;
</pre></div></div>
</div>
</section>
<section id="CGLS-and-LSQR-without-regularisation">
<h2>CGLS and LSQR without regularisation<a class="headerlink" href="#CGLS-and-LSQR-without-regularisation" title="Link to this heading">#</a></h2>
<p>Before describing Tikhonov regularisation, we recall the problem solved by LSQR:</p>
<div class="math notranslate nohighlight">
\[\underset{u}{\mathrm{argmin}}\begin{Vmatrix}A u - b\end{Vmatrix}^2_2\]</div>
<p>where,</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(A\)</span> is the projection operator</p></li>
<li><p><span class="math notranslate nohighlight">\(b\)</span> is the acquired data</p></li>
<li><p><span class="math notranslate nohighlight">\(u\)</span> is the unknown image to be solved for, which is done iteratively by progressively minimising the objective function</p></li>
</ul>
<p>In the solution provided by LSQR the low frequency components tend to converge faster than the high frequency components. This means we need to control the number of iterations carefully to select the optimal solution.</p>
<p>Set up the LSQR algorithm, including specifying its initial point to start from:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sandstone_noisy</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="s1">&#39;astra&#39;</span><span class="p">)</span>
<span class="n">ig</span> <span class="o">=</span> <span class="n">sandstone_noisy</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_ImageGeometry</span><span class="p">()</span>
<span class="n">ag</span> <span class="o">=</span> <span class="n">sandstone_noisy</span><span class="o">.</span><span class="n">geometry</span> <span class="c1"># ig and ag need to be same</span>

<span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;gpu&quot;</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">ProjectionOperator</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

<span class="n">initial</span> <span class="o">=</span> <span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">maxit</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">itsAtATime</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">maxit</span><span class="o">/</span><span class="n">itsAtATime</span><span class="p">)</span>

<span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxit</span><span class="p">,</span> <span class="n">itsAtATime</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">timed_iterations</span></code> function below will be used to run the algorithms in increments, so we can store the residuals, errors and time taken per iteration:</p>
<p>Once set up, we can initialise and run the algorithms for the specified number of iterations:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgls_simple</span> <span class="o">=</span> <span class="n">CGLS</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sandstone_noisy</span><span class="p">)</span>
<span class="n">times_cgls</span><span class="p">,</span> <span class="n">rel_res_vec_cgls</span><span class="p">,</span> <span class="n">rel_err_vec_cgls</span> <span class="o">=</span> <span class="n">timed_iterations</span><span class="p">(</span><span class="n">sandstone_noisy</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">sandstone_cor</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">cgls_simple</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">itsAtATime</span><span class="p">)</span>

<span class="n">lsqr_simple</span> <span class="o">=</span> <span class="n">LSQR</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sandstone_noisy</span><span class="p">)</span>
<span class="n">times_lsqr</span><span class="p">,</span> <span class="n">rel_res_vec_lsqr</span><span class="p">,</span> <span class="n">rel_err_vec_lsqr</span> <span class="o">=</span> <span class="n">timed_iterations</span><span class="p">(</span><span class="n">sandstone_noisy</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">sandstone_cor</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">lsqr_simple</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">itsAtATime</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Convergence/reduction-of-residuals:">
<h3>Convergence/reduction of residuals:<a class="headerlink" href="#Convergence/reduction-of-residuals:" title="Link to this heading">#</a></h3>
<div class="line-block">
<div class="line">The plots below show the progress of the <strong>residuals</strong> and the <strong>relative error</strong> across each iteration.</div>
<div class="line">The residual is described by the term:</div>
</div>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\begin{Vmatrix}A u - b\end{Vmatrix}^2_2\]</div>
<p>Which describes how well the algorithm’s reconstruction matches the data. LSQR is an adaptation of the conjugate gradients method CGLS, so produces the same residuals. However, LSQR is generally more reliable in the case of numerical errors.</p>
</div></blockquote>
<p>The (relative) error describes how well the reconstruction matches the <strong>ground truth</strong>, which is the FBP reconstruction we computed earlier.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">rel_res_vec_cgls</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">rel_res_vec_lsqr</span><span class="p">,</span> <span class="s1">&#39;b.--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;CGLS&#39;</span><span class="p">,</span><span class="s1">&#39;LSQR&#39;</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">rel_err_vec_cgls</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">rel_err_vec_lsqr</span><span class="p">,</span> <span class="s1">&#39;b.--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;CGLS&#39;</span><span class="p">,</span><span class="s1">&#39;LSQR&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_31_0.png" src="../../_images/demos_memory_profiling_sandstone_31_0.png" />
</div>
</div>
<p style="font-size:14px; color:#086bb8;"><p>Figure 1: (Left) This graph shows the progress of the residuals across 100 iterations. Both CGLS and LSQR converge to the same residuals, as the iterations for LSQR and CGLS are mathematically equivalent. The residuals themselves decrease (minimise) across the iterations, meaning the algorithms’ reconstructions match the data closely. (Right) This graph shows the relative error across 100 iterations. Both CGLS and LSQR display identical errors, again because the iterations are equivalent
mathematically. This graph shows that the algorithms’ reconstructions match the FBP reconstruction (ground truth) most at iteration ~20.</p>
</p><p>We can also plot and compare the time taken/elapsed across each iteration:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">times_cgls</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">times_lsqr</span><span class="p">,</span> <span class="s1">&#39;b.--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;CGLS&#39;</span><span class="p">,</span><span class="s1">&#39;LSQR&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f3d023669f0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_34_1.png" src="../../_images/demos_memory_profiling_sandstone_34_1.png" />
</div>
</div>
<p style="font-size:14px; color:#086bb8;"><p>Figure 2: This graph shows the time elapsed at each iteration for CGLS and LSQR. For both algorithms, this relationship is linear. On this device, the elapsed times across 100 iterations are very similar.</p>
</p></section>
</section>
<section id="Memory-Profiling">
<h2>Memory Profiling<a class="headerlink" href="#Memory-Profiling" title="Link to this heading">#</a></h2>
<div class="line-block">
<div class="line">To profile the memory usage, a custom version of the CGLS file was created. <code class="docutils literal notranslate"><span class="pre">CGLS_MP</span></code> uses the <code class="docutils literal notranslate"><span class="pre">memory_profiler</span></code> module to profile the <code class="docutils literal notranslate"><span class="pre">__init__,</span> <span class="pre">set_up</span> <span class="pre">and</span> <span class="pre">run</span></code> methods.</div>
<div class="line">To validate these results, <code class="docutils literal notranslate"><span class="pre">CGLS_LP</span></code> uses <code class="docutils literal notranslate"><span class="pre">psutil</span></code> to manually track the memory usage after each line in these methods. This version also tracks the memory usage in a separate thread, which shows the peak usages in each method. The same was done for LSQR.</div>
</div>
<p>Below, we will run the <code class="docutils literal notranslate"><span class="pre">memory-sandstone.py</span></code> script using the modified files, and analyse the outputs:</p>
<section id="Validating-Profiling-Tools:">
<h3>Validating Profiling Tools:<a class="headerlink" href="#Validating-Profiling-Tools:" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> cgls_mem_prof
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">cgls_mp</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> cgls_line_prof
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">cgls_lp</span> <span class="o">--</span><span class="n">track</span><span class="o">-</span><span class="n">peak</span>
</pre></div>
</div>
</div>
<p>First, we can view the line-by-line memory increases from the <code class="docutils literal notranslate"><span class="pre">memory_profiler</span></code> output:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">cgls_mem_prof</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[:</span><span class="mi">117</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Print set_up, __init__ &amp; run 1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dataset folder already exists in ..
Filename: /home/efv97572/cil-showcase/CIL-User-Showcase/015_Memory_Profiling_LSQR_CGLS/Algorithms/CGLSMP.py

Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
    81   681.71 MiB   681.71 MiB           1       @profile(precision=2)
    82                                             def set_up(self, initial, operator, data):
    83                                                 r&#39;&#39;&#39;Initialisation of the algorithm
    84                                                 Parameters
    85                                                 ------------
    86                                                 operator : Operator
    87                                                     Linear operator for the inverse problem
    88                                                 initial : (optional) DataContainer in the domain of the operator, default is a DataContainer filled with zeros.
    89                                                     Initial guess
    90                                                 data : DataContainer in the range of the operator
    91                                                     Acquired data to reconstruct
    92
    93                                                 &#39;&#39;&#39;
    94   681.71 MiB     0.00 MiB           1           log.info(&#34;%s setting up&#34;, self.__class__.__name__)
    95   735.62 MiB    53.91 MiB           1           self.x = initial.copy()
    96   735.62 MiB     0.00 MiB           1           self.operator = operator
    97
    98   758.32 MiB    22.71 MiB           1           self.r = data - self.operator.direct(self.x)
    99   813.20 MiB    54.88 MiB           1           self.s = self.operator.adjoint(self.r)
   100
   101   867.13 MiB    53.93 MiB           1           self.p = self.s.copy()
   102   888.44 MiB    21.31 MiB           1           self.q = self.operator.range_geometry().allocate()
   103
   104   888.66 MiB     0.21 MiB           1           self.norms0 = self.s.norm()
   105   888.66 MiB     0.00 MiB           1           self.norms = self.s.norm()
   106
   107   888.66 MiB     0.00 MiB           1           self.gamma = self.norms0**2
   108   888.72 MiB     0.06 MiB           1           self.normx = self.x.norm()
   109
   110   888.72 MiB     0.00 MiB           1           self.configured = True
   111   888.72 MiB     0.00 MiB           1           log.info(&#34;%s configured&#34;, self.__class__.__name__)


Filename: /home/efv97572/cil-showcase/CIL-User-Showcase/015_Memory_Profiling_LSQR_CGLS/Algorithms/CGLSMP.py

Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
    63   681.71 MiB   681.71 MiB           1       @profile(precision=2)
    64                                             def __init__(self, initial=None, operator=None, data=None, **kwargs):
    65                                                 &#39;&#39;&#39;initialisation of the algorithm
    66                                                 &#39;&#39;&#39;
    67                                                 #We are deprecating tolerance
    68   681.71 MiB     0.00 MiB           1           self.tolerance=kwargs.pop(&#34;tolerance&#34;, None)
    69   681.71 MiB     0.00 MiB           1           if self.tolerance is not None:
    70                                                     warnings.warn( stacklevel=2, category=DeprecationWarning, message=&#34;Passing tolerance directly to CGLS is being deprecated. Instead we recommend using the callback functionality: https://tomographicimaging.github.io/CIL/nightly/optimisation/#callbacks and in particular the CGLSEarlyStopping callback replicated the old behaviour&#34;)
    71                                                 else:
    72   681.71 MiB     0.00 MiB           1               self.tolerance = 0
    73
    74   681.71 MiB     0.00 MiB           1           super(CGLS_MP, self).__init__(**kwargs)
    75
    76   681.71 MiB     0.00 MiB           1           if initial is None and operator is not None:
    77                                                     initial = operator.domain_geometry().allocate(0)
    78   681.71 MiB     0.00 MiB           1           if initial is not None and operator is not None and data is not None:
    79   888.72 MiB   207.01 MiB           1               self.set_up(initial=initial, operator=operator, data=data)


run 1
Filename: /home/efv97572/cil-showcase/CIL-User-Showcase/015_Memory_Profiling_LSQR_CGLS/Algorithms/CGLSMP.py

Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
   113   888.72 MiB   888.72 MiB           1       @profile(precision=2)
   114                                             def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):
   115                                                 r&#34;&#34;&#34;run upto :code:`iterations` with callbacks/logging.
   116
   117                                                 For a demonstration of callbacks see https://github.com/TomographicImaging/CIL-Demos/blob/main/misc/callback_demonstration.ipynb
   118
   119                                                 Parameters
   120                                                 -----------
   121                                                 iterations: int, default is None
   122                                                     Number of iterations to run. If not set the algorithm will run until :code:`should_stop()` is reached
   123                                                 callbacks: list of callables, default is Defaults to :code:`[ProgressCallback(verbose)]`
   124                                                     List of callables which are passed the current Algorithm object each iteration. Defaults to :code:`[ProgressCallback(verbose)]`.
   125                                                 verbose: 0=quiet, 1=info, 2=debug
   126                                                     Passed to the default callback to determine the verbosity of the printed output.
   127                                                 &#34;&#34;&#34;
   128
   129   888.72 MiB     0.00 MiB           1           if &#39;print_interval&#39; in kwargs:
   130                                                     warnings.warn(&#34;use `TextProgressCallback(miniters)` instead of `run(print_interval)`&#34;,
   131                                                          DeprecationWarning, stacklevel=2)
   132   888.72 MiB     0.00 MiB           1           if callbacks is None:
   133   888.72 MiB     0.00 MiB           1               callbacks = [ProgressCallback(verbose=verbose)]
   134
   135                                                 # transform old-style callbacks into new
   136   888.72 MiB     0.00 MiB           1           callback = kwargs.get(&#39;callback&#39;, None)
   137
   138   888.72 MiB     0.00 MiB           1           if callback is not None:
   139                                                     callbacks.append(_OldCallback(callback, verbose=verbose))
   140   888.72 MiB     0.00 MiB           1           if hasattr(self, &#39;__log_file&#39;):
   141                                                     callbacks.append(LogfileCallback(self.__log_file, verbose=verbose))
   142
   143   888.72 MiB     0.00 MiB           1           if self.should_stop():
   144                                                     print(&#34;Stop criterion has been reached.&#34;)
   145   888.72 MiB     0.00 MiB           1           if iterations is None:
   146                                                     warnings.warn(&#34;`run()` missing `iterations`&#34;, DeprecationWarning, stacklevel=2)
   147                                                     iterations = self.max_iteration
   148
   149   888.72 MiB     0.00 MiB           1           if self.iteration == -1 and self.update_objective_interval&gt;0:
   150   888.72 MiB     0.00 MiB           1               iterations+=1
   151
   152                                                 # call `__next__` upto `iterations` times or until `StopIteration` is raised
   153   888.72 MiB     0.00 MiB           1           self.max_iteration = self.iteration + iterations
   154
   155   888.72 MiB     0.00 MiB           2           iters = (count(self.iteration) if numpy.isposinf(self.max_iteration)
   156   888.72 MiB     0.00 MiB           1                    else range(self.iteration, self.max_iteration))
   157
   158   888.92 MiB     0.06 MiB           3           for _ in zip(iters, self):
   159   888.92 MiB     0.00 MiB           2               try:
   160   888.92 MiB     0.00 MiB           4                   for callback in callbacks:
   161   888.92 MiB     0.14 MiB           2                       callback(self)
   162                                                     except StopIteration:
   163                                                         break
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ImageData and AcquisitionData Sizes</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate of &#39;initial&#39; (ImageData) size: </span><span class="si">{</span><span class="n">initial</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">dtypeSize</span><span class="o">*</span><span class="n">MB</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate of &#39;sandstone_noisy&#39; (AcquisitionData) size: </span><span class="si">{</span><span class="n">sandstone_noisy</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">dtypeSize</span><span class="o">*</span><span class="n">MB</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimate of &#39;initial&#39; (ImageData) size: 53.9 MB
Estimate of &#39;sandstone_noisy&#39; (AcquisitionData) size: 21.5 MB
</pre></div></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">set_up</span></code> method, we can see:</p>
<ul class="simple">
<li><p>3 increases of <strong>~53.9 MB</strong> - these correspond to the size of the <strong>ImageData</strong> space</p></li>
<li><p>2 increases of <strong>~21.5 MB</strong> - corresponding to the <strong>AcquisitionData</strong> space</p></li>
<li><p>Totalling to an increase of around <strong>~205 MB</strong></p></li>
</ul>
<div class="line-block">
<div class="line">These increases are expected. In the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method, the same increase is seen as a result of the call to <code class="docutils literal notranslate"><span class="pre">set_up</span></code> (Highlighted in turquoise).</div>
<div class="line">In each run, there is a small increase in memory usage due to the iterable in line 158, which calls the <code class="docutils literal notranslate"><span class="pre">update</span></code> method.</div>
</div>
<p>For easier visualisation of the Initial and Final usages per method, we process this output and display it as a dataframe. The first usage reading was ~653 MB, which is the memory allocated when loading and processing the dataset. To show the memory usage of the CGLS algorithm alone, this dataframe has been normalised by subtracting the prior memory usage from the results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgls_mp</span> <span class="o">=</span> <span class="n">mem_prof_process</span><span class="p">(</span><span class="n">cgls_mem_prof</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cgls_mp</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: turquoise&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style type="text/css">
#T_c8934_row0_col4, #T_c8934_row1_col4 {
  background-color: turquoise;
}
</style>
<table id="T_c8934">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_c8934_level0_col0" class="col_heading level0 col0" >Method</th>
      <th id="T_c8934_level0_col1" class="col_heading level0 col1" >Method Call</th>
      <th id="T_c8934_level0_col2" class="col_heading level0 col2" >Initial Memory Usage (MiB)</th>
      <th id="T_c8934_level0_col3" class="col_heading level0 col3" >Final Memory Usage (MiB)</th>
      <th id="T_c8934_level0_col4" class="col_heading level0 col4" >Total Memory Usage (MiB)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_c8934_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_c8934_row0_col0" class="data row0 col0" >__init__</td>
      <td id="T_c8934_row0_col1" class="data row0 col1" >def __init__(self, initial=None, operator=None, data=None, **kwargs):</td>
      <td id="T_c8934_row0_col2" class="data row0 col2" >0.00</td>
      <td id="T_c8934_row0_col3" class="data row0 col3" >207.01</td>
      <td id="T_c8934_row0_col4" class="data row0 col4" >207.01</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_c8934_row1_col0" class="data row1 col0" >set_up</td>
      <td id="T_c8934_row1_col1" class="data row1 col1" >def set_up(self, initial, operator, data):</td>
      <td id="T_c8934_row1_col2" class="data row1 col2" >0.00</td>
      <td id="T_c8934_row1_col3" class="data row1 col3" >207.01</td>
      <td id="T_c8934_row1_col4" class="data row1 col4" >207.01</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_c8934_row2_col0" class="data row2 col0" >run 1</td>
      <td id="T_c8934_row2_col1" class="data row2 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row2_col2" class="data row2 col2" >207.01</td>
      <td id="T_c8934_row2_col3" class="data row2 col3" >207.21</td>
      <td id="T_c8934_row2_col4" class="data row2 col4" >0.20</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_c8934_row3_col0" class="data row3 col0" >run 2</td>
      <td id="T_c8934_row3_col1" class="data row3 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row3_col2" class="data row3 col2" >207.21</td>
      <td id="T_c8934_row3_col3" class="data row3 col3" >207.30</td>
      <td id="T_c8934_row3_col4" class="data row3 col4" >0.09</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_c8934_row4_col0" class="data row4 col0" >run 3</td>
      <td id="T_c8934_row4_col1" class="data row4 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row4_col2" class="data row4 col2" >207.30</td>
      <td id="T_c8934_row4_col3" class="data row4 col3" >207.33</td>
      <td id="T_c8934_row4_col4" class="data row4 col4" >0.03</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_c8934_row5_col0" class="data row5 col0" >run 4</td>
      <td id="T_c8934_row5_col1" class="data row5 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row5_col2" class="data row5 col2" >207.33</td>
      <td id="T_c8934_row5_col3" class="data row5 col3" >207.36</td>
      <td id="T_c8934_row5_col4" class="data row5 col4" >0.03</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_c8934_row6_col0" class="data row6 col0" >run 5</td>
      <td id="T_c8934_row6_col1" class="data row6 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row6_col2" class="data row6 col2" >207.36</td>
      <td id="T_c8934_row6_col3" class="data row6 col3" >207.39</td>
      <td id="T_c8934_row6_col4" class="data row6 col4" >0.03</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_c8934_row7_col0" class="data row7 col0" >run 6</td>
      <td id="T_c8934_row7_col1" class="data row7 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row7_col2" class="data row7 col2" >207.39</td>
      <td id="T_c8934_row7_col3" class="data row7 col3" >207.41</td>
      <td id="T_c8934_row7_col4" class="data row7 col4" >0.02</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_c8934_row8_col0" class="data row8 col0" >run 7</td>
      <td id="T_c8934_row8_col1" class="data row8 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row8_col2" class="data row8 col2" >207.41</td>
      <td id="T_c8934_row8_col3" class="data row8 col3" >207.49</td>
      <td id="T_c8934_row8_col4" class="data row8 col4" >0.08</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row9" class="row_heading level0 row9" >9</th>
      <td id="T_c8934_row9_col0" class="data row9 col0" >run 8</td>
      <td id="T_c8934_row9_col1" class="data row9 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row9_col2" class="data row9 col2" >207.49</td>
      <td id="T_c8934_row9_col3" class="data row9 col3" >207.53</td>
      <td id="T_c8934_row9_col4" class="data row9 col4" >0.04</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row10" class="row_heading level0 row10" >10</th>
      <td id="T_c8934_row10_col0" class="data row10 col0" >run 9</td>
      <td id="T_c8934_row10_col1" class="data row10 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row10_col2" class="data row10 col2" >207.53</td>
      <td id="T_c8934_row10_col3" class="data row10 col3" >207.56</td>
      <td id="T_c8934_row10_col4" class="data row10 col4" >0.03</td>
    </tr>
    <tr>
      <th id="T_c8934_level0_row11" class="row_heading level0 row11" >11</th>
      <td id="T_c8934_row11_col0" class="data row11 col0" >run 10</td>
      <td id="T_c8934_row11_col1" class="data row11 col1" >def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):</td>
      <td id="T_c8934_row11_col2" class="data row11 col2" >207.56</td>
      <td id="T_c8934_row11_col3" class="data row11 col3" >207.59</td>
      <td id="T_c8934_row11_col4" class="data row11 col4" >0.03</td>
    </tr>
  </tbody>
</table></div>
</div>
<p>Let’s compare these values to the line-by-line profiling results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgls_lp</span> <span class="o">=</span> <span class="n">line_prof_process</span><span class="p">(</span><span class="n">cgls_line_prof</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cgls_lp</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: turquoise&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style type="text/css">
#T_622c9_row0_col3, #T_622c9_row1_col3 {
  background-color: turquoise;
}
</style>
<table id="T_622c9">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_622c9_level0_col0" class="col_heading level0 col0" >Method</th>
      <th id="T_622c9_level0_col1" class="col_heading level0 col1" >Initial Memory Usage (MiB)</th>
      <th id="T_622c9_level0_col2" class="col_heading level0 col2" >Final Memory Usage (MiB)</th>
      <th id="T_622c9_level0_col3" class="col_heading level0 col3" >Total Memory Usage (MiB)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_622c9_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_622c9_row0_col0" class="data row0 col0" >init</td>
      <td id="T_622c9_row0_col1" class="data row0 col1" >0.00</td>
      <td id="T_622c9_row0_col2" class="data row0 col2" >206.93</td>
      <td id="T_622c9_row0_col3" class="data row0 col3" >206.93</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_622c9_row1_col0" class="data row1 col0" >setup</td>
      <td id="T_622c9_row1_col1" class="data row1 col1" >0.00</td>
      <td id="T_622c9_row1_col2" class="data row1 col2" >206.93</td>
      <td id="T_622c9_row1_col3" class="data row1 col3" >206.93</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_622c9_row2_col0" class="data row2 col0" >run 1</td>
      <td id="T_622c9_row2_col1" class="data row2 col1" >206.93</td>
      <td id="T_622c9_row2_col2" class="data row2 col2" >207.19</td>
      <td id="T_622c9_row2_col3" class="data row2 col3" >0.26</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_622c9_row3_col0" class="data row3 col0" >run 2</td>
      <td id="T_622c9_row3_col1" class="data row3 col1" >207.19</td>
      <td id="T_622c9_row3_col2" class="data row3 col2" >207.28</td>
      <td id="T_622c9_row3_col3" class="data row3 col3" >0.09</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_622c9_row4_col0" class="data row4 col0" >run 3</td>
      <td id="T_622c9_row4_col1" class="data row4 col1" >207.28</td>
      <td id="T_622c9_row4_col2" class="data row4 col2" >207.31</td>
      <td id="T_622c9_row4_col3" class="data row4 col3" >0.03</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_622c9_row5_col0" class="data row5 col0" >run 4</td>
      <td id="T_622c9_row5_col1" class="data row5 col1" >207.31</td>
      <td id="T_622c9_row5_col2" class="data row5 col2" >207.34</td>
      <td id="T_622c9_row5_col3" class="data row5 col3" >0.03</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_622c9_row6_col0" class="data row6 col0" >run 5</td>
      <td id="T_622c9_row6_col1" class="data row6 col1" >207.34</td>
      <td id="T_622c9_row6_col2" class="data row6 col2" >207.37</td>
      <td id="T_622c9_row6_col3" class="data row6 col3" >0.03</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_622c9_row7_col0" class="data row7 col0" >run 6</td>
      <td id="T_622c9_row7_col1" class="data row7 col1" >207.37</td>
      <td id="T_622c9_row7_col2" class="data row7 col2" >207.40</td>
      <td id="T_622c9_row7_col3" class="data row7 col3" >0.03</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_622c9_row8_col0" class="data row8 col0" >run 7</td>
      <td id="T_622c9_row8_col1" class="data row8 col1" >207.40</td>
      <td id="T_622c9_row8_col2" class="data row8 col2" >207.43</td>
      <td id="T_622c9_row8_col3" class="data row8 col3" >0.03</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row9" class="row_heading level0 row9" >9</th>
      <td id="T_622c9_row9_col0" class="data row9 col0" >run 8</td>
      <td id="T_622c9_row9_col1" class="data row9 col1" >207.43</td>
      <td id="T_622c9_row9_col2" class="data row9 col2" >207.49</td>
      <td id="T_622c9_row9_col3" class="data row9 col3" >0.06</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row10" class="row_heading level0 row10" >10</th>
      <td id="T_622c9_row10_col0" class="data row10 col0" >run 9</td>
      <td id="T_622c9_row10_col1" class="data row10 col1" >207.49</td>
      <td id="T_622c9_row10_col2" class="data row10 col2" >207.49</td>
      <td id="T_622c9_row10_col3" class="data row10 col3" >0.00</td>
    </tr>
    <tr>
      <th id="T_622c9_level0_row11" class="row_heading level0 row11" >11</th>
      <td id="T_622c9_row11_col0" class="data row11 col0" >run 10</td>
      <td id="T_622c9_row11_col1" class="data row11 col1" >207.49</td>
      <td id="T_622c9_row11_col2" class="data row11 col2" >207.51</td>
      <td id="T_622c9_row11_col3" class="data row11 col3" >0.02</td>
    </tr>
  </tbody>
</table></div>
</div>
<p>As we can see, the major change in memory corresponding to <code class="docutils literal notranslate"><span class="pre">set_up</span></code> and <code class="docutils literal notranslate"><span class="pre">__init__</span></code> are the same, with minor variations in the memory usages of the <code class="docutils literal notranslate"><span class="pre">run</span></code> calls.</p>
</section>
<section id="Peak-Memory-Usages:">
<h3>Peak Memory Usages:<a class="headerlink" href="#Peak-Memory-Usages:" title="Link to this heading">#</a></h3>
<p>We have validated the memory usage tracking using two techniques. For the remainder of the notebook, we will be using output snippets from both to illustrate memory changes.</p>
<p>With the line-by-line profiling technique, we can also take a look at the peak memory usages that were measured on a separate thread, and the corresponding calls:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgls_lp</span> <span class="o">=</span> <span class="n">line_peak_process</span><span class="p">(</span><span class="n">cgls_line_prof</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cgls_lp</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;background-color: pink&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="mi">58</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span>
    <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Peak Memory Increase (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style type="text/css">
#T_8289b_row3_col5, #T_8289b_row5_col5, #T_8289b_row7_col5, #T_8289b_row9_col5, #T_8289b_row11_col5, #T_8289b_row13_col5, #T_8289b_row15_col5, #T_8289b_row17_col5, #T_8289b_row19_col5, #T_8289b_row21_col5 {
  background-color: pink;
}
</style>
<table id="T_8289b">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_8289b_level0_col0" class="col_heading level0 col0" >Method</th>
      <th id="T_8289b_level0_col1" class="col_heading level0 col1" >Initial Memory Usage (MiB)</th>
      <th id="T_8289b_level0_col2" class="col_heading level0 col2" >Peak Memory</th>
      <th id="T_8289b_level0_col3" class="col_heading level0 col3" >Final Memory Usage (MiB)</th>
      <th id="T_8289b_level0_col4" class="col_heading level0 col4" >Total Memory Usage (MiB)</th>
      <th id="T_8289b_level0_col5" class="col_heading level0 col5" >Peak Memory Increase (MiB)</th>
      <th id="T_8289b_level0_col6" class="col_heading level0 col6" >Peak Line</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_8289b_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_8289b_row0_col0" class="data row0 col0" >init</td>
      <td id="T_8289b_row0_col1" class="data row0 col1" >0.00</td>
      <td id="T_8289b_row0_col2" class="data row0 col2" >206.93</td>
      <td id="T_8289b_row0_col3" class="data row0 col3" >206.93</td>
      <td id="T_8289b_row0_col4" class="data row0 col4" >206.93</td>
      <td id="T_8289b_row0_col5" class="data row0 col5" >206.93</td>
      <td id="T_8289b_row0_col6" class="data row0 col6" >self.set_up(initial=initial, operator=operator, data=data)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_8289b_row1_col0" class="data row1 col0" >setup</td>
      <td id="T_8289b_row1_col1" class="data row1 col1" >0.00</td>
      <td id="T_8289b_row1_col2" class="data row1 col2" >206.93</td>
      <td id="T_8289b_row1_col3" class="data row1 col3" >206.93</td>
      <td id="T_8289b_row1_col4" class="data row1 col4" >206.93</td>
      <td id="T_8289b_row1_col5" class="data row1 col5" >206.93</td>
      <td id="T_8289b_row1_col6" class="data row1 col6" >self.norms0 = self.s.norm()</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_8289b_row2_col0" class="data row2 col0" >run 1</td>
      <td id="T_8289b_row2_col1" class="data row2 col1" >206.93</td>
      <td id="T_8289b_row2_col2" class="data row2 col2" >261.08</td>
      <td id="T_8289b_row2_col3" class="data row2 col3" >207.19</td>
      <td id="T_8289b_row2_col4" class="data row2 col4" >0.26</td>
      <td id="T_8289b_row2_col5" class="data row2 col5" >54.15</td>
      <td id="T_8289b_row2_col6" class="data row2 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_8289b_row3_col0" class="data row3 col0" >update 1</td>
      <td id="T_8289b_row3_col1" class="data row3 col1" >207.13</td>
      <td id="T_8289b_row3_col2" class="data row3 col2" >261.08</td>
      <td id="T_8289b_row3_col3" class="data row3 col3" >207.19</td>
      <td id="T_8289b_row3_col4" class="data row3 col4" >0.06</td>
      <td id="T_8289b_row3_col5" class="data row3 col5" >53.95</td>
      <td id="T_8289b_row3_col6" class="data row3 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_8289b_row4_col0" class="data row4 col0" >run 2</td>
      <td id="T_8289b_row4_col1" class="data row4 col1" >207.19</td>
      <td id="T_8289b_row4_col2" class="data row4 col2" >261.24</td>
      <td id="T_8289b_row4_col3" class="data row4 col3" >207.28</td>
      <td id="T_8289b_row4_col4" class="data row4 col4" >0.09</td>
      <td id="T_8289b_row4_col5" class="data row4 col5" >54.05</td>
      <td id="T_8289b_row4_col6" class="data row4 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_8289b_row5_col0" class="data row5 col0" >update 2</td>
      <td id="T_8289b_row5_col1" class="data row5 col1" >207.19</td>
      <td id="T_8289b_row5_col2" class="data row5 col2" >261.24</td>
      <td id="T_8289b_row5_col3" class="data row5 col3" >207.28</td>
      <td id="T_8289b_row5_col4" class="data row5 col4" >0.09</td>
      <td id="T_8289b_row5_col5" class="data row5 col5" >54.05</td>
      <td id="T_8289b_row5_col6" class="data row5 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_8289b_row6_col0" class="data row6 col0" >run 3</td>
      <td id="T_8289b_row6_col1" class="data row6 col1" >207.28</td>
      <td id="T_8289b_row6_col2" class="data row6 col2" >261.27</td>
      <td id="T_8289b_row6_col3" class="data row6 col3" >207.31</td>
      <td id="T_8289b_row6_col4" class="data row6 col4" >0.03</td>
      <td id="T_8289b_row6_col5" class="data row6 col5" >53.99</td>
      <td id="T_8289b_row6_col6" class="data row6 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_8289b_row7_col0" class="data row7 col0" >update 3</td>
      <td id="T_8289b_row7_col1" class="data row7 col1" >207.28</td>
      <td id="T_8289b_row7_col2" class="data row7 col2" >261.27</td>
      <td id="T_8289b_row7_col3" class="data row7 col3" >207.31</td>
      <td id="T_8289b_row7_col4" class="data row7 col4" >0.03</td>
      <td id="T_8289b_row7_col5" class="data row7 col5" >53.99</td>
      <td id="T_8289b_row7_col6" class="data row7 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_8289b_row8_col0" class="data row8 col0" >run 4</td>
      <td id="T_8289b_row8_col1" class="data row8 col1" >207.31</td>
      <td id="T_8289b_row8_col2" class="data row8 col2" >261.30</td>
      <td id="T_8289b_row8_col3" class="data row8 col3" >207.34</td>
      <td id="T_8289b_row8_col4" class="data row8 col4" >0.03</td>
      <td id="T_8289b_row8_col5" class="data row8 col5" >53.99</td>
      <td id="T_8289b_row8_col6" class="data row8 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row9" class="row_heading level0 row9" >9</th>
      <td id="T_8289b_row9_col0" class="data row9 col0" >update 4</td>
      <td id="T_8289b_row9_col1" class="data row9 col1" >207.31</td>
      <td id="T_8289b_row9_col2" class="data row9 col2" >261.30</td>
      <td id="T_8289b_row9_col3" class="data row9 col3" >207.34</td>
      <td id="T_8289b_row9_col4" class="data row9 col4" >0.03</td>
      <td id="T_8289b_row9_col5" class="data row9 col5" >53.99</td>
      <td id="T_8289b_row9_col6" class="data row9 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row10" class="row_heading level0 row10" >10</th>
      <td id="T_8289b_row10_col0" class="data row10 col0" >run 5</td>
      <td id="T_8289b_row10_col1" class="data row10 col1" >207.34</td>
      <td id="T_8289b_row10_col2" class="data row10 col2" >261.33</td>
      <td id="T_8289b_row10_col3" class="data row10 col3" >207.37</td>
      <td id="T_8289b_row10_col4" class="data row10 col4" >0.03</td>
      <td id="T_8289b_row10_col5" class="data row10 col5" >53.99</td>
      <td id="T_8289b_row10_col6" class="data row10 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row11" class="row_heading level0 row11" >11</th>
      <td id="T_8289b_row11_col0" class="data row11 col0" >update 5</td>
      <td id="T_8289b_row11_col1" class="data row11 col1" >207.34</td>
      <td id="T_8289b_row11_col2" class="data row11 col2" >261.33</td>
      <td id="T_8289b_row11_col3" class="data row11 col3" >207.37</td>
      <td id="T_8289b_row11_col4" class="data row11 col4" >0.03</td>
      <td id="T_8289b_row11_col5" class="data row11 col5" >53.99</td>
      <td id="T_8289b_row11_col6" class="data row11 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row12" class="row_heading level0 row12" >12</th>
      <td id="T_8289b_row12_col0" class="data row12 col0" >run 6</td>
      <td id="T_8289b_row12_col1" class="data row12 col1" >207.37</td>
      <td id="T_8289b_row12_col2" class="data row12 col2" >261.36</td>
      <td id="T_8289b_row12_col3" class="data row12 col3" >207.40</td>
      <td id="T_8289b_row12_col4" class="data row12 col4" >0.03</td>
      <td id="T_8289b_row12_col5" class="data row12 col5" >53.99</td>
      <td id="T_8289b_row12_col6" class="data row12 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row13" class="row_heading level0 row13" >13</th>
      <td id="T_8289b_row13_col0" class="data row13 col0" >update 6</td>
      <td id="T_8289b_row13_col1" class="data row13 col1" >207.37</td>
      <td id="T_8289b_row13_col2" class="data row13 col2" >261.36</td>
      <td id="T_8289b_row13_col3" class="data row13 col3" >207.40</td>
      <td id="T_8289b_row13_col4" class="data row13 col4" >0.03</td>
      <td id="T_8289b_row13_col5" class="data row13 col5" >53.99</td>
      <td id="T_8289b_row13_col6" class="data row13 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row14" class="row_heading level0 row14" >14</th>
      <td id="T_8289b_row14_col0" class="data row14 col0" >run 7</td>
      <td id="T_8289b_row14_col1" class="data row14 col1" >207.40</td>
      <td id="T_8289b_row14_col2" class="data row14 col2" >261.38</td>
      <td id="T_8289b_row14_col3" class="data row14 col3" >207.43</td>
      <td id="T_8289b_row14_col4" class="data row14 col4" >0.03</td>
      <td id="T_8289b_row14_col5" class="data row14 col5" >53.98</td>
      <td id="T_8289b_row14_col6" class="data row14 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row15" class="row_heading level0 row15" >15</th>
      <td id="T_8289b_row15_col0" class="data row15 col0" >update 7</td>
      <td id="T_8289b_row15_col1" class="data row15 col1" >207.40</td>
      <td id="T_8289b_row15_col2" class="data row15 col2" >261.38</td>
      <td id="T_8289b_row15_col3" class="data row15 col3" >207.43</td>
      <td id="T_8289b_row15_col4" class="data row15 col4" >0.03</td>
      <td id="T_8289b_row15_col5" class="data row15 col5" >53.98</td>
      <td id="T_8289b_row15_col6" class="data row15 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row16" class="row_heading level0 row16" >16</th>
      <td id="T_8289b_row16_col0" class="data row16 col0" >run 8</td>
      <td id="T_8289b_row16_col1" class="data row16 col1" >207.43</td>
      <td id="T_8289b_row16_col2" class="data row16 col2" >261.41</td>
      <td id="T_8289b_row16_col3" class="data row16 col3" >207.49</td>
      <td id="T_8289b_row16_col4" class="data row16 col4" >0.06</td>
      <td id="T_8289b_row16_col5" class="data row16 col5" >53.98</td>
      <td id="T_8289b_row16_col6" class="data row16 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row17" class="row_heading level0 row17" >17</th>
      <td id="T_8289b_row17_col0" class="data row17 col0" >update 8</td>
      <td id="T_8289b_row17_col1" class="data row17 col1" >207.43</td>
      <td id="T_8289b_row17_col2" class="data row17 col2" >261.41</td>
      <td id="T_8289b_row17_col3" class="data row17 col3" >207.49</td>
      <td id="T_8289b_row17_col4" class="data row17 col4" >0.06</td>
      <td id="T_8289b_row17_col5" class="data row17 col5" >53.98</td>
      <td id="T_8289b_row17_col6" class="data row17 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row18" class="row_heading level0 row18" >18</th>
      <td id="T_8289b_row18_col0" class="data row18 col0" >run 9</td>
      <td id="T_8289b_row18_col1" class="data row18 col1" >207.49</td>
      <td id="T_8289b_row18_col2" class="data row18 col2" >261.44</td>
      <td id="T_8289b_row18_col3" class="data row18 col3" >207.49</td>
      <td id="T_8289b_row18_col4" class="data row18 col4" >0.00</td>
      <td id="T_8289b_row18_col5" class="data row18 col5" >53.95</td>
      <td id="T_8289b_row18_col6" class="data row18 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row19" class="row_heading level0 row19" >19</th>
      <td id="T_8289b_row19_col0" class="data row19 col0" >update 9</td>
      <td id="T_8289b_row19_col1" class="data row19 col1" >207.49</td>
      <td id="T_8289b_row19_col2" class="data row19 col2" >261.44</td>
      <td id="T_8289b_row19_col3" class="data row19 col3" >207.49</td>
      <td id="T_8289b_row19_col4" class="data row19 col4" >0.00</td>
      <td id="T_8289b_row19_col5" class="data row19 col5" >53.95</td>
      <td id="T_8289b_row19_col6" class="data row19 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row20" class="row_heading level0 row20" >20</th>
      <td id="T_8289b_row20_col0" class="data row20 col0" >run 10</td>
      <td id="T_8289b_row20_col1" class="data row20 col1" >207.49</td>
      <td id="T_8289b_row20_col2" class="data row20 col2" >261.47</td>
      <td id="T_8289b_row20_col3" class="data row20 col3" >207.51</td>
      <td id="T_8289b_row20_col4" class="data row20 col4" >0.02</td>
      <td id="T_8289b_row20_col5" class="data row20 col5" >53.98</td>
      <td id="T_8289b_row20_col6" class="data row20 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_8289b_level0_row21" class="row_heading level0 row21" >21</th>
      <td id="T_8289b_row21_col0" class="data row21 col0" >update 10</td>
      <td id="T_8289b_row21_col1" class="data row21 col1" >207.49</td>
      <td id="T_8289b_row21_col2" class="data row21 col2" >261.47</td>
      <td id="T_8289b_row21_col3" class="data row21 col3" >207.51</td>
      <td id="T_8289b_row21_col4" class="data row21 col4" >0.02</td>
      <td id="T_8289b_row21_col5" class="data row21 col5" >53.98</td>
      <td id="T_8289b_row21_col6" class="data row21 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
  </tbody>
</table></div>
</div>
<p>This table shows that CGLS’ <code class="docutils literal notranslate"><span class="pre">set_up</span></code> and <code class="docutils literal notranslate"><span class="pre">__init__</span></code> calls do not have a spike in memory that exceeds the final usage. However, during the runs, the <code class="docutils literal notranslate"><span class="pre">update(self)</span></code> call produces peak increases around the size of the ImageData space. This memory usage is transient, and is released by the time the call is finished.</p>
<p>Looking at the <strong>Method</strong>=<code class="docutils literal notranslate"><span class="pre">update</span></code> Peak lines (Highlighted in pink), we can see the biggest peak is attributed to the line <code class="docutils literal notranslate"><span class="pre">self.operator.direct(self.p,</span> <span class="pre">out=self.q)</span></code>, which creates a copy of the ImageData space during its execution, and releases the memory after it has run.</p>
<p>Below, we visualise this by plotting the total memory increases and the peak memory increases as sequential line graphs:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_mem</span><span class="p">((</span><span class="n">cgls_lp</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;CGLS&quot;</span><span class="p">,))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_52_0.png" src="../../_images/demos_memory_profiling_sandstone_52_0.png" />
</div>
</div>
<p style="font-size:14px; color:#086bb8;"><p>Figure 3: This graph shows the memory usages before (initial), during (peak) and after (final) the ‘init’ and ‘run’ methods in CGLS. The first two points show the ~205 MB memory increase during ‘init’, which remains stable. The spikes during each subsequent run show that the memory usage reaches a peak, and then drops back down, resulting in a net increase of ~0 MB. This is consistent across all ‘run’ calls (iterations).</p>
</p></section>
<section id="Comparison-With-LSQR:">
<h3>Comparison With LSQR:<a class="headerlink" href="#Comparison-With-LSQR:" title="Link to this heading">#</a></h3>
<p>Let’s compare this to LSQR’s memory usage:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> lsqr_line_prof
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">lsqr_lp</span> <span class="o">--</span><span class="n">track</span><span class="o">-</span><span class="n">peak</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lsqr_lp</span> <span class="o">=</span> <span class="n">line_peak_process</span><span class="p">(</span><span class="n">lsqr_line_prof</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lsqr_lp</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;background-color: pink&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="mi">58</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span>
    <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Peak Memory Increase (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: turquoise&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: orange&#39;</span> <span class="k">if</span> <span class="mi">58</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style type="text/css">
#T_e5824_row0_col4, #T_e5824_row1_col4 {
  background-color: turquoise;
}
#T_e5824_row2_col4, #T_e5824_row3_col4 {
  background-color: orange;
}
#T_e5824_row3_col5, #T_e5824_row5_col5, #T_e5824_row7_col5, #T_e5824_row9_col5, #T_e5824_row11_col5, #T_e5824_row13_col5, #T_e5824_row15_col5, #T_e5824_row17_col5, #T_e5824_row19_col5, #T_e5824_row21_col5 {
  background-color: pink;
}
</style>
<table id="T_e5824">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_e5824_level0_col0" class="col_heading level0 col0" >Method</th>
      <th id="T_e5824_level0_col1" class="col_heading level0 col1" >Initial Memory Usage (MiB)</th>
      <th id="T_e5824_level0_col2" class="col_heading level0 col2" >Peak Memory</th>
      <th id="T_e5824_level0_col3" class="col_heading level0 col3" >Final Memory Usage (MiB)</th>
      <th id="T_e5824_level0_col4" class="col_heading level0 col4" >Total Memory Usage (MiB)</th>
      <th id="T_e5824_level0_col5" class="col_heading level0 col5" >Peak Memory Increase (MiB)</th>
      <th id="T_e5824_level0_col6" class="col_heading level0 col6" >Peak Line</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_e5824_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_e5824_row0_col0" class="data row0 col0" >init</td>
      <td id="T_e5824_row0_col1" class="data row0 col1" >0.00</td>
      <td id="T_e5824_row0_col2" class="data row0 col2" >207.02</td>
      <td id="T_e5824_row0_col3" class="data row0 col3" >207.02</td>
      <td id="T_e5824_row0_col4" class="data row0 col4" >207.02</td>
      <td id="T_e5824_row0_col5" class="data row0 col5" >207.02</td>
      <td id="T_e5824_row0_col6" class="data row0 col6" >self.set_up(initial=initial, operator=operator, data=data)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_e5824_row1_col0" class="data row1 col0" >setup</td>
      <td id="T_e5824_row1_col1" class="data row1 col1" >0.00</td>
      <td id="T_e5824_row1_col2" class="data row1 col2" >207.02</td>
      <td id="T_e5824_row1_col3" class="data row1 col3" >207.02</td>
      <td id="T_e5824_row1_col4" class="data row1 col4" >207.02</td>
      <td id="T_e5824_row1_col5" class="data row1 col5" >207.02</td>
      <td id="T_e5824_row1_col6" class="data row1 col6" >self.tmp_range = data.geometry.allocate(None)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_e5824_row2_col0" class="data row2 col0" >run 1</td>
      <td id="T_e5824_row2_col1" class="data row2 col1" >207.02</td>
      <td id="T_e5824_row2_col2" class="data row2 col2" >261.20</td>
      <td id="T_e5824_row2_col3" class="data row2 col3" >261.17</td>
      <td id="T_e5824_row2_col4" class="data row2 col4" >54.15</td>
      <td id="T_e5824_row2_col5" class="data row2 col5" >54.18</td>
      <td id="T_e5824_row2_col6" class="data row2 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_e5824_row3_col0" class="data row3 col0" >update 1</td>
      <td id="T_e5824_row3_col1" class="data row3 col1" >207.25</td>
      <td id="T_e5824_row3_col2" class="data row3 col2" >261.20</td>
      <td id="T_e5824_row3_col3" class="data row3 col3" >261.17</td>
      <td id="T_e5824_row3_col4" class="data row3 col4" >53.92</td>
      <td id="T_e5824_row3_col5" class="data row3 col5" >53.95</td>
      <td id="T_e5824_row3_col6" class="data row3 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_e5824_row4_col0" class="data row4 col0" >run 2</td>
      <td id="T_e5824_row4_col1" class="data row4 col1" >261.17</td>
      <td id="T_e5824_row4_col2" class="data row4 col2" >315.19</td>
      <td id="T_e5824_row4_col3" class="data row4 col3" >261.22</td>
      <td id="T_e5824_row4_col4" class="data row4 col4" >0.05</td>
      <td id="T_e5824_row4_col5" class="data row4 col5" >54.02</td>
      <td id="T_e5824_row4_col6" class="data row4 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_e5824_row5_col0" class="data row5 col0" >update 2</td>
      <td id="T_e5824_row5_col1" class="data row5 col1" >261.17</td>
      <td id="T_e5824_row5_col2" class="data row5 col2" >315.19</td>
      <td id="T_e5824_row5_col3" class="data row5 col3" >261.22</td>
      <td id="T_e5824_row5_col4" class="data row5 col4" >0.05</td>
      <td id="T_e5824_row5_col5" class="data row5 col5" >54.02</td>
      <td id="T_e5824_row5_col6" class="data row5 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_e5824_row6_col0" class="data row6 col0" >run 3</td>
      <td id="T_e5824_row6_col1" class="data row6 col1" >261.22</td>
      <td id="T_e5824_row6_col2" class="data row6 col2" >315.22</td>
      <td id="T_e5824_row6_col3" class="data row6 col3" >261.25</td>
      <td id="T_e5824_row6_col4" class="data row6 col4" >0.03</td>
      <td id="T_e5824_row6_col5" class="data row6 col5" >54.00</td>
      <td id="T_e5824_row6_col6" class="data row6 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_e5824_row7_col0" class="data row7 col0" >update 3</td>
      <td id="T_e5824_row7_col1" class="data row7 col1" >261.22</td>
      <td id="T_e5824_row7_col2" class="data row7 col2" >315.22</td>
      <td id="T_e5824_row7_col3" class="data row7 col3" >261.25</td>
      <td id="T_e5824_row7_col4" class="data row7 col4" >0.03</td>
      <td id="T_e5824_row7_col5" class="data row7 col5" >54.00</td>
      <td id="T_e5824_row7_col6" class="data row7 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_e5824_row8_col0" class="data row8 col0" >run 4</td>
      <td id="T_e5824_row8_col1" class="data row8 col1" >261.25</td>
      <td id="T_e5824_row8_col2" class="data row8 col2" >315.25</td>
      <td id="T_e5824_row8_col3" class="data row8 col3" >261.37</td>
      <td id="T_e5824_row8_col4" class="data row8 col4" >0.12</td>
      <td id="T_e5824_row8_col5" class="data row8 col5" >54.00</td>
      <td id="T_e5824_row8_col6" class="data row8 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row9" class="row_heading level0 row9" >9</th>
      <td id="T_e5824_row9_col0" class="data row9 col0" >update 4</td>
      <td id="T_e5824_row9_col1" class="data row9 col1" >261.25</td>
      <td id="T_e5824_row9_col2" class="data row9 col2" >315.25</td>
      <td id="T_e5824_row9_col3" class="data row9 col3" >261.37</td>
      <td id="T_e5824_row9_col4" class="data row9 col4" >0.12</td>
      <td id="T_e5824_row9_col5" class="data row9 col5" >54.00</td>
      <td id="T_e5824_row9_col6" class="data row9 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row10" class="row_heading level0 row10" >10</th>
      <td id="T_e5824_row10_col0" class="data row10 col0" >run 5</td>
      <td id="T_e5824_row10_col1" class="data row10 col1" >261.37</td>
      <td id="T_e5824_row10_col2" class="data row10 col2" >315.31</td>
      <td id="T_e5824_row10_col3" class="data row10 col3" >261.36</td>
      <td id="T_e5824_row10_col4" class="data row10 col4" >-0.01</td>
      <td id="T_e5824_row10_col5" class="data row10 col5" >53.94</td>
      <td id="T_e5824_row10_col6" class="data row10 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row11" class="row_heading level0 row11" >11</th>
      <td id="T_e5824_row11_col0" class="data row11 col0" >update 5</td>
      <td id="T_e5824_row11_col1" class="data row11 col1" >261.37</td>
      <td id="T_e5824_row11_col2" class="data row11 col2" >315.31</td>
      <td id="T_e5824_row11_col3" class="data row11 col3" >261.36</td>
      <td id="T_e5824_row11_col4" class="data row11 col4" >-0.01</td>
      <td id="T_e5824_row11_col5" class="data row11 col5" >53.94</td>
      <td id="T_e5824_row11_col6" class="data row11 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row12" class="row_heading level0 row12" >12</th>
      <td id="T_e5824_row12_col0" class="data row12 col0" >run 6</td>
      <td id="T_e5824_row12_col1" class="data row12 col1" >261.36</td>
      <td id="T_e5824_row12_col2" class="data row12 col2" >315.35</td>
      <td id="T_e5824_row12_col3" class="data row12 col3" >261.42</td>
      <td id="T_e5824_row12_col4" class="data row12 col4" >0.06</td>
      <td id="T_e5824_row12_col5" class="data row12 col5" >53.99</td>
      <td id="T_e5824_row12_col6" class="data row12 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row13" class="row_heading level0 row13" >13</th>
      <td id="T_e5824_row13_col0" class="data row13 col0" >update 6</td>
      <td id="T_e5824_row13_col1" class="data row13 col1" >261.36</td>
      <td id="T_e5824_row13_col2" class="data row13 col2" >315.35</td>
      <td id="T_e5824_row13_col3" class="data row13 col3" >261.42</td>
      <td id="T_e5824_row13_col4" class="data row13 col4" >0.06</td>
      <td id="T_e5824_row13_col5" class="data row13 col5" >53.99</td>
      <td id="T_e5824_row13_col6" class="data row13 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row14" class="row_heading level0 row14" >14</th>
      <td id="T_e5824_row14_col0" class="data row14 col0" >run 7</td>
      <td id="T_e5824_row14_col1" class="data row14 col1" >261.42</td>
      <td id="T_e5824_row14_col2" class="data row14 col2" >315.38</td>
      <td id="T_e5824_row14_col3" class="data row14 col3" >261.47</td>
      <td id="T_e5824_row14_col4" class="data row14 col4" >0.05</td>
      <td id="T_e5824_row14_col5" class="data row14 col5" >53.96</td>
      <td id="T_e5824_row14_col6" class="data row14 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row15" class="row_heading level0 row15" >15</th>
      <td id="T_e5824_row15_col0" class="data row15 col0" >update 7</td>
      <td id="T_e5824_row15_col1" class="data row15 col1" >261.42</td>
      <td id="T_e5824_row15_col2" class="data row15 col2" >315.38</td>
      <td id="T_e5824_row15_col3" class="data row15 col3" >261.47</td>
      <td id="T_e5824_row15_col4" class="data row15 col4" >0.05</td>
      <td id="T_e5824_row15_col5" class="data row15 col5" >53.96</td>
      <td id="T_e5824_row15_col6" class="data row15 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row16" class="row_heading level0 row16" >16</th>
      <td id="T_e5824_row16_col0" class="data row16 col0" >run 8</td>
      <td id="T_e5824_row16_col1" class="data row16 col1" >261.47</td>
      <td id="T_e5824_row16_col2" class="data row16 col2" >315.42</td>
      <td id="T_e5824_row16_col3" class="data row16 col3" >261.53</td>
      <td id="T_e5824_row16_col4" class="data row16 col4" >0.06</td>
      <td id="T_e5824_row16_col5" class="data row16 col5" >53.95</td>
      <td id="T_e5824_row16_col6" class="data row16 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row17" class="row_heading level0 row17" >17</th>
      <td id="T_e5824_row17_col0" class="data row17 col0" >update 8</td>
      <td id="T_e5824_row17_col1" class="data row17 col1" >261.47</td>
      <td id="T_e5824_row17_col2" class="data row17 col2" >315.42</td>
      <td id="T_e5824_row17_col3" class="data row17 col3" >261.52</td>
      <td id="T_e5824_row17_col4" class="data row17 col4" >0.05</td>
      <td id="T_e5824_row17_col5" class="data row17 col5" >53.95</td>
      <td id="T_e5824_row17_col6" class="data row17 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row18" class="row_heading level0 row18" >18</th>
      <td id="T_e5824_row18_col0" class="data row18 col0" >run 9</td>
      <td id="T_e5824_row18_col1" class="data row18 col1" >261.53</td>
      <td id="T_e5824_row18_col2" class="data row18 col2" >315.47</td>
      <td id="T_e5824_row18_col3" class="data row18 col3" >261.54</td>
      <td id="T_e5824_row18_col4" class="data row18 col4" >0.01</td>
      <td id="T_e5824_row18_col5" class="data row18 col5" >53.94</td>
      <td id="T_e5824_row18_col6" class="data row18 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row19" class="row_heading level0 row19" >19</th>
      <td id="T_e5824_row19_col0" class="data row19 col0" >update 9</td>
      <td id="T_e5824_row19_col1" class="data row19 col1" >261.53</td>
      <td id="T_e5824_row19_col2" class="data row19 col2" >315.47</td>
      <td id="T_e5824_row19_col3" class="data row19 col3" >261.54</td>
      <td id="T_e5824_row19_col4" class="data row19 col4" >0.01</td>
      <td id="T_e5824_row19_col5" class="data row19 col5" >53.94</td>
      <td id="T_e5824_row19_col6" class="data row19 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row20" class="row_heading level0 row20" >20</th>
      <td id="T_e5824_row20_col0" class="data row20 col0" >run 10</td>
      <td id="T_e5824_row20_col1" class="data row20 col1" >261.54</td>
      <td id="T_e5824_row20_col2" class="data row20 col2" >315.50</td>
      <td id="T_e5824_row20_col3" class="data row20 col3" >261.54</td>
      <td id="T_e5824_row20_col4" class="data row20 col4" >0.00</td>
      <td id="T_e5824_row20_col5" class="data row20 col5" >53.96</td>
      <td id="T_e5824_row20_col6" class="data row20 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_e5824_level0_row21" class="row_heading level0 row21" >21</th>
      <td id="T_e5824_row21_col0" class="data row21 col0" >update 10</td>
      <td id="T_e5824_row21_col1" class="data row21 col1" >261.54</td>
      <td id="T_e5824_row21_col2" class="data row21 col2" >315.50</td>
      <td id="T_e5824_row21_col3" class="data row21 col3" >261.54</td>
      <td id="T_e5824_row21_col4" class="data row21 col4" >0.00</td>
      <td id="T_e5824_row21_col5" class="data row21 col5" >53.96</td>
      <td id="T_e5824_row21_col6" class="data row21 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
  </tbody>
</table></div>
</div>
<div class="line-block">
<div class="line">The table and plots show that LSQR has a <strong>the same setup cost as CGLS</strong> (Highlighted in turquoise).</div>
<div class="line">We also see the same Peak Increase in LSQR’s <code class="docutils literal notranslate"><span class="pre">run</span></code> calls, again due to the ImageData copy made during <code class="docutils literal notranslate"><span class="pre">update</span></code>’s <code class="docutils literal notranslate"><span class="pre">self.operator.direct(self.v,</span> <span class="pre">out=self.tmp_range)</span></code> call (Highlighted in pink), which is deallocated after this line is complete.</div>
</div>
<p>Notably, there is a ~<strong>54 MB increase</strong> in total memory usage in the first <code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">update</span></code> calls (Highlighted in orange). This is because in <code class="docutils literal notranslate"><span class="pre">set_up</span></code>, <code class="docutils literal notranslate"><span class="pre">self.tmp_domain</span></code> is initialised with <code class="docutils literal notranslate"><span class="pre">None</span></code>, which does not allocate memory. But when calling the first <code class="docutils literal notranslate"><span class="pre">update</span></code>, the line <code class="docutils literal notranslate"><span class="pre">self.operator.adjoint(self.u,</span> <span class="pre">out=self.tmp_domain)</span></code> replaces the <code class="docutils literal notranslate"><span class="pre">None</span></code>s with values, which results in memory allocation.</p>
<p>In total with the initialisation cost, LSQR makes:</p>
<ul class="simple">
<li><p>4 increases of <strong>~53.9 MB</strong> - corresponding to the size of the <strong>ImageData</strong> space</p></li>
<li><p>2 increases of <strong>~21.5 MB</strong> - corresponding to the <strong>AcquisitionData</strong> space</p></li>
</ul>
<p>The raw line-by-line output below shows the <code class="docutils literal notranslate"><span class="pre">self.operator.direct</span></code> peak and subsequent deallocation, and the <code class="docutils literal notranslate"><span class="pre">self.operator.adjoint</span></code> increase:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment to view line-by-line &amp; peak usage output:</span>
<span class="n">print_output_subset</span><span class="p">(</span><span class="n">lsqr_line_prof</span><span class="p">,</span> <span class="s1">&#39;run 1&#39;</span><span class="p">)</span> <span class="c1"># Truncated to show run 1 &amp; update 1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
run 1
Start of run | Memory Usage: 887.12 MB | line:

16 | Memory Usage: 887.12 MB | line: callbacks = [ProgressCallback(verbose=verbose)]

17 | Memory Usage: 887.12 MB | line: callback = kwargs.get(&#39;callback&#39;, None)

18 | Memory Usage: 887.12 MB | line: callbacks.append(_OldCallback(callback, verbose=verbose))

19 | Memory Usage: 887.12 MB | line: iterations = self.max_iteration

20 | Memory Usage: 887.12 MB | line: iterations+=1

21 | Memory Usage: 887.12 MB | line: self.max_iteration = self.iteration + iterations

22 | Memory Usage: 887.23 MB | line: iters = (count(self.iteration) if numpy.isposinf(self.max_iteration) else range(self.iteration, self.max_iteration))

23 | Memory Usage: 887.23 MB | line: update(self)

24 | Memory Usage: 887.35 MB | line: callback(self)

Start of update | Memory Usage: 887.35 MB | line:

Memory Usage Log (Time, Memory in MB): 15:55:14.623491, 941.25 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.633770, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.643983, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.654148, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.664296, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.674446, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.684598, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.694766, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.704964, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.715156, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.725320, 941.30 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.735482, 941.30 MB

25 | Memory Usage: 887.37 MB | line: self.operator.direct(self.v, out=self.tmp_range)

Memory Usage Log (Time, Memory in MB): 15:55:14.747662, 887.37 MB

26 | Memory Usage: 887.36 MB | line: self.tmp_range.sapyb(1.,  self.u,-self.alpha, out=self.u)

27 | Memory Usage: 887.36 MB | line: self.beta = self.u.norm()

28 | Memory Usage: 887.36 MB | line: self.u /= self.beta
Memory Usage Log (Time, Memory in MB): 15:55:14.758079, 887.36 MB


Memory Usage Log (Time, Memory in MB): 15:55:14.783936, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.794185, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.804395, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.814572, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.824746, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.834923, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.845119, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.855290, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.865475, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.875650, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.885855, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.896072, 887.36 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.906363, 899.14 MB

Memory Usage Log (Time, Memory in MB): 15:55:14.916694, 923.14 MB

29 | Memory Usage: 941.29 MB | line: self.operator.adjoint(self.u, out=self.tmp_domain)

Memory Usage Log (Time, Memory in MB): 15:55:14.928414, 941.29 MB

30 | Memory Usage: 941.29 MB | line: self.v.sapyb(-self.beta, self.tmp_domain, 1., out=self.v)

Memory Usage Log (Time, Memory in MB): 15:55:14.938845, 941.29 MB

31 | Memory Usage: 941.29 MB | line: self.alpha = self.v.norm()

Memory Usage Log (Time, Memory in MB): 15:55:14.949036, 941.29 MB

32 | Memory Usage: 941.29 MB | line: self.v /= self.alpha

33 | Memory Usage: 941.29 MB | line: rhobar1 = self.rhobar, psi = 0

34 | Memory Usage: 941.29 MB | line: self.phibar = s * self.phibar

Memory Usage Log (Time, Memory in MB): 15:55:14.959302, 941.28 MB

35 | Memory Usage: 941.28 MB | line: self.x.sapyb(1, self.d, phi/rho, out=self.x)

Memory Usage Log (Time, Memory in MB): 15:55:14.969583, 941.27 MB

36 | Memory Usage: 941.27 MB | line: self.d.sapyb(-theta/rho, self.v, 1, out=self.d)

End of update | Memory Usage: 941.27 MB | line: self.normr = math.sqrt(self.phibar ** 2 + self.res2)

23 | Memory Usage: 941.27 MB | line: update(self)

24 | Memory Usage: 941.27 MB | line: callback(self)

End of run | Memory Usage: 941.27 MB | line:
</pre></div></div>
</div>
<p>In contrast to the second <code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">update</span></code> calls, we still see a <code class="docutils literal notranslate"><span class="pre">self.operator.direct</span></code> peak, but no overall usage change from <code class="docutils literal notranslate"><span class="pre">self.operator.adjoint</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_output_subset</span><span class="p">(</span><span class="n">lsqr_line_prof</span><span class="p">,</span> <span class="s1">&#39;run 2&#39;</span><span class="p">)</span> <span class="c1"># Truncated to show run 2 &amp; update 2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
run 2
Start of run | Memory Usage: 941.27 MB | line:

16 | Memory Usage: 941.27 MB | line: callbacks = [ProgressCallback(verbose=verbose)]

17 | Memory Usage: 941.27 MB | line: callback = kwargs.get(&#39;callback&#39;, None)

18 | Memory Usage: 941.27 MB | line: callbacks.append(_OldCallback(callback, verbose=verbose))

19 | Memory Usage: 941.27 MB | line: iterations = self.max_iteration

20 | Memory Usage: 941.27 MB | line: iterations+=1

21 | Memory Usage: 941.27 MB | line: self.max_iteration = self.iteration + iterations

22 | Memory Usage: 941.27 MB | line: iters = (count(self.iteration) if numpy.isposinf(self.max_iteration) else range(self.iteration, self.max_iteration))

Start of update | Memory Usage: 941.27 MB | line:

Memory Usage Log (Time, Memory in MB): 15:55:15.033527, 995.12 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.043790, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.053982, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.064149, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.074310, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.084502, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.094703, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.104903, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.115103, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.125278, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.135451, 995.29 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.145736, 995.29 MB

25 | Memory Usage: 941.35 MB | line: self.operator.direct(self.v, out=self.tmp_range)

Memory Usage Log (Time, Memory in MB): 15:55:15.155986, 941.35 MB

26 | Memory Usage: 941.34 MB | line: self.tmp_range.sapyb(1.,  self.u,-self.alpha, out=self.u)

27 | Memory Usage: 941.34 MB | line: self.beta = self.u.norm()

28 | Memory Usage: 941.34 MB | line: self.u /= self.beta

Memory Usage Log (Time, Memory in MB): 15:55:15.190489, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.200770, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.210964, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.221151, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.231526, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.241818, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.252074, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.262294, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.272539, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.282943, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.293293, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.303709, 941.34 MB

Memory Usage Log (Time, Memory in MB): 15:55:15.313990, 941.34 MB

29 | Memory Usage: 941.34 MB | line: self.operator.adjoint(self.u, out=self.tmp_domain)

Memory Usage Log (Time, Memory in MB): 15:55:15.324311, 941.34 MB

30 | Memory Usage: 941.34 MB | line: self.v.sapyb(-self.beta, self.tmp_domain, 1., out=self.v)

31 | Memory Usage: 941.34 MB | line: self.alpha = self.v.norm()

Memory Usage Log (Time, Memory in MB): 15:55:15.334620, 941.34 MB

32 | Memory Usage: 941.34 MB | line: self.v /= self.alpha

33 | Memory Usage: 941.34 MB | line: rhobar1 = self.rhobar, psi = 0

34 | Memory Usage: 941.34 MB | line: self.phibar = s * self.phibar

Memory Usage Log (Time, Memory in MB): 15:55:15.344957, 941.33 MB

35 | Memory Usage: 941.33 MB | line: self.x.sapyb(1, self.d, phi/rho, out=self.x)

Memory Usage Log (Time, Memory in MB): 15:55:15.355259, 941.32 MB

36 | Memory Usage: 941.32 MB | line: self.d.sapyb(-theta/rho, self.v, 1, out=self.d)

End of update | Memory Usage: 941.32 MB | line: self.normr = math.sqrt(self.phibar ** 2 + self.res2)

23 | Memory Usage: 941.32 MB | line: update(self)

24 | Memory Usage: 941.32 MB | line: callback(self)

End of run | Memory Usage: 941.32 MB | line:
</pre></div></div>
</div>
<p>Below is a graph illustrating the overall trends across the methods, showing the comparison for CGLS and LSQR:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_mem</span><span class="p">(</span><span class="n">dfs</span><span class="o">=</span><span class="p">(</span><span class="n">cgls_lp</span><span class="p">,</span> <span class="n">lsqr_lp</span><span class="p">),</span> <span class="n">algNms</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;CGLS&quot;</span><span class="p">,</span> <span class="s2">&quot;LSQR&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_62_0.png" src="../../_images/demos_memory_profiling_sandstone_62_0.png" />
</div>
</div>
<p style="font-size:14px; color:#086bb8;"><p>Figure 4: This graph shows the memory usages before (initial), during (peak) and after (final) the ‘init’ and ‘run’ methods in CGLS (Blue) and LSQR (Orange). The first two points show the memory increase during ‘init’, which remains stable. Unlike CGLS, LSQR’s first ‘run’ (iteration) shows another memory increase, which also stays consistent and shows that LSQR uses more memory than CGLS. The spikes during each subsequent run show that the memory usage reaches a peak, and then drops back down,
resulting in a net increase of ~0 MB. This is consistent across all ‘run’ calls (iterations).</p>
</p><p>LSQR creates 4 copies of the ImageData space, and 2 copies of the AcquisitionData, totalling to ~<strong>259 MB</strong>. This can be seen clearly in the breakdown below:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> lsqr_mem_prof
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">lsqr_mp</span> <span class="c1"># Uncomment to run memory_profiler breakdown</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment to see memory_profiler breakdown:</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">lsqr_mem_prof</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[:</span><span class="mi">42</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Print set_up</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">lsqr_mem_prof</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">77</span><span class="p">:</span><span class="mi">135</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Print run 1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dataset folder already exists in ..
Filename: /home/efv97572/cil-showcase/CIL-User-Showcase/015_Memory_Profiling_LSQR_CGLS/Algorithms/LSQRMP.py

Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
    92    680.4 MiB    680.4 MiB           1       @profile
    93                                             def set_up(self, initial, operator, data):
    94                                                 r&#39;&#39;&#39;Initialisation of the algorithm
    95                                                 Parameters
    96                                                 ------------
    97                                                 operator : Operator
    98                                                     Linear operator for the inverse problem
    99                                                 initial : (optional) DataContainer in the domain of the operator, default is a DataContainer filled with zeros.
   100                                                     Initial guess
   101                                                 data : DataContainer in the range of the operator
   102                                                     Acquired data to reconstruct
   103
   104                                                 &#39;&#39;&#39;
   105
   106    680.4 MiB      0.0 MiB           1           log.info(&#34;%s setting up&#34;, self.__class__.__name__)
   107    734.3 MiB     53.9 MiB           1           self.x = initial.copy() #1 domain
   108    734.3 MiB      0.0 MiB           1           self.operator = operator
   109
   110                                                 # Initialise Golub-Kahan bidiagonalisation (GKB)
   111
   112                                                 #self.u = data - self.operator.direct(self.x)
   113    756.8 MiB     22.5 MiB           1           self.u = self.operator.direct(self.x) #1 range
   114    757.1 MiB      0.3 MiB           1           self.u.sapyb(-1, data, 1, out=self.u)
   115    757.1 MiB      0.0 MiB           1           self.beta = self.u.norm()
   116    757.1 MiB      0.0 MiB           1           self.u /= self.beta
   117
   118    812.1 MiB     55.0 MiB           1           self.v = self.operator.adjoint(self.u) #2 domain
   119    812.1 MiB      0.0 MiB           1           self.alpha = self.v.norm()
   120    812.1 MiB      0.0 MiB           1           self.v /= self.alpha
   121
   122    812.1 MiB      0.0 MiB           1           self.rhobar = self.alpha
   123    812.1 MiB      0.0 MiB           1           self.phibar = self.beta
   124    812.1 MiB      0.0 MiB           1           self.normr = self.beta
   125    812.1 MiB      0.0 MiB           1           self.regalphasq = self.regalpha**2
   126
   127    865.8 MiB     53.7 MiB           1           self.d = self.v.copy() #3 domain
   128    887.6 MiB     21.8 MiB           1           self.tmp_range = data.geometry.allocate(None) #2 range

run 1
Filename: /home/efv97572/cil-showcase/CIL-User-Showcase/015_Memory_Profiling_LSQR_CGLS/Algorithms/LSQRMP.py

Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
   136    887.6 MiB    887.6 MiB           1       @profile
   137                                             def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):
   138                                                 r&#34;&#34;&#34;run upto :code:`iterations` with callbacks/logging.
   139
   140                                                 For a demonstration of callbacks see https://github.com/TomographicImaging/CIL-Demos/blob/main/misc/callback_demonstration.ipynb
   141
   142                                                 Parameters
   143                                                 -----------
   144                                                 iterations: int, default is None
   145                                                     Number of iterations to run. If not set the algorithm will run until :code:`should_stop()` is reached
   146                                                 callbacks: list of callables, default is Defaults to :code:`[ProgressCallback(verbose)]`
   147                                                     List of callables which are passed the current Algorithm object each iteration. Defaults to :code:`[ProgressCallback(verbose)]`.
   148                                                 verbose: 0=quiet, 1=info, 2=debug
   149                                                     Passed to the default callback to determine the verbosity of the printed output.
   150                                                 &#34;&#34;&#34;
   151
   152    887.6 MiB      0.0 MiB           1           if &#39;print_interval&#39; in kwargs:
   153                                                     warnings.warn(&#34;use `TextProgressCallback(miniters)` instead of `run(print_interval)`&#34;,
   154                                                          DeprecationWarning, stacklevel=2)
   155    887.6 MiB      0.0 MiB           1           if callbacks is None:
   156    887.6 MiB      0.0 MiB           1               callbacks = [ProgressCallback(verbose=verbose)]
   157
   158                                                 # transform old-style callbacks into new
   159    887.6 MiB      0.0 MiB           1           callback = kwargs.get(&#39;callback&#39;, None)
   160
   161    887.6 MiB      0.0 MiB           1           if callback is not None:
   162                                                     callbacks.append(_OldCallback(callback, verbose=verbose))
   163    887.6 MiB      0.0 MiB           1           if hasattr(self, &#39;__log_file&#39;):
   164                                                     callbacks.append(LogfileCallback(self.__log_file, verbose=verbose))
   165
   166    887.6 MiB      0.0 MiB           1           if self.should_stop():
   167                                                     print(&#34;Stop criterion has been reached.&#34;)
   168    887.6 MiB      0.0 MiB           1           if iterations is None:
   169                                                     warnings.warn(&#34;`run()` missing `iterations`&#34;, DeprecationWarning, stacklevel=2)
   170                                                     iterations = self.max_iteration
   171
   172    887.6 MiB      0.0 MiB           1           if self.iteration == -1 and self.update_objective_interval&gt;0:
   173    887.6 MiB      0.0 MiB           1               iterations+=1
   174
   175                                                 # call `__next__` upto `iterations` times or until `StopIteration` is raised
   176    887.6 MiB      0.0 MiB           1           self.max_iteration = self.iteration + iterations
   177
   178    887.6 MiB      0.0 MiB           2           iters = (count(self.iteration) if numpy.isposinf(self.max_iteration)
   179    887.6 MiB      0.0 MiB           1                    else range(self.iteration, self.max_iteration))
   180
   181    941.7 MiB     53.9 MiB           3           for _ in zip(iters, self):
   182    941.7 MiB      0.0 MiB           2               try:
   183    941.7 MiB      0.0 MiB           4                   for callback in callbacks:
   184    941.7 MiB      0.2 MiB           2                       callback(self)
   185                                                     except StopIteration:
   186                                                         break

</pre></div></div>
</div>
</section>
</section>
<section id="Tikhonov-regularisation-using-CGLS-and-LSQR---with-or-without-a-block">
<h2>Tikhonov regularisation using CGLS and LSQR - with or without a block<a class="headerlink" href="#Tikhonov-regularisation-using-CGLS-and-LSQR---with-or-without-a-block" title="Link to this heading">#</a></h2>
<section id="Tikhonov-regularisation">
<h3>Tikhonov regularisation<a class="headerlink" href="#Tikhonov-regularisation" title="Link to this heading">#</a></h3>
<p>We can add a regularisation term to problem solved by CGLS; this gives us the minimisation problem in the following form, which is known as Tikhonov regularisation:</p>
<div class="math notranslate nohighlight">
\[\underset{u}{\mathrm{argmin}}\begin{Vmatrix}A u - b \end{Vmatrix}^2_2 + \alpha^2\|u\|^2_2\]</div>
<p>where,</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(A\)</span> is the projection operator</p></li>
<li><p><span class="math notranslate nohighlight">\(b\)</span> is the acquired data</p></li>
<li><p><span class="math notranslate nohighlight">\(u\)</span> is the unknown image to be solved for</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha\)</span> is the regularisation parameter</p></li>
</ul>
<p>The first term measures the fidelity of the solution to the data. The second term meausures the fidelity to the prior knowledge we have imposed on the system, operator <span class="math notranslate nohighlight">\(L\)</span>. <span class="math notranslate nohighlight">\(\alpha\)</span> controls the trade-off between these terms. <span class="math notranslate nohighlight">\(L\)</span> is often chosen to be a smoothing operator like the identity matrix, or a gradient operator <strong>constrained to the squared L2-norm</strong>.</p>
<p>This can be re-written equivalently in the block matrix form:</p>
<div class="math notranslate nohighlight">
\[\underset{u}{\mathrm{argmin}}\begin{Vmatrix}\binom{A}{\alpha I} u - \binom{b}{0}\end{Vmatrix}^2_2\]</div>
<p>With the definitions:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\tilde{A} = \binom{A}{\alpha I}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\tilde{b} = \binom{b}{0}\)</span></p></li>
</ul>
<p>this can now be recognised as a least squares problem:</p>
<div class="math notranslate nohighlight">
\[\underset{u}{\mathrm{argmin}}\begin{Vmatrix}\tilde{A} u - \tilde{b}\end{Vmatrix}^2_2\]</div>
<p>and being a least squares problem, it can be solved using CGLS with <span class="math notranslate nohighlight">\(\tilde{A}\)</span> as operator and <span class="math notranslate nohighlight">\(\tilde{b}\)</span> as data.</p>
<p>LSQR in CIL has the option to include Tikhonov regularisation without using blocks. In this section, we will compare LSQR Tikhonov with a block, CGLS with a block, and LSQR Tikhonov without a block.</p>
<p>Set up the algorithms:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial</span> <span class="o">=</span> <span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">L</span> <span class="o">=</span> <span class="n">IdentityOperator</span><span class="p">(</span><span class="n">ig</span><span class="p">)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">operator_block</span> <span class="o">=</span> <span class="n">BlockOperator</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">alpha</span><span class="o">*</span><span class="n">L</span><span class="p">)</span>
<span class="n">zero_data</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data_block</span> <span class="o">=</span> <span class="n">BlockDataContainer</span><span class="p">(</span><span class="n">sandstone_noisy</span><span class="p">,</span> <span class="n">zero_data</span><span class="p">)</span>

<span class="n">maxit</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">itsAtATime</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">maxit</span><span class="o">/</span><span class="n">itsAtATime</span><span class="p">)</span>

<span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxit</span><span class="p">,</span> <span class="n">itsAtATime</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgls_tik_block</span> <span class="o">=</span> <span class="n">CGLS</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">operator_block</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_block</span><span class="p">,</span> <span class="n">update_objective_interval</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">times_cgls_tik_block</span><span class="p">,</span> <span class="n">rel_res_vec_cgls_tik_block</span><span class="p">,</span> <span class="n">rel_err_vec_cgls_tik_block</span> <span class="o">=</span> <span class="n">timed_iterations</span><span class="p">(</span><span class="n">sandstone_noisy</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">sandstone_cor</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">cgls_tik_block</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">itsAtATime</span><span class="p">)</span>

<span class="n">lsqr_tik_block</span> <span class="o">=</span> <span class="n">LSQR</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">operator_block</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_block</span><span class="p">,</span> <span class="n">update_objective_interval</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">times_lsqr_tik_block</span><span class="p">,</span> <span class="n">rel_res_vec_lsqr_tik_block</span><span class="p">,</span> <span class="n">rel_err_vec_lsqr_tik_block</span> <span class="o">=</span> <span class="n">timed_iterations</span><span class="p">(</span><span class="n">sandstone_noisy</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">sandstone_cor</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">lsqr_tik_block</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">itsAtATime</span><span class="p">)</span>

<span class="n">lsqr_tik_simple</span> <span class="o">=</span> <span class="n">LSQR_Tikhonov</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sandstone_noisy</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">)</span>
<span class="n">times_lsqr_tik_simple</span><span class="p">,</span> <span class="n">rel_res_vec_lsqr_tik_simple</span><span class="p">,</span> <span class="n">rel_err_vec_lsqr_tik_simple</span> <span class="o">=</span> <span class="n">timed_iterations</span><span class="p">(</span><span class="n">sandstone_noisy</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">sandstone_cor</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">lsqr_tik_simple</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">itsAtATime</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="id1">
<h3>Convergence/reduction of residuals:<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>The plots below show the progress of the residuals across each iteration, and the error across iterations:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">rel_res_vec_lsqr_tik_block</span><span class="p">,</span> <span class="s1">&#39;*-&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">rel_res_vec_cgls_tik_block</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">rel_res_vec_lsqr_tik_simple</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteratons&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;LSQR Block&#39;</span><span class="p">,</span> <span class="s1">&#39;CGLS Block&#39;</span><span class="p">,</span> <span class="s1">&#39;LSQR Tik&#39;</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">rel_err_vec_lsqr_tik_block</span><span class="p">,</span> <span class="s1">&#39;*-&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">rel_err_vec_cgls_tik_block</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">rel_err_vec_lsqr_tik_simple</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteratons&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;LSQR Block&#39;</span><span class="p">,</span> <span class="s1">&#39;CGLS Block&#39;</span><span class="p">,</span> <span class="s1">&#39;LSQR Tik&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_74_0.png" src="../../_images/demos_memory_profiling_sandstone_74_0.png" />
</div>
</div>
<p style="font-size:14px; color:#086bb8;"><p>Figure 5: (Left) This graph shows the progress of the residuals across 100 iterations. CGLS Block, LSQR Block and LSQR Tikhonov’s iterations are equivalent mathematically, so they converge to the same residuals. The residuals themselves decrease (minimise) across the iterations, meaning the algorithms’ reconstructions match the data closely. (Right) This graph shows the relative error across 100 iterations. All 3 algorithms display identical errors due to mathematically equivalent iterations.
This graph shows that the algorithms’ reconstructions match the FBP reconstruction (ground truth) most at iteration ~20.</p>
</p><p>Compare the time taken/elapsed across each iteration for the 3 algorithms:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">times_cgls_tik_block</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">times_lsqr_tik_block</span><span class="p">,</span> <span class="s1">&#39;b.--&#39;</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">times_lsqr_tik_simple</span><span class="p">,</span> <span class="s1">&#39;g.-&#39;</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;CGLS Block&#39;</span><span class="p">,</span> <span class="s1">&#39;LSQR Block&#39;</span><span class="p">,</span> <span class="s1">&#39;LSQR Tik&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f3d909333e0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_77_1.png" src="../../_images/demos_memory_profiling_sandstone_77_1.png" />
</div>
</div>
<p style="font-size:14px; color:#086bb8;"><p>Figure 6: This graph shows the time elapsed at each iteration for CGLS Block, LSQR Block and LSQR Tikhonov. For all algorithms, this relationship is linear. On this device, the elapsed times across 100 iterations are very similar, with CGLS Block being slightly faster overall.</p>
</p></section>
</section>
<section id="Memory-costs-for-LSQR+Block,-CGLS+Block-and-LSQR+Tikhonov">
<h2>Memory costs for LSQR+Block, CGLS+Block and LSQR+Tikhonov<a class="headerlink" href="#Memory-costs-for-LSQR+Block,-CGLS+Block-and-LSQR+Tikhonov" title="Link to this heading">#</a></h2>
<section id="Setting-Up-Memory-Tracking:">
<h3>Setting Up Memory Tracking:<a class="headerlink" href="#Setting-Up-Memory-Tracking:" title="Link to this heading">#</a></h3>
<p>Setup the memory tracking for the three algorithms:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> cgls_block_prof
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">cgls_lp_tik_block</span> <span class="o">--</span><span class="n">track</span><span class="o">-</span><span class="n">peak</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> lsqr_block_prof
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">lsqr_lp_tik_block</span> <span class="o">--</span><span class="n">track</span><span class="o">-</span><span class="n">peak</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> lsqr_block_mp
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">lsqr_mp_tik_block</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> lsqr_tik_prof
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">lsqr_tik_lp</span> <span class="o">--</span><span class="n">track</span><span class="o">-</span><span class="n">peak</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> lsqr_tik_mp
<span class="err">!</span><span class="n">python3</span> <span class="n">Scripts</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">sandstone</span><span class="o">.</span><span class="n">py</span> <span class="n">lsqr_tik_mp</span>
</pre></div>
</div>
</div>
</section>
<section id="Memory-Usage-Results:">
<h3>Memory Usage Results:<a class="headerlink" href="#Memory-Usage-Results:" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ImageData and AcquisitionData Sizes</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate of &#39;initial&#39; (ImageData) size: </span><span class="si">{</span><span class="n">initial</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">dtypeSize</span><span class="o">*</span><span class="n">MB</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate of &#39;sandstone_noisy&#39; (AcquisitionData) size: </span><span class="si">{</span><span class="n">sandstone_noisy</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">dtypeSize</span><span class="o">*</span><span class="n">MB</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate of &#39;data_block&#39; (Block AcquisitionData) size: </span><span class="si">{</span><span class="p">(</span><span class="n">sandstone_noisy</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">zero_data</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">*</span><span class="n">dtypeSize</span><span class="o">*</span><span class="n">MB</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimate of &#39;initial&#39; (ImageData) size: 53.9 MB
Estimate of &#39;sandstone_noisy&#39; (AcquisitionData) size: 21.5 MB
Estimate of &#39;data_block&#39; (Block AcquisitionData) size: 75.4 MB
</pre></div></div>
</div>
<div class="line-block">
<div class="line">In the setup for CGLS Block, the ImageData space is 53.9 MB but the (Block) AcquisitionData is now 75.4 MB.</div>
<div class="line">Since the algorithm is the same, we expect the same number of increases as before. In total, we expect a setup increase of: (53.9 * 3) + (75.4 * 2) = <strong>~312.5 MB</strong> (Highlighted in turquoise).</div>
</div>
<p>In the dataframe below, there is a (temporary) peak increase of ~129.5 MB in the first <code class="docutils literal notranslate"><span class="pre">update</span></code> (Highlighted in pink) due to the line <code class="docutils literal notranslate"><span class="pre">self.operator.direct(self.p,</span> <span class="pre">out=self.q)</span></code>. This corresponds to the ImageData and Block AcquisitionData sizes: 53.9 + 75.4 = ~129.3 MB. Most of this memory is deallocated by the end of this line, ~21.5 MB (1x original AcquisitionData) stays occupied in the total usage (Highlighted in orange).</p>
<p>The subsequent <code class="docutils literal notranslate"><span class="pre">update</span></code> calls have a peak of ~107.9 MB, which is 1x AcqData (~21.5) less than the previous peak, suggesting that the AcqData buffer array in <code class="docutils literal notranslate"><span class="pre">self.q</span></code> is populated with values during the first call to <code class="docutils literal notranslate"><span class="pre">update</span></code>.</p>
<p>In total, CGLS Block makes:</p>
<ul class="simple">
<li><p>3 copies of ImgData (53.9 MB)</p></li>
<li><p>2 copies of Block AcqData (75.4 MB)</p></li>
<li><p>1 copy of AcqData (21.5 MB)</p></li>
</ul>
<p>The CGLS Block DataFrame shows these results below:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgls_block_lp</span> <span class="o">=</span> <span class="n">line_peak_process</span><span class="p">(</span><span class="n">cgls_block_prof</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cgls_block_lp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;background-color: pink&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="mi">134</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">126</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span>
    <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Peak Memory Increase (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: turquoise&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">300</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: orange&#39;</span> <span class="k">if</span> <span class="mi">24</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style type="text/css">
#T_a937c_row0_col4, #T_a937c_row1_col4 {
  background-color: turquoise;
}
#T_a937c_row2_col4, #T_a937c_row3_col4 {
  background-color: orange;
}
#T_a937c_row3_col5 {
  background-color: pink;
}
</style>
<table id="T_a937c">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_a937c_level0_col0" class="col_heading level0 col0" >Method</th>
      <th id="T_a937c_level0_col1" class="col_heading level0 col1" >Initial Memory Usage (MiB)</th>
      <th id="T_a937c_level0_col2" class="col_heading level0 col2" >Peak Memory</th>
      <th id="T_a937c_level0_col3" class="col_heading level0 col3" >Final Memory Usage (MiB)</th>
      <th id="T_a937c_level0_col4" class="col_heading level0 col4" >Total Memory Usage (MiB)</th>
      <th id="T_a937c_level0_col5" class="col_heading level0 col5" >Peak Memory Increase (MiB)</th>
      <th id="T_a937c_level0_col6" class="col_heading level0 col6" >Peak Line</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_a937c_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_a937c_row0_col0" class="data row0 col0" >init</td>
      <td id="T_a937c_row0_col1" class="data row0 col1" >0.00</td>
      <td id="T_a937c_row0_col2" class="data row0 col2" >314.77</td>
      <td id="T_a937c_row0_col3" class="data row0 col3" >314.77</td>
      <td id="T_a937c_row0_col4" class="data row0 col4" >314.77</td>
      <td id="T_a937c_row0_col5" class="data row0 col5" >314.77</td>
      <td id="T_a937c_row0_col6" class="data row0 col6" >self.set_up(initial=initial, operator=operator, data=data)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_a937c_row1_col0" class="data row1 col0" >setup</td>
      <td id="T_a937c_row1_col1" class="data row1 col1" >0.00</td>
      <td id="T_a937c_row1_col2" class="data row1 col2" >314.77</td>
      <td id="T_a937c_row1_col3" class="data row1 col3" >314.77</td>
      <td id="T_a937c_row1_col4" class="data row1 col4" >314.77</td>
      <td id="T_a937c_row1_col5" class="data row1 col5" >314.77</td>
      <td id="T_a937c_row1_col6" class="data row1 col6" >self.gamma = self.norms0**2</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_a937c_row2_col0" class="data row2 col0" >run 1</td>
      <td id="T_a937c_row2_col1" class="data row2 col1" >314.77</td>
      <td id="T_a937c_row2_col2" class="data row2 col2" >444.35</td>
      <td id="T_a937c_row2_col3" class="data row2 col3" >336.67</td>
      <td id="T_a937c_row2_col4" class="data row2 col4" >21.90</td>
      <td id="T_a937c_row2_col5" class="data row2 col5" >129.58</td>
      <td id="T_a937c_row2_col6" class="data row2 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_a937c_row3_col0" class="data row3 col0" >update 1</td>
      <td id="T_a937c_row3_col1" class="data row3 col1" >314.96</td>
      <td id="T_a937c_row3_col2" class="data row3 col2" >444.35</td>
      <td id="T_a937c_row3_col3" class="data row3 col3" >336.67</td>
      <td id="T_a937c_row3_col4" class="data row3 col4" >21.71</td>
      <td id="T_a937c_row3_col5" class="data row3 col5" >129.39</td>
      <td id="T_a937c_row3_col6" class="data row3 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_a937c_row4_col0" class="data row4 col0" >run 2</td>
      <td id="T_a937c_row4_col1" class="data row4 col1" >336.67</td>
      <td id="T_a937c_row4_col2" class="data row4 col2" >444.56</td>
      <td id="T_a937c_row4_col3" class="data row4 col3" >336.73</td>
      <td id="T_a937c_row4_col4" class="data row4 col4" >0.06</td>
      <td id="T_a937c_row4_col5" class="data row4 col5" >107.89</td>
      <td id="T_a937c_row4_col6" class="data row4 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_a937c_row5_col0" class="data row5 col0" >update 2</td>
      <td id="T_a937c_row5_col1" class="data row5 col1" >336.67</td>
      <td id="T_a937c_row5_col2" class="data row5 col2" >444.56</td>
      <td id="T_a937c_row5_col3" class="data row5 col3" >336.73</td>
      <td id="T_a937c_row5_col4" class="data row5 col4" >0.06</td>
      <td id="T_a937c_row5_col5" class="data row5 col5" >107.89</td>
      <td id="T_a937c_row5_col6" class="data row5 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_a937c_row6_col0" class="data row6 col0" >run 3</td>
      <td id="T_a937c_row6_col1" class="data row6 col1" >336.73</td>
      <td id="T_a937c_row6_col2" class="data row6 col2" >444.60</td>
      <td id="T_a937c_row6_col3" class="data row6 col3" >336.78</td>
      <td id="T_a937c_row6_col4" class="data row6 col4" >0.05</td>
      <td id="T_a937c_row6_col5" class="data row6 col5" >107.87</td>
      <td id="T_a937c_row6_col6" class="data row6 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_a937c_row7_col0" class="data row7 col0" >update 3</td>
      <td id="T_a937c_row7_col1" class="data row7 col1" >336.73</td>
      <td id="T_a937c_row7_col2" class="data row7 col2" >444.60</td>
      <td id="T_a937c_row7_col3" class="data row7 col3" >336.76</td>
      <td id="T_a937c_row7_col4" class="data row7 col4" >0.03</td>
      <td id="T_a937c_row7_col5" class="data row7 col5" >107.87</td>
      <td id="T_a937c_row7_col6" class="data row7 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_a937c_row8_col0" class="data row8 col0" >run 4</td>
      <td id="T_a937c_row8_col1" class="data row8 col1" >336.78</td>
      <td id="T_a937c_row8_col2" class="data row8 col2" >444.65</td>
      <td id="T_a937c_row8_col3" class="data row8 col3" >336.80</td>
      <td id="T_a937c_row8_col4" class="data row8 col4" >0.02</td>
      <td id="T_a937c_row8_col5" class="data row8 col5" >107.87</td>
      <td id="T_a937c_row8_col6" class="data row8 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row9" class="row_heading level0 row9" >9</th>
      <td id="T_a937c_row9_col0" class="data row9 col0" >update 4</td>
      <td id="T_a937c_row9_col1" class="data row9 col1" >336.78</td>
      <td id="T_a937c_row9_col2" class="data row9 col2" >444.65</td>
      <td id="T_a937c_row9_col3" class="data row9 col3" >336.80</td>
      <td id="T_a937c_row9_col4" class="data row9 col4" >0.02</td>
      <td id="T_a937c_row9_col5" class="data row9 col5" >107.87</td>
      <td id="T_a937c_row9_col6" class="data row9 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row10" class="row_heading level0 row10" >10</th>
      <td id="T_a937c_row10_col0" class="data row10 col0" >run 5</td>
      <td id="T_a937c_row10_col1" class="data row10 col1" >336.80</td>
      <td id="T_a937c_row10_col2" class="data row10 col2" >444.68</td>
      <td id="T_a937c_row10_col3" class="data row10 col3" >336.85</td>
      <td id="T_a937c_row10_col4" class="data row10 col4" >0.05</td>
      <td id="T_a937c_row10_col5" class="data row10 col5" >107.88</td>
      <td id="T_a937c_row10_col6" class="data row10 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_a937c_level0_row11" class="row_heading level0 row11" >11</th>
      <td id="T_a937c_row11_col0" class="data row11 col0" >update 5</td>
      <td id="T_a937c_row11_col1" class="data row11 col1" >336.80</td>
      <td id="T_a937c_row11_col2" class="data row11 col2" >444.68</td>
      <td id="T_a937c_row11_col3" class="data row11 col3" >336.84</td>
      <td id="T_a937c_row11_col4" class="data row11 col4" >0.04</td>
      <td id="T_a937c_row11_col5" class="data row11 col5" >107.88</td>
      <td id="T_a937c_row11_col6" class="data row11 col6" >self.operator.direct(self.p, out=self.q)</td>
    </tr>
  </tbody>
</table></div>
</div>
<div class="line-block">
<div class="line">We expect the same with LSQR block, in this case, 4 copies of ImageData and 2 copies of Block AcquisitionData, with an extra 21.5 MB allocated for the original AcquisitionData.</div>
<div class="line">In <code class="docutils literal notranslate"><span class="pre">set_up</span></code>, the allocations (Highlighted in turquoise) are: (53.9 * 3) + 75.4 + 21.5 = <strong>~258.6 MB</strong></div>
<div class="line">in the first <code class="docutils literal notranslate"><span class="pre">update</span></code>, the allocations (Highlighted in orange) are: 53.9 + 75.4 = <strong>~129.3 MB</strong></div>
</div>
<p>The memory increases in <code class="docutils literal notranslate"><span class="pre">update</span></code> 1 occur because the buffer arrays initialised in <code class="docutils literal notranslate"><span class="pre">set_up</span></code> become populated with values.</p>
<p>The peak of ~183 MB (Highlighted in pink) is due to <code class="docutils literal notranslate"><span class="pre">self.operator.direct(self.v,</span> <span class="pre">out=self.tmp_range)</span></code> creating temp buffers of ImgData + Block AcqData, and <code class="docutils literal notranslate"><span class="pre">self.operator.adjoint(self.u,</span> <span class="pre">out=self.tmp_domain)</span></code> creating 2 buffers of ImgData during <code class="docutils literal notranslate"><span class="pre">update</span></code> 1.</p>
<p>In total, LSQR Block makes:</p>
<ul class="simple">
<li><p>4 copies of ImgData (53.9 MB)</p></li>
<li><p>2 copies of Block AcqData (75.4 MB)</p></li>
<li><p>1 copy of AcqData (21.5 MB)</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lsqr_block_lp</span> <span class="o">=</span> <span class="n">line_peak_process</span><span class="p">(</span><span class="n">lsqr_block_prof</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lsqr_block_lp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;background-color: pink&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="mi">190</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">175</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span>
    <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Peak Memory Increase (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: turquoise&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: orange&#39;</span> <span class="k">if</span> <span class="mi">134</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">126</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style type="text/css">
#T_bf359_row0_col4, #T_bf359_row1_col4 {
  background-color: turquoise;
}
#T_bf359_row2_col4, #T_bf359_row3_col4 {
  background-color: orange;
}
#T_bf359_row3_col5 {
  background-color: pink;
}
</style>
<table id="T_bf359">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_bf359_level0_col0" class="col_heading level0 col0" >Method</th>
      <th id="T_bf359_level0_col1" class="col_heading level0 col1" >Initial Memory Usage (MiB)</th>
      <th id="T_bf359_level0_col2" class="col_heading level0 col2" >Peak Memory</th>
      <th id="T_bf359_level0_col3" class="col_heading level0 col3" >Final Memory Usage (MiB)</th>
      <th id="T_bf359_level0_col4" class="col_heading level0 col4" >Total Memory Usage (MiB)</th>
      <th id="T_bf359_level0_col5" class="col_heading level0 col5" >Peak Memory Increase (MiB)</th>
      <th id="T_bf359_level0_col6" class="col_heading level0 col6" >Peak Line</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_bf359_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_bf359_row0_col0" class="data row0 col0" >init</td>
      <td id="T_bf359_row0_col1" class="data row0 col1" >0.00</td>
      <td id="T_bf359_row0_col2" class="data row0 col2" >260.78</td>
      <td id="T_bf359_row0_col3" class="data row0 col3" >260.78</td>
      <td id="T_bf359_row0_col4" class="data row0 col4" >260.78</td>
      <td id="T_bf359_row0_col5" class="data row0 col5" >260.78</td>
      <td id="T_bf359_row0_col6" class="data row0 col6" >self.set_up(initial=initial, operator=operator, data=data)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_bf359_row1_col0" class="data row1 col0" >setup</td>
      <td id="T_bf359_row1_col1" class="data row1 col1" >0.00</td>
      <td id="T_bf359_row1_col2" class="data row1 col2" >260.78</td>
      <td id="T_bf359_row1_col3" class="data row1 col3" >260.78</td>
      <td id="T_bf359_row1_col4" class="data row1 col4" >260.78</td>
      <td id="T_bf359_row1_col5" class="data row1 col5" >260.78</td>
      <td id="T_bf359_row1_col6" class="data row1 col6" >self.tmp_range = data.geometry.allocate(None)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_bf359_row2_col0" class="data row2 col0" >run 1</td>
      <td id="T_bf359_row2_col1" class="data row2 col1" >260.78</td>
      <td id="T_bf359_row2_col2" class="data row2 col2" >444.51</td>
      <td id="T_bf359_row2_col3" class="data row2 col3" >390.60</td>
      <td id="T_bf359_row2_col4" class="data row2 col4" >129.82</td>
      <td id="T_bf359_row2_col5" class="data row2 col5" >183.73</td>
      <td id="T_bf359_row2_col6" class="data row2 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_bf359_row3_col0" class="data row3 col0" >update 1</td>
      <td id="T_bf359_row3_col1" class="data row3 col1" >261.14</td>
      <td id="T_bf359_row3_col2" class="data row3 col2" >444.51</td>
      <td id="T_bf359_row3_col3" class="data row3 col3" >390.55</td>
      <td id="T_bf359_row3_col4" class="data row3 col4" >129.41</td>
      <td id="T_bf359_row3_col5" class="data row3 col5" >183.37</td>
      <td id="T_bf359_row3_col6" class="data row3 col6" >self.operator.adjoint(self.u, out=self.tmp_domain)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_bf359_row4_col0" class="data row4 col0" >run 2</td>
      <td id="T_bf359_row4_col1" class="data row4 col1" >390.60</td>
      <td id="T_bf359_row4_col2" class="data row4 col2" >498.47</td>
      <td id="T_bf359_row4_col3" class="data row4 col3" >390.64</td>
      <td id="T_bf359_row4_col4" class="data row4 col4" >0.04</td>
      <td id="T_bf359_row4_col5" class="data row4 col5" >107.87</td>
      <td id="T_bf359_row4_col6" class="data row4 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_bf359_row5_col0" class="data row5 col0" >update 2</td>
      <td id="T_bf359_row5_col1" class="data row5 col1" >390.60</td>
      <td id="T_bf359_row5_col2" class="data row5 col2" >498.47</td>
      <td id="T_bf359_row5_col3" class="data row5 col3" >390.59</td>
      <td id="T_bf359_row5_col4" class="data row5 col4" >-0.01</td>
      <td id="T_bf359_row5_col5" class="data row5 col5" >107.87</td>
      <td id="T_bf359_row5_col6" class="data row5 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_bf359_row6_col0" class="data row6 col0" >run 3</td>
      <td id="T_bf359_row6_col1" class="data row6 col1" >390.64</td>
      <td id="T_bf359_row6_col2" class="data row6 col2" >498.51</td>
      <td id="T_bf359_row6_col3" class="data row6 col3" >390.64</td>
      <td id="T_bf359_row6_col4" class="data row6 col4" >0.00</td>
      <td id="T_bf359_row6_col5" class="data row6 col5" >107.87</td>
      <td id="T_bf359_row6_col6" class="data row6 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_bf359_row7_col0" class="data row7 col0" >update 3</td>
      <td id="T_bf359_row7_col1" class="data row7 col1" >390.64</td>
      <td id="T_bf359_row7_col2" class="data row7 col2" >498.51</td>
      <td id="T_bf359_row7_col3" class="data row7 col3" >390.64</td>
      <td id="T_bf359_row7_col4" class="data row7 col4" >0.00</td>
      <td id="T_bf359_row7_col5" class="data row7 col5" >107.87</td>
      <td id="T_bf359_row7_col6" class="data row7 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_bf359_row8_col0" class="data row8 col0" >run 4</td>
      <td id="T_bf359_row8_col1" class="data row8 col1" >390.64</td>
      <td id="T_bf359_row8_col2" class="data row8 col2" >498.56</td>
      <td id="T_bf359_row8_col3" class="data row8 col3" >390.68</td>
      <td id="T_bf359_row8_col4" class="data row8 col4" >0.04</td>
      <td id="T_bf359_row8_col5" class="data row8 col5" >107.92</td>
      <td id="T_bf359_row8_col6" class="data row8 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row9" class="row_heading level0 row9" >9</th>
      <td id="T_bf359_row9_col0" class="data row9 col0" >update 4</td>
      <td id="T_bf359_row9_col1" class="data row9 col1" >390.64</td>
      <td id="T_bf359_row9_col2" class="data row9 col2" >498.56</td>
      <td id="T_bf359_row9_col3" class="data row9 col3" >390.68</td>
      <td id="T_bf359_row9_col4" class="data row9 col4" >0.04</td>
      <td id="T_bf359_row9_col5" class="data row9 col5" >107.92</td>
      <td id="T_bf359_row9_col6" class="data row9 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row10" class="row_heading level0 row10" >10</th>
      <td id="T_bf359_row10_col0" class="data row10 col0" >run 5</td>
      <td id="T_bf359_row10_col1" class="data row10 col1" >390.68</td>
      <td id="T_bf359_row10_col2" class="data row10 col2" >498.61</td>
      <td id="T_bf359_row10_col3" class="data row10 col3" >390.74</td>
      <td id="T_bf359_row10_col4" class="data row10 col4" >0.06</td>
      <td id="T_bf359_row10_col5" class="data row10 col5" >107.93</td>
      <td id="T_bf359_row10_col6" class="data row10 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_bf359_level0_row11" class="row_heading level0 row11" >11</th>
      <td id="T_bf359_row11_col0" class="data row11 col0" >update 5</td>
      <td id="T_bf359_row11_col1" class="data row11 col1" >390.68</td>
      <td id="T_bf359_row11_col2" class="data row11 col2" >498.61</td>
      <td id="T_bf359_row11_col3" class="data row11 col3" >390.74</td>
      <td id="T_bf359_row11_col4" class="data row11 col4" >0.06</td>
      <td id="T_bf359_row11_col5" class="data row11 col5" >107.93</td>
      <td id="T_bf359_row11_col6" class="data row11 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
  </tbody>
</table></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ImageData and AcquisitionData Sizes</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate of &#39;initial&#39; (ImageData) size: </span><span class="si">{</span><span class="n">initial</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">dtypeSize</span><span class="o">*</span><span class="n">MB</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate of &#39;sandstone_noisy&#39; (AcquisitionData) size: </span><span class="si">{</span><span class="n">sandstone_noisy</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">dtypeSize</span><span class="o">*</span><span class="n">MB</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimate of &#39;initial&#39; (ImageData) size: 53.9 MB
Estimate of &#39;sandstone_noisy&#39; (AcquisitionData) size: 21.5 MB
</pre></div></div>
</div>
<p>The setup for LSQR Tikhonov does not use the Block operator, so the ImageData and AcquisitionData sizes are <strong>53.9 MB</strong> and <strong>21.5 MB</strong>, respectively.</p>
<p>We expect the Total Memory Usage to be the same as LSQR run previously, without the BlockOperator:</p>
<ul class="simple">
<li><p>4 copies of ImageData (3 in <code class="docutils literal notranslate"><span class="pre">set_up</span></code> (Highlighted in turquoise), 1 in <code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">update</span></code> (Highlighted in orange))</p></li>
<li><p>2 copies of AcquisitionData (Highlighted in turquoise)</p></li>
</ul>
<p>Totalling to a usage of: (53.9 * 4) + (21.5 * 2) = <strong>~258.6 MB</strong>. This is shown in the outputs below, showing LSQR Tikhonov will use less memory than the block versions of CGLS and LSQR.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment to see memory_profiler breakdown:</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">lsqr_tik_mp</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[:</span><span class="mi">49</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Print set_up</span>
<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">lsqr_tik_mp</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">77</span><span class="p">:</span><span class="mi">135</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Print run 1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dataset folder already exists in ..
Filename: /home/efv97572/cil-showcase/CIL-User-Showcase/015_Memory_Profiling_LSQR_CGLS/Algorithms/LSQRMP.py

Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
    92    681.6 MiB    681.6 MiB           1       @profile
    93                                             def set_up(self, initial, operator, data):
    94                                                 r&#39;&#39;&#39;Initialisation of the algorithm
    95                                                 Parameters
    96                                                 ------------
    97                                                 operator : Operator
    98                                                     Linear operator for the inverse problem
    99                                                 initial : (optional) DataContainer in the domain of the operator, default is a DataContainer filled with zeros.
   100                                                     Initial guess
   101                                                 data : DataContainer in the range of the operator
   102                                                     Acquired data to reconstruct
   103
   104                                                 &#39;&#39;&#39;
   105
   106    681.6 MiB      0.0 MiB           1           log.info(&#34;%s setting up&#34;, self.__class__.__name__)
   107    735.3 MiB     53.7 MiB           1           self.x = initial.copy() #1 domain
   108    735.3 MiB      0.0 MiB           1           self.operator = operator
   109
   110                                                 # Initialise Golub-Kahan bidiagonalisation (GKB)
   111
   112                                                 #self.u = data - self.operator.direct(self.x)
   113    758.2 MiB     22.9 MiB           1           self.u = self.operator.direct(self.x) #1 range
   114    758.2 MiB      0.0 MiB           1           self.u.sapyb(-1, data, 1, out=self.u)
   115    758.3 MiB      0.0 MiB           1           self.beta = self.u.norm()
   116    758.4 MiB      0.1 MiB           1           self.u /= self.beta
   117
   118    813.2 MiB     54.9 MiB           1           self.v = self.operator.adjoint(self.u) #2 domain
   119    813.2 MiB      0.0 MiB           1           self.alpha = self.v.norm()
   120    813.2 MiB      0.0 MiB           1           self.v /= self.alpha
   121
   122    813.2 MiB      0.0 MiB           1           self.rhobar = self.alpha
   123    813.2 MiB      0.0 MiB           1           self.phibar = self.beta
   124    813.2 MiB      0.0 MiB           1           self.normr = self.beta
   125    813.2 MiB      0.0 MiB           1           self.regalphasq = self.regalpha**2
   126
   127    866.9 MiB     53.7 MiB           1           self.d = self.v.copy() #3 domain
   128    888.5 MiB     21.6 MiB           1           self.tmp_range = data.geometry.allocate(None) #2 range
   129    888.5 MiB      0.0 MiB           1           self.tmp_domain = self.x.geometry.allocate(None) #4 domain
   130
   131    888.5 MiB      0.0 MiB           1           self.res2 = 0
   132
   133    888.5 MiB      0.0 MiB           1           self.configured = True
   134    888.5 MiB      0.0 MiB           1           log.info(&#34;%s configured&#34;, self.__class__.__name__)


run 1
Filename: /home/efv97572/cil-showcase/CIL-User-Showcase/015_Memory_Profiling_LSQR_CGLS/Algorithms/LSQRMP.py

Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
   136    888.7 MiB    888.7 MiB           1       @profile
   137                                             def run(self, iterations=None, callbacks: Optional[List[Callback]]=None, verbose=1, **kwargs):
   138                                                 r&#34;&#34;&#34;run upto :code:`iterations` with callbacks/logging.
   139
   140                                                 For a demonstration of callbacks see https://github.com/TomographicImaging/CIL-Demos/blob/main/misc/callback_demonstration.ipynb
   141
   142                                                 Parameters
   143                                                 -----------
   144                                                 iterations: int, default is None
   145                                                     Number of iterations to run. If not set the algorithm will run until :code:`should_stop()` is reached
   146                                                 callbacks: list of callables, default is Defaults to :code:`[ProgressCallback(verbose)]`
   147                                                     List of callables which are passed the current Algorithm object each iteration. Defaults to :code:`[ProgressCallback(verbose)]`.
   148                                                 verbose: 0=quiet, 1=info, 2=debug
   149                                                     Passed to the default callback to determine the verbosity of the printed output.
   150                                                 &#34;&#34;&#34;
   151
   152    888.7 MiB      0.0 MiB           1           if &#39;print_interval&#39; in kwargs:
   153                                                     warnings.warn(&#34;use `TextProgressCallback(miniters)` instead of `run(print_interval)`&#34;,
   154                                                          DeprecationWarning, stacklevel=2)
   155    888.7 MiB      0.0 MiB           1           if callbacks is None:
   156    888.7 MiB      0.0 MiB           1               callbacks = [ProgressCallback(verbose=verbose)]
   157
   158                                                 # transform old-style callbacks into new
   159    888.7 MiB      0.0 MiB           1           callback = kwargs.get(&#39;callback&#39;, None)
   160
   161    888.7 MiB      0.0 MiB           1           if callback is not None:
   162                                                     callbacks.append(_OldCallback(callback, verbose=verbose))
   163    888.7 MiB      0.0 MiB           1           if hasattr(self, &#39;__log_file&#39;):
   164                                                     callbacks.append(LogfileCallback(self.__log_file, verbose=verbose))
   165
   166    888.7 MiB      0.0 MiB           1           if self.should_stop():
   167                                                     print(&#34;Stop criterion has been reached.&#34;)
   168    888.7 MiB      0.0 MiB           1           if iterations is None:
   169                                                     warnings.warn(&#34;`run()` missing `iterations`&#34;, DeprecationWarning, stacklevel=2)
   170                                                     iterations = self.max_iteration
   171
   172    888.7 MiB      0.0 MiB           1           if self.iteration == -1 and self.update_objective_interval&gt;0:
   173    888.7 MiB      0.0 MiB           1               iterations+=1
   174
   175                                                 # call `__next__` upto `iterations` times or until `StopIteration` is raised
   176    888.7 MiB      0.0 MiB           1           self.max_iteration = self.iteration + iterations
   177
   178    888.7 MiB      0.0 MiB           2           iters = (count(self.iteration) if numpy.isposinf(self.max_iteration)
   179    888.7 MiB      0.0 MiB           1                    else range(self.iteration, self.max_iteration))
   180
   181    942.7 MiB     53.9 MiB           3           for _ in zip(iters, self):
   182    942.7 MiB      0.0 MiB           2               try:
   183    942.7 MiB      0.0 MiB           4                   for callback in callbacks:
   184    942.7 MiB      0.1 MiB           2                       callback(self)
   185                                                     except StopIteration:
   186                                                         break

</pre></div></div>
</div>
<p>We can see the increase of ~54 MB at the first iteration resulting from the line <code class="docutils literal notranslate"><span class="pre">self.operator.adjoint(self.u,</span> <span class="pre">out=self.tmp_domain)</span></code> which is also observed in the non-block version of LSQR:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_output_subset</span><span class="p">(</span><span class="n">lsqr_tik_prof</span><span class="p">,</span> <span class="s1">&#39;run 1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
run 1
Start of run | Memory Usage: 888.03 MB | line:

16 | Memory Usage: 888.03 MB | line: callbacks = [ProgressCallback(verbose=verbose)]

17 | Memory Usage: 888.03 MB | line: callback = kwargs.get(&#39;callback&#39;, None)

18 | Memory Usage: 888.03 MB | line: callbacks.append(_OldCallback(callback, verbose=verbose))

19 | Memory Usage: 888.03 MB | line: iterations = self.max_iteration

20 | Memory Usage: 888.03 MB | line: iterations+=1

21 | Memory Usage: 888.05 MB | line: self.max_iteration = self.iteration + iterations

22 | Memory Usage: 888.05 MB | line: iters = (count(self.iteration) if numpy.isposinf(self.max_iteration) else range(self.iteration, self.max_iteration))

23 | Memory Usage: 888.05 MB | line: update(self)

24 | Memory Usage: 888.18 MB | line: callback(self)

Start of update | Memory Usage: 888.18 MB | line:

Memory Usage Log (Time, Memory in MB): 16:00:11.557260, 941.89 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.567545, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.577777, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.587952, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.598127, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.608298, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.618444, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.628593, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.638785, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.649060, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.659228, 942.11 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.669382, 942.11 MB

25 | Memory Usage: 888.18 MB | line: self.operator.direct(self.v, out=self.tmp_range)

Memory Usage Log (Time, Memory in MB): 16:00:11.681125, 888.18 MB

26 | Memory Usage: 888.18 MB | line: self.tmp_range.sapyb(1.,  self.u,-self.alpha, out=self.u)

27 | Memory Usage: 888.17 MB | line: self.beta = self.u.norm()

Memory Usage Log (Time, Memory in MB): 16:00:11.691371, 888.17 MB

28 | Memory Usage: 888.17 MB | line: self.u /= self.beta

Memory Usage Log (Time, Memory in MB): 16:00:11.718584, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.728793, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.738955, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.749109, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.759262, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.769433, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.779634, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.789839, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.800049, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.810232, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.820399, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.830621, 888.17 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.840947, 899.95 MB

Memory Usage Log (Time, Memory in MB): 16:00:11.851269, 923.95 MB

29 | Memory Usage: 942.11 MB | line: self.operator.adjoint(self.u, out=self.tmp_domain)

Memory Usage Log (Time, Memory in MB): 16:00:11.861507, 942.11 MB

30 | Memory Usage: 942.11 MB | line: self.v.sapyb(-self.beta, self.tmp_domain, 1., out=self.v)

Memory Usage Log (Time, Memory in MB): 16:00:11.871839, 942.11 MB

31 | Memory Usage: 942.11 MB | line: self.alpha = self.v.norm()

32 | Memory Usage: 942.11 MB | line: self.v /= self.alpha

33 | Memory Usage: 942.11 MB | line: self.phibar = c1 * self.phibar

34 | Memory Usage: 942.11 MB | line: self.phibar = s * self.phibar

Memory Usage Log (Time, Memory in MB): 16:00:11.882094, 942.11 MB

35 | Memory Usage: 942.10 MB | line: self.x.sapyb(1, self.d, phi/rho, out=self.x)

Memory Usage Log (Time, Memory in MB): 16:00:11.892373, 942.10 MB

36 | Memory Usage: 942.09 MB | line: self.d.sapyb(-theta/rho, self.v, 1, out=self.d)

End of update | Memory Usage: 942.09 MB | line: self.normr = math.sqrt(self.phibar ** 2 + self.res2)

23 | Memory Usage: 942.09 MB | line: update(self)

24 | Memory Usage: 942.09 MB | line: callback(self)

End of run | Memory Usage: 942.09 MB | line:
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lsqr_tik_lp</span> <span class="o">=</span> <span class="n">line_peak_process</span><span class="p">(</span><span class="n">lsqr_tik_prof</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lsqr_tik_lp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: turquoise&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">204</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="s1">&#39;background-color: orange&#39;</span> <span class="k">if</span> <span class="mi">58</span> <span class="o">&gt;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;Total Memory Usage (MiB)&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style type="text/css">
#T_5baaf_row0_col4, #T_5baaf_row1_col4 {
  background-color: turquoise;
}
#T_5baaf_row2_col4, #T_5baaf_row3_col4 {
  background-color: orange;
}
</style>
<table id="T_5baaf">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_5baaf_level0_col0" class="col_heading level0 col0" >Method</th>
      <th id="T_5baaf_level0_col1" class="col_heading level0 col1" >Initial Memory Usage (MiB)</th>
      <th id="T_5baaf_level0_col2" class="col_heading level0 col2" >Peak Memory</th>
      <th id="T_5baaf_level0_col3" class="col_heading level0 col3" >Final Memory Usage (MiB)</th>
      <th id="T_5baaf_level0_col4" class="col_heading level0 col4" >Total Memory Usage (MiB)</th>
      <th id="T_5baaf_level0_col5" class="col_heading level0 col5" >Peak Memory Increase (MiB)</th>
      <th id="T_5baaf_level0_col6" class="col_heading level0 col6" >Peak Line</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_5baaf_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_5baaf_row0_col0" class="data row0 col0" >init</td>
      <td id="T_5baaf_row0_col1" class="data row0 col1" >0.00</td>
      <td id="T_5baaf_row0_col2" class="data row0 col2" >207.10</td>
      <td id="T_5baaf_row0_col3" class="data row0 col3" >207.10</td>
      <td id="T_5baaf_row0_col4" class="data row0 col4" >207.10</td>
      <td id="T_5baaf_row0_col5" class="data row0 col5" >207.10</td>
      <td id="T_5baaf_row0_col6" class="data row0 col6" >self.set_up(initial=initial, operator=operator, data=data)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_5baaf_row1_col0" class="data row1 col0" >setup</td>
      <td id="T_5baaf_row1_col1" class="data row1 col1" >0.00</td>
      <td id="T_5baaf_row1_col2" class="data row1 col2" >207.10</td>
      <td id="T_5baaf_row1_col3" class="data row1 col3" >207.10</td>
      <td id="T_5baaf_row1_col4" class="data row1 col4" >207.10</td>
      <td id="T_5baaf_row1_col5" class="data row1 col5" >207.10</td>
      <td id="T_5baaf_row1_col6" class="data row1 col6" >self.tmp_range = data.geometry.allocate(None)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_5baaf_row2_col0" class="data row2 col0" >run 1</td>
      <td id="T_5baaf_row2_col1" class="data row2 col1" >207.10</td>
      <td id="T_5baaf_row2_col2" class="data row2 col2" >261.18</td>
      <td id="T_5baaf_row2_col3" class="data row2 col3" >261.16</td>
      <td id="T_5baaf_row2_col4" class="data row2 col4" >54.06</td>
      <td id="T_5baaf_row2_col5" class="data row2 col5" >54.08</td>
      <td id="T_5baaf_row2_col6" class="data row2 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_5baaf_row3_col0" class="data row3 col0" >update 1</td>
      <td id="T_5baaf_row3_col1" class="data row3 col1" >207.25</td>
      <td id="T_5baaf_row3_col2" class="data row3 col2" >261.18</td>
      <td id="T_5baaf_row3_col3" class="data row3 col3" >261.16</td>
      <td id="T_5baaf_row3_col4" class="data row3 col4" >53.91</td>
      <td id="T_5baaf_row3_col5" class="data row3 col5" >53.93</td>
      <td id="T_5baaf_row3_col6" class="data row3 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_5baaf_row4_col0" class="data row4 col0" >run 2</td>
      <td id="T_5baaf_row4_col1" class="data row4 col1" >261.16</td>
      <td id="T_5baaf_row4_col2" class="data row4 col2" >315.17</td>
      <td id="T_5baaf_row4_col3" class="data row4 col3" >261.19</td>
      <td id="T_5baaf_row4_col4" class="data row4 col4" >0.03</td>
      <td id="T_5baaf_row4_col5" class="data row4 col5" >54.01</td>
      <td id="T_5baaf_row4_col6" class="data row4 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_5baaf_row5_col0" class="data row5 col0" >update 2</td>
      <td id="T_5baaf_row5_col1" class="data row5 col1" >261.16</td>
      <td id="T_5baaf_row5_col2" class="data row5 col2" >315.17</td>
      <td id="T_5baaf_row5_col3" class="data row5 col3" >261.19</td>
      <td id="T_5baaf_row5_col4" class="data row5 col4" >0.03</td>
      <td id="T_5baaf_row5_col5" class="data row5 col5" >54.01</td>
      <td id="T_5baaf_row5_col6" class="data row5 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_5baaf_row6_col0" class="data row6 col0" >run 3</td>
      <td id="T_5baaf_row6_col1" class="data row6 col1" >261.19</td>
      <td id="T_5baaf_row6_col2" class="data row6 col2" >315.19</td>
      <td id="T_5baaf_row6_col3" class="data row6 col3" >261.23</td>
      <td id="T_5baaf_row6_col4" class="data row6 col4" >0.04</td>
      <td id="T_5baaf_row6_col5" class="data row6 col5" >54.00</td>
      <td id="T_5baaf_row6_col6" class="data row6 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_5baaf_row7_col0" class="data row7 col0" >update 3</td>
      <td id="T_5baaf_row7_col1" class="data row7 col1" >261.19</td>
      <td id="T_5baaf_row7_col2" class="data row7 col2" >315.19</td>
      <td id="T_5baaf_row7_col3" class="data row7 col3" >261.23</td>
      <td id="T_5baaf_row7_col4" class="data row7 col4" >0.04</td>
      <td id="T_5baaf_row7_col5" class="data row7 col5" >54.00</td>
      <td id="T_5baaf_row7_col6" class="data row7 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_5baaf_row8_col0" class="data row8 col0" >run 4</td>
      <td id="T_5baaf_row8_col1" class="data row8 col1" >261.23</td>
      <td id="T_5baaf_row8_col2" class="data row8 col2" >315.23</td>
      <td id="T_5baaf_row8_col3" class="data row8 col3" >261.27</td>
      <td id="T_5baaf_row8_col4" class="data row8 col4" >0.04</td>
      <td id="T_5baaf_row8_col5" class="data row8 col5" >54.00</td>
      <td id="T_5baaf_row8_col6" class="data row8 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row9" class="row_heading level0 row9" >9</th>
      <td id="T_5baaf_row9_col0" class="data row9 col0" >update 4</td>
      <td id="T_5baaf_row9_col1" class="data row9 col1" >261.23</td>
      <td id="T_5baaf_row9_col2" class="data row9 col2" >315.23</td>
      <td id="T_5baaf_row9_col3" class="data row9 col3" >261.27</td>
      <td id="T_5baaf_row9_col4" class="data row9 col4" >0.04</td>
      <td id="T_5baaf_row9_col5" class="data row9 col5" >54.00</td>
      <td id="T_5baaf_row9_col6" class="data row9 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row10" class="row_heading level0 row10" >10</th>
      <td id="T_5baaf_row10_col0" class="data row10 col0" >run 5</td>
      <td id="T_5baaf_row10_col1" class="data row10 col1" >261.27</td>
      <td id="T_5baaf_row10_col2" class="data row10 col2" >315.27</td>
      <td id="T_5baaf_row10_col3" class="data row10 col3" >261.30</td>
      <td id="T_5baaf_row10_col4" class="data row10 col4" >0.03</td>
      <td id="T_5baaf_row10_col5" class="data row10 col5" >54.00</td>
      <td id="T_5baaf_row10_col6" class="data row10 col6" >update(self)</td>
    </tr>
    <tr>
      <th id="T_5baaf_level0_row11" class="row_heading level0 row11" >11</th>
      <td id="T_5baaf_row11_col0" class="data row11 col0" >update 5</td>
      <td id="T_5baaf_row11_col1" class="data row11 col1" >261.27</td>
      <td id="T_5baaf_row11_col2" class="data row11 col2" >315.27</td>
      <td id="T_5baaf_row11_col3" class="data row11 col3" >261.30</td>
      <td id="T_5baaf_row11_col4" class="data row11 col4" >0.03</td>
      <td id="T_5baaf_row11_col5" class="data row11 col5" >54.00</td>
      <td id="T_5baaf_row11_col6" class="data row11 col6" >self.operator.direct(self.v, out=self.tmp_range)</td>
    </tr>
  </tbody>
</table></div>
</div>
<div class="line-block">
<div class="line">The graphs below show the memory usage trends across the method calls.</div>
<div class="line">LSQR Tikhonov has the lowest setup and peak memory usages of the algorithms, as the input data was smaller in size.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_mem</span><span class="p">(</span><span class="n">dfs</span><span class="o">=</span><span class="p">(</span><span class="n">cgls_block_lp</span><span class="p">,</span> <span class="n">lsqr_block_lp</span><span class="p">,</span> <span class="n">lsqr_tik_lp</span><span class="p">),</span> <span class="n">algNms</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;CGLS Block&quot;</span><span class="p">,</span> <span class="s2">&quot;LSQR Block&quot;</span><span class="p">,</span> <span class="s2">&quot;LSQR Tik&quot;</span><span class="p">),</span> <span class="n">linestyles</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_memory_profiling_sandstone_100_0.png" src="../../_images/demos_memory_profiling_sandstone_100_0.png" />
</div>
</div>
<p style="font-size:14px; color:#086bb8;"><p>Figure 7: This graph shows the memory usages before (initial), during (peak) and after (final) the ‘init’ and ‘run’ methods in CGLS Block (Blue), LSQR Block (Orange) and LSQR Tikhonov (Green). The first two points show the memory increases during ‘init’, which remain stable. In ‘run (iteration)
1<code class="docutils literal notranslate"><span class="pre">,</span> <span class="pre">CGLS</span> <span class="pre">Block</span> <span class="pre">and</span> <span class="pre">LSQR</span> <span class="pre">Block</span> <span class="pre">show</span> <span class="pre">a</span> <span class="pre">peak,</span> <span class="pre">which</span> <span class="pre">then</span> <span class="pre">drops</span> <span class="pre">down</span> <span class="pre">slightly.</span> <span class="pre">The</span> <span class="pre">graph</span> <span class="pre">shows</span> <span class="pre">a</span> <span class="pre">net</span> <span class="pre">increase</span> <span class="pre">in</span> <span class="pre">memory</span> <span class="pre">usage</span> <span class="pre">at</span> <span class="pre">the</span> <span class="pre">end</span> <span class="pre">of</span> <span class="pre">'run</span> <span class="pre">1'.</span>&#160;&#160;&#160;&#160; <span class="pre">LSQR</span> <span class="pre">Tikhonov</span> <span class="pre">shows</span> <span class="pre">a</span> <span class="pre">net</span> <span class="pre">increase</span> <span class="pre">in</span> <span class="pre">memory</span> <span class="pre">usage</span> <span class="pre">in</span></code>run 1` too, without a peak. The spikes during each subsequent run show that the memory usage reaches a peak, and then drops back down, resulting in a net increase of ~0 MB. This is consistent across all ‘run’ calls (iterations). Amongst these three algorithms, LSQR Block uses the most
memory, and LSQR Tikhonov uses the least.</p>
</p></section>
</section>
<section id="Conclusion:">
<h2>Conclusion:<a class="headerlink" href="#Conclusion:" title="Link to this heading">#</a></h2>
<p>In this notebook, we showed:</p>
<ul class="simple">
<li><p>LSQR and CGLS produce very similar residuals, and perform similarly with respect to iteration time</p></li>
<li><p>The simple version of CGLS uses less memory than LSQR</p></li>
<li><p>LSQR and CGLS Block, and LSQR Tikhonov produce very similar residuals, and show similar iteration times</p></li>
<li><p>LSQR Tikhonov will use the same memory as regular LSQR</p></li>
<li><p>LSQR Tikhonov has the benefit of a regularisation term, which means that there is less likelihood of overfitting to the noise</p></li>
<li><p>The profiling data tells us where the memory usage comes from, and places it could be optimised</p></li>
<li><p>There may be some room to optimise peak memory usage, e.g. in the <code class="docutils literal notranslate"><span class="pre">ProjectionOperator</span></code> code</p></li>
</ul>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../Simulation_and_CPU_reconstruction/"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Simulation using gVXR and CPU reconstruction using CIL of a twisted hexagonal object with helical flow channels</p>
      </div>
    </a>
    <a class="right-next"
       href="../fista_with_denoiser/"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">A CIL-pytorch example using DeepInverse using a pre-trained denoiser in the CIL FISTA algorithm</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=085432a65528ed429d34"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=085432a65528ed429d34"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2017-2024.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>