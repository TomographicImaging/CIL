
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>CIL Callbacks How To &#8212; CIL 24.3.1.dev13+g28b92b02 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=f9003edd7fb0eec021ef" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=f9003edd7fb0eec021ef" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=f9003edd7fb0eec021ef"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=f9003edd7fb0eec021ef" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=f9003edd7fb0eec021ef" />

    <script src="../../_static/documentation_options.js?v=5d68c828"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'demos/callback_demonstration';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.2dev0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = '/CIL/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '24.3.1.dev13+g28b92b02';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <script>DOCUMENTATION_OPTIONS.search_as_you_type = false;</script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="prev" title="1D inverse problem demo using deriv2 from regtools" href="../deriv2_cgls/" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="24.3.1.dev13+g28b92b02" />
  
    
    <script src="../../_static/searchtools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../searchindex.js"></script>
  
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
     
  

<a class="navbar-brand logo" href="/">
  
  
  
  
  
    
    
      
    
    
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB.svg" class="logo__image only-light" alt="CIL - Home"/>
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB-reversed.svg" class="logo__image only-dark pst-js-only" alt="CIL - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer_guide/">
    Developers’ Guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" current active">
  <a class="nav-link dropdown-item nav-internal" href="../">
    Tutorials
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer_guide/">
    Developers’ Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../">
    Tutorials
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        <div class="sidebar-primary-item">
<h3><a href="../../">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../framework/">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/">Read/ write AcquisitionData and ImageData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimisation/">Optimisation framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimisation/#block-framework">Block Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../processors/">Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recon/">Recon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities/">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/">CIL Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/">Developers’ Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#load-and-visualise-data">Load and visualise data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#geometry">Geometry</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#advanced-topics">Advanced topics</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../deriv2_cgls/">1D inverse problem demo using deriv2 from regtools</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">CIL Callbacks How To</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
        <div class="sidebar-primary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/TomographicImaging/CIL/edit/master/docs/source/demos/callback_demonstration.ipynb">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">CIL Callbacks How To</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#  Copyright 2024 -  United Kingdom Research and Innovation</span>
<span class="c1">#  Copyright 2024 -  The University of Manchester</span>
<span class="c1">#</span>
<span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#  you may not use this file except in compliance with the License.</span>
<span class="c1">#  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#  See the License for the specific language governing permissions and</span>
<span class="c1">#  limitations under the License.</span>
<span class="c1">#</span>
<span class="c1">#   Authored by:    Margaret Duff (STFC - UKRI)</span>
<span class="c1">#                   Laura Murgatroyd (STFC - UKRI)</span>
</pre></div>
</div>
</div>
<section id="CIL-Callbacks-How-To">
<h1>CIL Callbacks How To<a class="headerlink" href="#CIL-Callbacks-How-To" title="Link to this heading">#</a></h1>
<p>Callbacks are an essential tool in many optimization frameworks, providing a flexible way to monitor and control the execution of algorithms. Similar to popular packages such as <code class="docutils literal notranslate"><span class="pre">`keras</span></code> &lt;<a class="reference external" href="https://keras.io/api/callbacks/">https://keras.io/api/callbacks/</a>&gt;`__, <code class="docutils literal notranslate"><span class="pre">`scipy</span></code> &lt;<a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize">https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize</a>&gt;`__, and <code class="docutils literal notranslate"><span class="pre">`pytorch</span></code> &lt;<a class="reference external" href="https://pytorch.org/tnt/stable/framework/callbacks.html">https://pytorch.org/tnt/stable/framework/callbacks.html</a>&gt;`__, CIL utilizes callbacks that can be passed to the <code class="docutils literal notranslate"><span class="pre">run</span></code> method of an
algorithm. These callbacks have access to the entire state of the algorithm, allowing them to perform a wide range of tasks—from logging and saving progress to implementing early stopping conditions. By integrating callbacks, users can enhance the flexibility, efficiency, and functionality of their algorithms.</p>
<p>In this demo, we explore the default behavior of callbacks in CIL and present a variety of example callbacks that can be customized to suit your needs. New callbacks are regularly added to CIL based on user requests, so be sure to check out the <a class="reference external" href="https://tomographicimaging.github.io/CIL/nightly/optimisation/#callbacks">documentation</a> for the latest updates.</p>
<section id="Install-CIL-and-set-some-defaults">
<h2>Install CIL and set some defaults<a class="headerlink" href="#Install-CIL-and-set-some-defaults" title="Link to this heading">#</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cil.utilities.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">show2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.recon</span><span class="w"> </span><span class="kn">import</span> <span class="n">FDK</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.processors</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransmissionAbsorptionConverter</span><span class="p">,</span> <span class="n">Slicer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.plugins.tigre</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProjectionOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.algorithms</span><span class="w"> </span><span class="kn">import</span> <span class="n">FISTA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LeastSquares</span><span class="p">,</span>  <span class="n">TotalVariation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">callbacks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataContainer</span>


<span class="c1"># set up default colour map for visualisation</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span>

<span class="c1"># set the backend for FBP and the ProjectionOperator</span>
<span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;gpu&#39;</span>
</pre></div>
</div>
</div>
</section>
<section id="Load-Data">
<h2>Load Data<a class="headerlink" href="#Load-Data" title="Link to this heading">#</a></h2>
<p>In this example, we utilize CIL’s simulated sphere data. To accelerate computations in this notebook, we extract a 2D slice from the 3D dataset. Additionally, we select a subset of angles to create a limited-angle reconstruction scenario. We will then compare the ground truth data with a filtered back projection (FBP) reconstruction under these limited-angle conditions.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cil.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataexample</span>
<span class="c1"># Load data</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">dataexample</span><span class="o">.</span><span class="n">SIMULATED_SPHERE_VOLUME</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">dataexample</span><span class="o">.</span><span class="n">SIMULATED_CONE_BEAM_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<span class="c1"># Consider just a single 2D slice</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">vertical</span><span class="o">=</span><span class="s1">&#39;centre&#39;</span><span class="p">)</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">vertical</span><span class="o">=</span><span class="s1">&#39;centre&#39;</span><span class="p">)</span>

<span class="n">absorption</span> <span class="o">=</span> <span class="n">TransmissionAbsorptionConverter</span><span class="p">()(</span><span class="n">data</span><span class="p">)</span>
<span class="n">absorption</span> <span class="o">=</span> <span class="n">Slicer</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;angle&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)})(</span><span class="n">absorption</span><span class="p">)</span>

<span class="n">ig</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">geometry</span>

<span class="n">recon</span> <span class="o">=</span> <span class="n">FDK</span><span class="p">(</span><span class="n">absorption</span><span class="p">,</span> <span class="n">image_geometry</span><span class="o">=</span><span class="n">ig</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">recon</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">,</span> <span class="s1">&#39;FDK Reconstruction&#39;</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Default-Behavior">
<h2>Default Behavior<a class="headerlink" href="#Default-Behavior" title="Link to this heading">#</a></h2>
<p>When no callback is passed to the <code class="docutils literal notranslate"><span class="pre">run</span></code> method, a progress bar is automatically displayed. This progress bar provides useful information, including the time elapsed, estimated time remaining, iterations per second, and the current objective value. Keep in mind that the current objective value updates at intervals determined by the <code class="docutils literal notranslate"><span class="pre">update_objective_interval</span></code> parameter set in the algorithm.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">ProjectionOperator</span><span class="p">(</span><span class="n">image_geometry</span><span class="o">=</span><span class="n">ig</span><span class="p">,</span>
                       <span class="n">acquisition_geometry</span><span class="o">=</span><span class="n">absorption</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>

<span class="n">F</span> <span class="o">=</span> <span class="n">LeastSquares</span><span class="p">(</span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">absorption</span><span class="p">)</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">TotalVariation</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">algo</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">algo</span><span class="o">.</span><span class="n">solution</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">,</span> <span class="s1">&#39; Limited Angle FDK Reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;TV solution&#39;</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Available-CIL-Callbacks">
<h2>Available CIL Callbacks<a class="headerlink" href="#Available-CIL-Callbacks" title="Link to this heading">#</a></h2>
<p>Callbacks in CIL are provided as a list to the <code class="docutils literal notranslate"><span class="pre">run</span></code> method of an algorithm. In this example, we use two built-in CIL callbacks: <code class="docutils literal notranslate"><span class="pre">callbacks.ProgressCallback()</span></code> and <code class="docutils literal notranslate"><span class="pre">callbacks.TextProgressCallback()</span></code>. The first is the default callback that displays a progress bar, as demonstrated earlier. The second, <code class="docutils literal notranslate"><span class="pre">callbacks.TextProgressCallback()</span></code>, prints progress updates at intervals specified by <code class="docutils literal notranslate"><span class="pre">update_objective_interval</span></code>.</p>
<p>It’s important to note that if you don’t pass any callbacks, the default behavior is to display the progress bar. However, if you choose to include other callbacks and still want the progress bar, you must explicitly include <code class="docutils literal notranslate"><span class="pre">callbacks.ProgressCallback()</span></code> in your list.</p>
<p>Each callback is run at each iteration, after any <code class="docutils literal notranslate"><span class="pre">update</span></code> step is taken. In the following example, due to the design of the callback, the display is only updated and/or printed every <code class="docutils literal notranslate"><span class="pre">update_objective_interval</span></code> but the callback is still called at each iteration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">algo</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cb1</span><span class="o">=</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ProgressCallback</span><span class="p">()</span>
<span class="n">cb2</span><span class="o">=</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TextProgressCallback</span><span class="p">()</span>
<span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">cb1</span><span class="p">,</span> <span class="n">cb2</span><span class="p">])</span>
<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">algo</span><span class="o">.</span><span class="n">solution</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">,</span> <span class="s1">&#39;FDK Reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;TV solution&#39;</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>When you call the algorithm’s <code class="docutils literal notranslate"><span class="pre">run</span></code> method again, it resumes from where it left off. To start fresh, you should redefine both the algorithm and the callbacks.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">cb1</span><span class="p">,</span> <span class="n">cb2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="Early-Stopping-(Custom-Callback-Example)">
<h2>Early Stopping (Custom Callback Example)<a class="headerlink" href="#Early-Stopping-(Custom-Callback-Example)" title="Link to this heading">#</a></h2>
<p>To create your own callback, define a class with a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method. It’s a good practice to subclass the CIL <code class="docutils literal notranslate"><span class="pre">callbacks.Callback</span></code> class. The <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method should take <code class="docutils literal notranslate"><span class="pre">self</span></code> and <code class="docutils literal notranslate"><span class="pre">algorithm</span></code> as arguments, where <code class="docutils literal notranslate"><span class="pre">algorithm</span></code> is an initialized CIL algorithm. This allows the callback to access and utilize any properties stored within the algorithm.</p>
<p>In this example, the callback raises a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception if a specified stopping criterion is met, forcing the algorithm to terminate early. In this basic case, it stops if the algorithm objective is less than 0.2. You can see that the algorithm does not run for the full 500 iterations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EarlyStoppingObjective</span><span class="p">(</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>

         <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">):</span>
               <span class="k">if</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">objective</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">2e-1</span><span class="p">:</span>  <span class="c1"># arbitrary stopping criterion</span>
                  <span class="k">raise</span> <span class="ne">StopIteration</span>

<span class="n">algo</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TextProgressCallback</span><span class="p">(),</span> <span class="n">EarlyStoppingObjective</span><span class="p">()])</span>
<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">algo</span><span class="o">.</span><span class="n">solution</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">,</span> <span class="s1">&#39;FDK Reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;TV solution&#39;</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>In another early stopping example, the algorithm terminates when the current solution approaches a given reference image. This example demonstrates a callback that accepts arguments upon initialization, allowing for more flexible and customized stopping criteria. It terminates when the mean square difference between the current solution and a provided reference image is equal to or less than a provided tolerance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EarlyStoppingReference</span><span class="p">(</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Terminates the algorithm when the mean square difference between the current solution and a provided reference image is equal to or less than a provided tolerance.</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>

<span class="sd">      ref_img: ImageData</span>
<span class="sd">            The image to compare the iterates to. The algorithm will terminate if the current solution satisfies :math:`\frac{1}{N}||x-ref_img||_2^2&lt;tol`, where :math:`N` is the number of pixels in the image.</span>
<span class="sd">      tolerance: float, default 1e-8</span>
<span class="sd">            A small value which determines the sensitivity of this stopping criterion. The algorithm will terminate if the current solution satisfies :math:`\frac{1}{N}||x-ref_img||_2^2&lt;tol`, where :math:`N` is the number of pixels in the image.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_img</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">=</span><span class="n">ref_img</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="o">=</span><span class="n">tolerance</span>
      <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">algorithm</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">array</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">array</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">:</span>
                  <span class="k">raise</span> <span class="ne">StopIteration</span>

<span class="n">algo</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cb</span><span class="o">=</span><span class="n">EarlyStoppingReference</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="mf">3e-8</span><span class="p">)</span>
<span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TextProgressCallback</span><span class="p">(),</span><span class="n">cb</span> <span class="p">])</span>
<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">algo</span><span class="o">.</span><span class="n">solution</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">,</span> <span class="s1">&#39;FDK Reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;TV solution&#39;</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Calculating-Data-Discrepancy-at-Each-Iteration-(Custom-Callback-Example)">
<h2>Calculating Data Discrepancy at Each Iteration (Custom Callback Example)<a class="headerlink" href="#Calculating-Data-Discrepancy-at-Each-Iteration-(Custom-Callback-Example)" title="Link to this heading">#</a></h2>
<p>In this example, a custom metric —specifically a least squares data discrepancy calculation— is computed at the end of each iteration and stored within the callback. We demonstrate how to initialize two callbacks to save the results from two different methods: FISTA with TV, with and without non-negativity enforced. The results are then plotted for comparison.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LeastSquaresCallback</span><span class="p">(</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    A : Operator</span>
<span class="sd">      The forward operator for the least squares calculation</span>
<span class="sd">    data: DataContainer</span>
<span class="sd">      Acquisition data for the least squares calculation</span>

<span class="sd">    Properties</span>
<span class="sd">    ----------</span>
<span class="sd">    save_values: list of floats</span>
<span class="sd">      The saved least squares calculation, one per iteration</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">LeastSquares</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_values</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">algorithm</span><span class="o">.</span><span class="n">get_output</span><span class="p">()))</span>

<span class="n">mycallback_FISTA_lower_bound</span><span class="o">=</span> <span class="n">LeastSquaresCallback</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">absorption</span><span class="p">)</span>
<span class="n">algo1</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">alpha</span><span class="o">*</span><span class="n">TotalVariation</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">algo1</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">mycallback_FISTA_lower_bound</span><span class="p">])</span>


<span class="n">mycallback_FISTA_no_lower_bound</span><span class="o">=</span> <span class="n">LeastSquaresCallback</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">absorption</span><span class="p">)</span>
<span class="n">algo2</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">alpha</span><span class="o">*</span><span class="n">TotalVariation</span><span class="p">(),</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">algo2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">mycallback_FISTA_no_lower_bound</span><span class="p">])</span>


<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">algo1</span><span class="o">.</span><span class="n">get_output</span><span class="p">(),</span> <span class="n">algo2</span><span class="o">.</span><span class="n">get_output</span><span class="p">()],</span> <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;FISTA TV with non-negativity &#39;</span><span class="p">,</span> <span class="s1">&#39;FISTA TV without non-negativity &#39;</span><span class="p">],</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">show2D</span><span class="p">([</span><span class="n">absorption</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">direct</span><span class="p">(</span><span class="n">algo1</span><span class="o">.</span><span class="n">get_output</span><span class="p">())</span><span class="o">-</span><span class="n">absorption</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">direct</span><span class="p">(</span><span class="n">algo2</span><span class="o">.</span><span class="n">get_output</span><span class="p">())</span><span class="o">-</span><span class="n">absorption</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;Data error FISTA TV with non-negativity&#39;</span><span class="p">,</span> <span class="s1">&#39;Data error FISTA TV without non-negativity&#39;</span><span class="p">],</span> <span class="n">fix_range</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="s1">&#39;seismic&#39;</span><span class="p">],</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">501</span><span class="p">),</span> <span class="n">mycallback_FISTA_lower_bound</span><span class="o">.</span><span class="n">save_values</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;FISTA TV with non-negativity &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">501</span><span class="p">),</span> <span class="n">mycallback_FISTA_no_lower_bound</span><span class="o">.</span><span class="n">save_values</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;FISTA TV without with non-negativity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Data discrepancy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>We see that the without the non-negativity, the reconstruction overfits to the noisy absorption data.</p>
</section>
<section id="Calculating-a-Noise-Approximation-for-Each-Iteration-(Custom-Callback-Example)">
<h2>Calculating a Noise Approximation for Each Iteration (Custom Callback Example)<a class="headerlink" href="#Calculating-a-Noise-Approximation-for-Each-Iteration-(Custom-Callback-Example)" title="Link to this heading">#</a></h2>
<p>In this example, we define a custom callback that saves the values of a wavelet-based estimator of Gaussian noise standard deviation, provided by <code class="docutils literal notranslate"><span class="pre">skimage</span></code>, at each iteration. Using TV regularization and a FISTA optimization algorithm with non-negativity, we compare how the noise level in the solution changes for two different regularization parameters: a small value (0.1) and a larger value (1).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">skimage</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SigmaEstimateCallback</span><span class="p">(</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Properties</span>
<span class="sd">    ----------</span>
<span class="sd">    save_values: list of floats</span>
<span class="sd">      The saved sigma calculation, one per iteration</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_values</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skimage</span><span class="o">.</span><span class="n">restoration</span><span class="o">.</span><span class="n">estimate_sigma</span><span class="p">(</span><span class="n">algorithm</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span><span class="o">.</span><span class="n">as_array</span><span class="p">()))</span>

<span class="n">mycallback_FISTA_TV_alpha_01</span><span class="o">=</span> <span class="n">SigmaEstimateCallback</span><span class="p">()</span>
<span class="n">algo1</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">TotalVariation</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">algo1</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">mycallback_FISTA_TV_alpha_01</span><span class="p">])</span>


<span class="n">mycallback_FISTA_TV_alpha_1</span><span class="o">=</span> <span class="n">SigmaEstimateCallback</span><span class="p">()</span>
<span class="n">algo2</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">TotalVariation</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">algo2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">mycallback_FISTA_TV_alpha_1</span><span class="p">])</span>


<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">algo1</span><span class="o">.</span><span class="n">get_output</span><span class="p">(),</span> <span class="n">algo2</span><span class="o">.</span><span class="n">get_output</span><span class="p">()],</span> <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;FISTA_TV_alpha_01&#39;</span><span class="p">,</span> <span class="s1">&#39;FISTA_TV_alpha_1&#39;</span><span class="p">],</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">show2D</span><span class="p">([</span><span class="n">absorption</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">direct</span><span class="p">(</span><span class="n">algo1</span><span class="o">.</span><span class="n">get_output</span><span class="p">())</span><span class="o">-</span><span class="n">absorption</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">direct</span><span class="p">(</span><span class="n">algo2</span><span class="o">.</span><span class="n">get_output</span><span class="p">())</span><span class="o">-</span><span class="n">absorption</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ground_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;Data error FISTA_TV_alpha_01&#39;</span><span class="p">,</span> <span class="s1">&#39;Data error FISTA_TV_alpha_1&#39;</span><span class="p">],</span> <span class="n">fix_range</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="s1">&#39;seismic&#39;</span><span class="p">],</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">501</span><span class="p">),</span> <span class="n">mycallback_FISTA_TV_alpha_01</span><span class="o">.</span><span class="n">save_values</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;FISTA TV alpha=0.1 &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">501</span><span class="p">),</span> <span class="n">mycallback_FISTA_TV_alpha_1</span><span class="o">.</span><span class="n">save_values</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;FISTA TV alpha=1.0 &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Noise Estimate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>We see with a larger regularisation parameter, the resulting image is less noisy.</p>
</section>
<section id="Image-metric-callbacks-(complex-custom-callback-example)">
<h2>Image metric callbacks (complex custom callback example)<a class="headerlink" href="#Image-metric-callbacks-(complex-custom-callback-example)" title="Link to this heading">#</a></h2>
<p>We now move on to some more complex callbacks. In this callback, a dictionary of metrics are calculated and printed each <code class="docutils literal notranslate"><span class="pre">print_interval</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MetricsDiagnostics</span><span class="p">(</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    reference_image: CIL or STIR ImageData</span>
<span class="sd">      containing the reference image used to calculate the metrics</span>

<span class="sd">    metrics_dict : dictionary of lambda functions f(x,y) mapping</span>
<span class="sd">      two 1-dimensional numpy arrays x and y to a scalar value or a</span>
<span class="sd">      numpy.ndarray.</span>
<span class="sd">      x and y are the voxel values of the whole image.</span>
<span class="sd">      E.g. f(x,y) could be MSE(x,y), PSNR(x,y), MAE(x,y)</span>

<span class="sd">    print_interval: positive integer</span>
<span class="sd">        The results are calculated and printed every `print_interval` number of iterations</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_image</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">,</span> <span class="n">print_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span> <span class="o">=</span> <span class="n">reference_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_dict</span> <span class="o">=</span> <span class="n">metrics_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computed_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_interval</span><span class="o">=</span><span class="n">print_interval</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">MetricsDiagnostics</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algo</span><span class="p">):</span>


        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">algo</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">algo</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="p">[])</span>

            <span class="n">metric_list</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">algo</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>
            <span class="n">metric_value</span> <span class="o">=</span> <span class="n">metric_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">,</span> <span class="n">algo</span><span class="o">.</span><span class="n">get_output</span><span class="p">())</span>
            <span class="n">metric_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">computed_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">algo</span><span class="o">.</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_header</span><span class="p">())</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_iteration</span><span class="p">())</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">callback_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&gt;20}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">callback_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">computed_metrics</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Handle list of metrics</span>
            <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&gt;20.5e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computed_metrics</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_dict</span><span class="p">):])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle single metric</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{:&gt;20.5e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">computed_metrics</span><span class="p">)</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">cil.utilities.quality_measures</span><span class="w"> </span><span class="kn">import</span> <span class="n">mae</span><span class="p">,</span> <span class="n">psnr</span><span class="p">,</span> <span class="n">mse</span>
<span class="n">metric_callback</span><span class="o">=</span> <span class="n">MetricsDiagnostics</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MSE&#39;</span><span class="p">:</span><span class="n">mse</span><span class="p">,</span> <span class="s1">&#39;MAE&#39;</span><span class="p">:</span><span class="n">mae</span><span class="p">,</span> <span class="s1">&#39;PSNR&#39;</span><span class="p">:</span><span class="n">psnr</span><span class="p">})</span>
<span class="n">algo</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">metric_callback</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="Image-metric-callbacks-with-region-of-interest-(complex-custom-callback-example)">
<h2>Image metric callbacks with region of interest (complex custom callback example)<a class="headerlink" href="#Image-metric-callbacks-with-region-of-interest-(complex-custom-callback-example)" title="Link to this heading">#</a></h2>
<p>For another complex example. This callback takes a reference image, region of interest mask and a dictionary of metrics and a dictionary of statistics to evaluate at each iteration. We define some regions of interest and then can plot the metrics for the different regions of interest. For more information on the metrics in CIL see the documentation: <a class="reference external" href="https://tomographicimaging.github.io/CIL/nightly/utilities/#module-cil.utilities.quality_measures">https://tomographicimaging.github.io/CIL/nightly/utilities/#module-cil.utilities.quality_measures</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ImageQualityCallback</span><span class="p">(</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    reference_image: CIL or STIR ImageData</span>
<span class="sd">      containing the reference image used to calculate the metrics</span>

<span class="sd">    roi_mask_dict : dictionary of ImageData objects. Optional - default is None</span>
<span class="sd">      list containing one binary ImageData object for every ROI to be</span>
<span class="sd">      evaluated. Voxels with values 1 are considered part of the ROI</span>
<span class="sd">      and voxels with value 0 are not.</span>
<span class="sd">      Dimension of the ROI mask images must be the same as the dimension of</span>
<span class="sd">      the reference image.</span>

<span class="sd">    metrics_dict : dictionary of lambda functions f(x,y) mapping</span>
<span class="sd">      two 1-dimensional numpy arrays x and y to a scalar value or a</span>
<span class="sd">      numpy.ndarray. Optional - default is None.</span>
<span class="sd">        x and y can be the voxel values of the whole images or the values of</span>
<span class="sd">        voxels in a ROI such that the metric can be computed on the whole</span>
<span class="sd">        images and optionally in the ROIs separately.</span>
<span class="sd">        E.g. f(x,y) could be MSE(x,y), PSNR(x,y), MAE(x,y)</span>

<span class="sd">    statistics_dict : dictionary of lambda functions f(x) mapping a</span>
<span class="sd">      1-dimensional numpy array x to a scalar value or a numpy.ndarray. Optional - default is None</span>
<span class="sd">        E.g. mean(x), std_deviation(x) that calculate global and / or</span>
<span class="sd">        ROI mean and standard deviations.</span>

<span class="sd">    Properties</span>
<span class="sd">    ----------</span>
<span class="sd">    metric_store: dictionary</span>
<span class="sd">      The keys of the dictionary are &quot;global_&quot;+metric keys or roi key +&#39;_&#39;+ metric key. Stored under these keys is a list of calculations of the metric for that roi, one per iteration.</span>

<span class="sd">    stat_store: dictionary</span>
<span class="sd">      The keys of the dictionary are &quot;global_&quot;+statistic keys or roi key +&#39;_&#39;+ statistic key. Stored under these keys is a list of calculations of the statistic for that roi, one per iteration.</span>

<span class="sd">      &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_image</span><span class="p">,</span>
                 <span class="n">roi_mask_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">metrics_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">statistics_dict</span><span class="o">=</span><span class="kc">None</span>
                 <span class="p">):</span>

        <span class="c1"># the reference image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span> <span class="o">=</span> <span class="n">reference_image</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">roi_indices_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_store</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">roi_mask_dict</span> <span class="o">=</span> <span class="n">roi_mask_dict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_dict</span> <span class="o">=</span> <span class="n">metrics_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_store</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_store</span><span class="p">[</span><span class="s1">&#39;global_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">roi_mask_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">roi_name</span> <span class="ow">in</span> <span class="n">roi_mask_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics_store</span><span class="p">[</span><span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span> <span class="o">=</span> <span class="n">statistics_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_store</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stat_store</span><span class="p">[</span><span class="s1">&#39;global_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">roi_mask_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">roi_name</span> <span class="ow">in</span> <span class="n">roi_mask_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stat_store</span><span class="p">[</span><span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics_store</span><span class="p">[</span><span class="s1">&#39;global_&#39;</span><span class="o">+</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">roi_name</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_mask_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">roi</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics_store</span><span class="p">[</span><span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">statistic_name</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">stat</span><span class="p">(</span><span class="n">algorithm</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">_NoValue</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stat_store</span><span class="p">[</span><span class="s1">&#39;global_&#39;</span><span class="o">+</span><span class="n">statistic_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">roi_name</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_mask_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="n">stat</span><span class="p">(</span><span class="n">algorithm</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">roi</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stat_store</span><span class="p">[</span><span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">statistic_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For this data we take one region of interest to be the brightest spheres, another region of interest the darkest spheres. We define the masks for this in the next cell:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brightest</span> <span class="o">=</span> <span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">darkest</span> <span class="o">=</span> <span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">brightest</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
               <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="p">)</span>
<span class="n">darkest</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">array</span> <span class="o">&lt;</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
               <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="p">)</span>



<span class="n">roi_image_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;brightest&#39;</span> <span class="p">:</span> <span class="n">brightest</span><span class="p">,</span>
    <span class="s1">&#39;darkest&#39;</span> <span class="p">:</span> <span class="n">darkest</span>
<span class="p">}</span>

<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">brightest</span><span class="p">,</span> <span class="n">darkest</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Ground truth&quot;</span><span class="p">,</span> <span class="s2">&quot;Brightest sphere mask&quot;</span><span class="p">,</span> <span class="s2">&quot;Darkest sphere mask&quot;</span><span class="p">],</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cil.utilities.quality_measures</span><span class="w"> </span><span class="kn">import</span> <span class="n">mae</span><span class="p">,</span> <span class="n">psnr</span><span class="p">,</span> <span class="n">mse</span>
<span class="n">img_qual_callback</span> <span class="o">=</span> <span class="n">ImageQualityCallback</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span>
                                              <span class="n">roi_mask_dict</span> <span class="o">=</span> <span class="n">roi_image_dict</span><span class="p">,</span>
                                              <span class="n">metrics_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MSE&#39;</span><span class="p">:</span><span class="n">mse</span><span class="p">,</span>
                                                              <span class="s1">&#39;MAE&#39;</span><span class="p">:</span><span class="n">mae</span><span class="p">,</span>
                                                              <span class="s1">&#39;PSNR&#39;</span><span class="p">:</span><span class="n">psnr</span><span class="p">},</span>
                                              <span class="n">statistics_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MEAN&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">y</span><span class="p">)),</span>
                                                                 <span class="s1">&#39;STDDEV&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">y</span><span class="p">)),</span>
                                                                 <span class="s1">&#39;MAX&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">))},</span>
                                              <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">algo</span><span class="o">=</span><span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">img_qual_callback</span><span class="p">])</span>
<span class="n">show2D</span><span class="p">([</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">algo</span><span class="o">.</span><span class="n">solution</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">,</span> <span class="s1">&#39;FDK Reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;TV solution&#39;</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We seen that over the whole image, the mean squared error initially decreases, but then eventually starts to overfit to the noise in the data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">501</span><span class="p">),</span> <span class="n">img_qual_callback</span><span class="o">.</span><span class="n">metrics_store</span><span class="p">[</span><span class="s1">&#39;global_MSE&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MSE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration number&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean squared error against iteration number&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<p>Similarly PSNR for the whole image, and for each of the regions of interest, initially increases to a peak at about 60-70 iterations then begins to decrease again. We can see that the PSNR over the whole image is greater than the regions of interest, suggesting that the algorithm is fitting the background well but not reconstructing the spheres as well.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">501</span><span class="p">),</span> <span class="n">img_qual_callback</span><span class="o">.</span><span class="n">metrics_store</span><span class="p">[</span><span class="s1">&#39;brightest_PSNR&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Brightest&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">501</span><span class="p">),</span> <span class="n">img_qual_callback</span><span class="o">.</span><span class="n">metrics_store</span><span class="p">[</span><span class="s1">&#39;global_PSNR&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Global&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">501</span><span class="p">),</span> <span class="n">img_qual_callback</span><span class="o">.</span><span class="n">metrics_store</span><span class="p">[</span><span class="s1">&#39;darkest_PSNR&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Darkest&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration number&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PSNR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39; PSNR for the different regions of interest&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../deriv2_cgls/"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">1D inverse problem demo using deriv2 from regtools</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=f9003edd7fb0eec021ef"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=f9003edd7fb0eec021ef"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2017-2024.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>