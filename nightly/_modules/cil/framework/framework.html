
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cil.framework.framework &#8212; CIL 23.0.1 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/styles/pydata-sphinx-theme.css" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../index.html">
<p class="title">CIL</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../introduction.html">
  Introduction
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../framework.html">
  Framework
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../io.html">
  Read/ write AcquisitionData and ImageData
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../optimisation.html">
  Optimisation framework
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../processors.html">
  Processors
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../recon.html">
  Recon
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../utilities.html">
  Utilities
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../plugins.html">
  CIL Plugins
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../developer_guide.html">
  Developers’ Guide
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items">
<h3><a href="../../../index.html">Table of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework.html">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io.html">Read/ write AcquisitionData and ImageData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimisation.html">Optimisation framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimisation.html#block-framework">Block Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../processors.html">Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../recon.html">Recon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins.html">CIL Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide.html">Developers’ Guide</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for cil.framework.framework</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#  Copyright 2018 United Kingdom Research and Innovation</span>
<span class="c1">#  Copyright 2018 The University of Manchester</span>
<span class="c1">#</span>
<span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#  you may not use this file except in compliance with the License.</span>
<span class="c1">#  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#  See the License for the specific language governing permissions and</span>
<span class="c1">#  limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># Authors:</span>
<span class="c1"># CIL Developers, listed at: https://github.com/TomographicImaging/CIL/blob/master/NOTICE.txt</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">import</span> <span class="nn">ctypes</span><span class="o">,</span> <span class="nn">platform</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">cil.utilities.multiprocessing</span> <span class="kn">import</span> <span class="n">NUM_THREADS</span>
<span class="c1"># check for the extension</span>

<span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
    <span class="n">dll</span> <span class="o">=</span> <span class="s1">&#39;libcilacc.so&#39;</span>
<span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
    <span class="n">dll_file</span> <span class="o">=</span> <span class="s1">&#39;cilacc.dll&#39;</span>
    <span class="n">dll</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="n">dll_file</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
    <span class="n">dll</span> <span class="o">=</span> <span class="s1">&#39;libcilacc.dylib&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not supported platform, &#39;</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">())</span>

<span class="n">cilacc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">dll</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">cil.framework.BlockGeometry</span> <span class="kn">import</span> <span class="n">BlockGeometry</span>

<span class="k">class</span> <span class="nc">Partitioner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Interface for AcquisitionData to be able to partition itself in a number of batches.</span>
<span class="sd">    </span>
<span class="sd">    This class, by multiple inheritance with AcquisitionData, allows the user to partition the data, </span>
<span class="sd">    by using the method ``partition``. </span>
<span class="sd">    The partitioning will generate a ``BlockDataContainer`` with appropriate ``AcquisitionData``.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># modes of partitioning</span>
    <span class="n">SEQUENTIAL</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span>
    <span class="n">STAGGERED</span> <span class="o">=</span> <span class="s1">&#39;staggered&#39;</span>
    <span class="n">RANDOM_PERMUTATION</span> <span class="o">=</span> <span class="s1">&#39;random_permutation&#39;</span>

    <span class="k">def</span> <span class="nf">_partition_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_batches</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">stagger</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Partition a list of indices into num_batches of indices.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_batches : int</span>
<span class="sd">            The number of batches to partition the indices into.</span>
<span class="sd">        indices : list of int, int</span>
<span class="sd">            The indices to partition. If passed a list, this list will be partitioned in ``num_batches``</span>
<span class="sd">            partitions. If passed an int the indices will be generated automatically using ``range(indices)``.</span>
<span class="sd">        stagger : bool, default False</span>
<span class="sd">            If True, the indices will be staggered across the batches.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        list of list of int</span>
<span class="sd">            A list of batches of indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Partition the indices into batches.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>

        <span class="n">num_indices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="n">num_indices</span> <span class="o">&lt;</span> <span class="n">num_batches</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The number of batches must be less than or equal to the number of indices.&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">stagger</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_batches</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">)]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we split the indices with floor(N/M)+1 indices in N%M groups</span>
            <span class="c1"># and floor(N/M) indices in the remaining M - N%M groups.</span>

            <span class="c1"># rename num_indices to N for brevity</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">num_indices</span>
            <span class="c1"># rename num_batches to M for brevity</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">num_batches</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">%</span> <span class="n">M</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">N</span> <span class="o">%</span> <span class="n">M</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">N</span> <span class="o">%</span> <span class="n">M</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span>
                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">batches</span>

    <span class="k">def</span> <span class="nf">_construct_BlockGeometry_from_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Convert a list of boolean masks to a list of BlockGeometry.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          indices : list of lists of indices</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            BlockGeometry</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">ag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ag</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">angle_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ag</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">BlockGeometry</span><span class="p">(</span><span class="o">*</span><span class="n">ags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_batches</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Partition the data into ``num_batches`` batches using the specified ``mode``.</span>
<span class="sd">        </span>

<span class="sd">        The modes are</span>
<span class="sd">        </span>
<span class="sd">        1. ``sequential`` - The data will be partitioned into ``num_batches`` batches of sequential indices.</span>
<span class="sd">        </span>
<span class="sd">        2. ``staggered`` - The data will be partitioned into ``num_batches`` batches of sequential indices, with stride equal to ``num_batches``.</span>
<span class="sd">        </span>
<span class="sd">        3. ``random_permutation`` - The data will be partitioned into ``num_batches`` batches of random indices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_batches : int</span>
<span class="sd">            The number of batches to partition the data into.</span>
<span class="sd">        mode : str</span>
<span class="sd">            The mode to use for partitioning. Must be one of ``sequential``, ``staggered`` or ``random_permutation``.</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            The seed to use for the random permutation. If not specified, the random number</span>
<span class="sd">            generator will not be seeded.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        BlockDataContainer</span>
<span class="sd">            Block of `AcquisitionData` objects containing the data requested in each batch</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        </span>
<span class="sd">        Partitioning a list of ints [0, 1, 2, 3, 4, 5, 6, 7, 8] into 4 batches will return:</span>
<span class="sd">    </span>
<span class="sd">        1. [[0, 1, 2], [3, 4], [5, 6], [7, 8]] with ``sequential``</span>
<span class="sd">        2. [[0, 4, 8], [1, 5], [2, 6], [3, 7]] with ``staggered``</span>
<span class="sd">        3. [[8, 2, 6], [7, 1], [0, 4], [3, 5]] with ``random_permutation`` and seed 1</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">Partitioner</span><span class="o">.</span><span class="n">SEQUENTIAL</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_deterministic</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="n">stagger</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">Partitioner</span><span class="o">.</span><span class="n">STAGGERED</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_deterministic</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="n">stagger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">Partitioner</span><span class="o">.</span><span class="n">RANDOM_PERMUTATION</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_random_permutation</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown partition mode </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_partition_deterministic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_batches</span><span class="p">,</span> <span class="n">stagger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Partition the data into ``num_batches`` batches.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_batches : int</span>
<span class="sd">            The number of batches to partition the data into.</span>
<span class="sd">        stagger : bool, optional</span>
<span class="sd">            If ``True``, the batches will be staggered. Default is ``False``.</span>
<span class="sd">        indices : list of int, optional</span>
<span class="sd">            The indices to partition. If not specified, the indices will be generated from the number of projections.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">num_projections</span>
        <span class="n">partition_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_indices</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">stagger</span><span class="p">)</span>
        <span class="n">blk_geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_BlockGeometry_from_indices</span><span class="p">(</span><span class="n">partition_indices</span><span class="p">)</span>
        
        <span class="c1"># copy data</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">blk_geo</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">blk_geo</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">partition_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
         
    <span class="k">def</span> <span class="nf">_partition_random_permutation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_batches</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Partition the data into ``num_batches`` batches using a random permutation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_batches : int</span>
<span class="sd">            The number of batches to partition the data into.</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            The seed to use for the random permutation. If not specified, the random number generator</span>
<span class="sd">            will not be seeded.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        
        <span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">num_projections</span><span class="p">)</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>            
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_deterministic</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="n">stagger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">find_key</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;return the key of dictionary dic given the value&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">val</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; {</span><span class="si">%d</span><span class="s2">}&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span> <span class="p">)</span>

<div class="viewcode-block" id="ImageGeometry"><a class="viewcode-back" href="../../../framework.html#cil.framework.ImageGeometry">[docs]</a><span class="k">class</span> <span class="nc">ImageGeometry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">RANDOM</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>
    <span class="n">RANDOM_INT</span> <span class="o">=</span> <span class="s1">&#39;random_int&#39;</span>
    <span class="n">CHANNEL</span> <span class="o">=</span> <span class="s1">&#39;channel&#39;</span>
    <span class="n">VERTICAL</span> <span class="o">=</span> <span class="s1">&#39;vertical&#39;</span>
    <span class="n">HORIZONTAL_X</span> <span class="o">=</span> <span class="s1">&#39;horizontal_x&#39;</span>
    <span class="n">HORIZONTAL_Y</span> <span class="o">=</span> <span class="s1">&#39;horizontal_y&#39;</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">shape_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">ImageGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                     <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span><span class="p">,</span>
                     <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_Y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_y</span><span class="p">,</span>        
                     <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_X</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_x</span><span class="p">}</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@shape</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deprecated - shape will be set automatically&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">spacing_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">ImageGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_spacing</span><span class="p">,</span>
                        <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_z</span><span class="p">,</span>
                        <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_Y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_y</span><span class="p">,</span>        
                        <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_X</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_x</span><span class="p">}</span>

        <span class="n">spacing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
            <span class="n">spacing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spacing_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">labels_default</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">CIL_IG_LABELS</span>

        <span class="n">shape_default</span> <span class="o">=</span> <span class="p">[</span>   <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_y</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_x</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels_default</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shape_default</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">labels_default</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#if not in custom list carry on</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
      
    <span class="nd">@dimension_labels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_labels</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">labels_default</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">CIL_IG_LABELS</span>

        <span class="c1">#check input and store. This value is not used directly</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels_default</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Requested axis are not possible. Accepted label names </span><span class="si">{}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">got </span><span class="si">{}</span><span class="s1">&#39;</span>\
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels_default</span><span class="p">,</span><span class="n">labels</span><span class="p">))</span>
                    
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_x</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">voxel_num_x</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_y</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">voxel_num_y</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">voxel_num_z</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_x</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">voxel_size_x</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_y</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">voxel_size_y</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_z</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">voxel_size_z</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">center_x</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">center_y</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_z</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">center_z</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">channels</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_spacing</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">channel_spacing</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>

            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>

    <span class="nd">@dtype</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">val</span>           

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">voxel_num_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">voxel_num_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">voxel_num_z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">voxel_size_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">voxel_size_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">voxel_size_z</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">center_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">center_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">center_z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">voxel_num_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">voxel_num_y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">voxel_num_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">voxel_size_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">voxel_size_y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">voxel_size_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span> <span class="o">=</span> <span class="n">center_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span> <span class="o">=</span> <span class="n">center_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_z</span> <span class="o">=</span> <span class="n">center_z</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_spacing</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<div class="viewcode-block" id="ImageGeometry.get_slice"><a class="viewcode-back" href="../../../framework.html#cil.framework.ImageGeometry.get_slice">[docs]</a>    <span class="k">def</span> <span class="nf">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">horizontal_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">horizontal_y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a new ImageGeometry of a single slice of in the requested direction.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">geometry_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geometry_new</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">geometry_new</span><span class="o">.</span><span class="n">channel_labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_labels</span><span class="p">[</span><span class="n">channel</span><span class="p">]]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">geometry_new</span><span class="o">.</span><span class="n">channel_labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">vertical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geometry_new</span><span class="o">.</span><span class="n">voxel_num_z</span> <span class="o">=</span> <span class="mi">0</span>
                
        <span class="k">if</span> <span class="n">horizontal_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geometry_new</span><span class="o">.</span><span class="n">voxel_num_y</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">horizontal_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geometry_new</span><span class="o">.</span><span class="n">voxel_num_x</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">geometry_new</span></div>

    <span class="k">def</span> <span class="nf">get_order_by_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension_labels</span><span class="p">,</span> <span class="n">default_dimension_labels</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">default_dimension_labels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ek</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dimension_labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="n">ek</span><span class="p">:</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">order</span>

    <span class="k">def</span> <span class="nf">get_min_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_x</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_x</span>
        
    <span class="k">def</span> <span class="nf">get_max_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_x</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_x</span>
        
    <span class="k">def</span> <span class="nf">get_min_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_y</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_y</span>
        
    <span class="k">def</span> <span class="nf">get_max_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_y</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_y</span>
        
    <span class="k">def</span> <span class="nf">get_min_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_z</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_z</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">get_max_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_z</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_z</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
<div class="viewcode-block" id="ImageGeometry.clone"><a class="viewcode-back" href="../../../framework.html#cil.framework.ImageGeometry.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a copy of the ImageGeometry&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageGeometry.copy"><a class="viewcode-back" href="../../../framework.html#cil.framework.ImageGeometry.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;alias of clone&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span></div>
 
    <span class="k">def</span> <span class="fm">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Number of channels: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;channel_spacing: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_spacing</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;voxel_num : x</span><span class="si">{0}</span><span class="s2">,y</span><span class="si">{1}</span><span class="s2">,z</span><span class="si">{2}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_z</span><span class="p">)</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;voxel_size : x</span><span class="si">{0}</span><span class="s2">,y</span><span class="si">{1}</span><span class="s2">,z</span><span class="si">{2}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_z</span><span class="p">)</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;center : x</span><span class="si">{0}</span><span class="s2">,y</span><span class="si">{1}</span><span class="s2">,z</span><span class="si">{2}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;voxel_num : x</span><span class="si">{0}</span><span class="s2">,y</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_num_y</span><span class="p">)</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;voxel_size : x</span><span class="si">{0}</span><span class="s2">,y</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size_y</span><span class="p">)</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;center : x</span><span class="si">{0}</span><span class="s2">,y</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">repres</span>
<div class="viewcode-block" id="ImageGeometry.allocate"><a class="viewcode-back" href="../../../framework.html#cil.framework.ImageGeometry.allocate">[docs]</a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;allocates an ImageData according to the size expressed in the instance</span>
<span class="sd">        </span>
<span class="sd">        :param value: accepts numbers to allocate an uniform array, or a string as &#39;random&#39; or &#39;random_int&#39; to create a random array or None.</span>
<span class="sd">        :type value: number or string, default None allocates empty memory block, default 0</span>
<span class="sd">        :param dtype: numerical type to allocate</span>
<span class="sd">        :type dtype: numpy type, default numpy.float32</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Deprecated: &#39;dimension_labels&#39; cannot be set with &#39;allocate()&#39;. Use &#39;geometry.set_labels()&#39; to modify the geometry before using allocate.&quot;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> 
                            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> 
                            <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="c1"># it&#39;s created empty, so we make it 0</span>
            <span class="n">out</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">RANDOM_INT</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_value&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">max_value</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value </span><span class="si">{}</span><span class="s1"> unknown&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">out</span></div></div>
    
<span class="k">class</span> <span class="nc">ComponentDescription</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class enables the creation of vectors and unit vectors used to describe the components of a tomography system</span>
<span class="sd">     &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dof</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dof</span> <span class="o">=</span> <span class="n">dof</span>

    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">create_vector</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t convert to numpy array&quot;</span><span class="p">)</span>
   
        <span class="k">return</span> <span class="n">vec</span>

    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">create_unit_vector</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_vector</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">dot_product</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dot_product</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-8</span><span class="p">:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dot_product</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t return a unit vector of a zero magnitude vector&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vec</span>

    <span class="k">def</span> <span class="nf">length_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vectors for </span><span class="si">{0}</span><span class="s2">D geometries must have length = </span><span class="si">{0}</span><span class="s2">. Got </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dof</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">val_length</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dof</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vectors for </span><span class="si">{0}</span><span class="s2">D geometries must have length = </span><span class="si">{0}</span><span class="s2">. Got </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dof</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">test_perpendicular</span><span class="p">(</span><span class="n">vector1</span><span class="p">,</span> <span class="n">vector2</span><span class="p">):</span>
        <span class="n">dor_prod</span> <span class="o">=</span> <span class="n">vector1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vector2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dor_prod</span><span class="p">)</span> <span class="o">&lt;</span><span class="mf">1e-10</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">test_parallel</span><span class="p">(</span><span class="n">vector1</span><span class="p">,</span> <span class="n">vector2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;For unit vectors only. Returns true if directions are opposite&#39;&#39;&#39;</span>
        <span class="n">dor_prod</span> <span class="o">=</span> <span class="n">vector1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vector2</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">1</span><span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dor_prod</span><span class="p">)</span> <span class="o">&lt;</span><span class="mf">1e-10</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">class</span> <span class="nc">PositionVector</span><span class="p">(</span><span class="n">ComponentDescription</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates a component of a tomography system with a position attribute</span>
<span class="sd">     &#39;&#39;&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="nd">@position</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">length_check</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_vector</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DirectionVector</span><span class="p">(</span><span class="n">ComponentDescription</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates a component of a tomography system with a direction attribute</span>
<span class="sd">     &#39;&#39;&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>      
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="nd">@direction</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length_check</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

 
<span class="k">class</span> <span class="nc">PositionDirectionVector</span><span class="p">(</span><span class="n">PositionVector</span><span class="p">,</span> <span class="n">DirectionVector</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates a component of a tomography system with position and direction attributes</span>
<span class="sd">     &#39;&#39;&#39;</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Detector1D</span><span class="p">(</span><span class="n">PositionVector</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates a component of a tomography system with position and direction_x attributes used for 1D panels</span>
<span class="sd">     &#39;&#39;&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direction_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_x</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="nd">@direction_x</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">direction_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length_check</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction_x</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">normal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>


<span class="k">class</span> <span class="nc">Detector2D</span><span class="p">(</span><span class="n">PositionVector</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates a component of a tomography system with position, direction_x and direction_y attributes used for 2D panels</span>
<span class="sd">     &#39;&#39;&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direction_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_x</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direction_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_y</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">normal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_y</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="k">def</span> <span class="nf">set_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length_check</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">length_check</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="n">dot_product</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dot_product</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;vectors detector.direction_x and detector.direction_y must be orthogonal&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_direction_y</span> <span class="o">=</span> <span class="n">y</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction_x</span> <span class="o">=</span> <span class="n">x</span>

<span class="k">class</span> <span class="nc">SystemConfiguration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This is a generic class to hold the description of a tomography system</span>
<span class="sd">     &#39;&#39;&#39;</span>

    <span class="n">SYSTEM_SIMPLE</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span> 
    <span class="n">SYSTEM_OFFSET</span> <span class="o">=</span> <span class="s1">&#39;offset&#39;</span> 
    <span class="n">SYSTEM_ADVANCED</span> <span class="o">=</span> <span class="s1">&#39;advanced&#39;</span> 

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;2D&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;3D&#39;</span>    

    <span class="nd">@dimension</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Can set up 2D and 3D systems only. got </span><span class="si">{0}</span><span class="s1">D&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimension</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span>

    <span class="nd">@geometry</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">CONE</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">PARALLEL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;geom_type = </span><span class="si">{}</span><span class="s1"> not recognised please specify </span><span class="se">\&#39;</span><span class="s1">cone</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">parallel</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units&#39;</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialises the system component attributes for the acquisition type</span>
<span class="sd">        &quot;&quot;&quot;</span>                
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="n">dof</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        
        <span class="k">if</span> <span class="n">geometry</span> <span class="o">==</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">PARALLEL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">DirectionVector</span><span class="p">(</span><span class="n">dof</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">PositionVector</span><span class="p">(</span><span class="n">dof</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dof</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">Detector1D</span><span class="p">(</span><span class="n">dof</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span> <span class="o">=</span> <span class="n">PositionVector</span><span class="p">(</span><span class="n">dof</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">Detector2D</span><span class="p">(</span><span class="n">dof</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span> <span class="o">=</span> <span class="n">PositionDirectionVector</span><span class="p">(</span><span class="n">dof</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implements the string representation of the system configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implements the equality check of the system configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rotation_vec_to_y</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns a rotation matrix that will rotate the projection of vec on the x-y plane to the +y direction [0,1, Z]&#39;&#39;&#39;</span>
    
        <span class="n">vec</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

        <span class="n">axis_rotation</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">vec</span><span class="p">[:</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">vec</span><span class="p">[:</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">axis_rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">axis_rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">axis_rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis_rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">axis_rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">axis_rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axis_rotation</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rotation_vec_to_z</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns a rotation matrix that will align vec with the z-direction [0,0,1]&#39;&#39;&#39;</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">axis_rotation</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">vec</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">vec</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">axis_rotation</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">axis_rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">axis_rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]])</span>
                <span class="n">axis_rotation</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">vx</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">*</span>  <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vec must have length 3, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)))</span>
    
        <span class="k">return</span> <span class="n">axis_rotation</span>

    <span class="k">def</span> <span class="nf">update_reference_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Transforms the system origin to the rotation_axis position</span>
<span class="sd">        &#39;&#39;&#39;</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">set_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Transforms the system origin to the input origin</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;source&#39;</span><span class="p">):</span>              
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="o">-=</span> <span class="n">translation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-=</span> <span class="n">translation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">-=</span> <span class="n">translation</span>


    <span class="k">def</span> <span class="nf">get_centre_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the 2D system configuration corresponding to the centre slice</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">calculate_magnification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Calculates the magnification of the system using the source to rotate axis,</span>
<span class="sd">        and source to detector distance along the direction.</span>

<span class="sd">        :return: returns [dist_source_center, dist_center_detector, magnification],  [0] distance from the source to the rotate axis, [1] distance from the rotate axis to the detector, [2] magnification of the system</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
  
    <span class="k">def</span> <span class="nf">system_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns `simple` if the the geometry matches the default definitions with no offsets or rotations,</span>
<span class="sd">            \nReturns `offset` if the the geometry matches the default definitions with centre-of-rotation or detector offsets</span>
<span class="sd">            \nReturns `advanced` if the the geometry has rotated or tilted rotation axis or detector, can also have offsets</span>
<span class="sd">        &#39;&#39;&#39;</span>         
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a copy of SystemConfiguration&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Parallel2D</span><span class="p">(</span><span class="n">SystemConfiguration</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates the SystemConfiguration of a parallel beam 2D tomographic system</span>
<span class="sd">                       </span>
<span class="sd">    :param ray_direction: A 2D vector describing the x-ray direction (x,y)</span>
<span class="sd">    :type ray_direction: list, tuple, ndarray</span>
<span class="sd">    :param detector_pos: A 2D vector describing the position of the centre of the detector (x,y)</span>
<span class="sd">    :type detector_pos: list, tuple, ndarray</span>
<span class="sd">    :param detector_direction_x: A 2D vector describing the direction of the detector_x (x,y)</span>
<span class="sd">    :type detector_direction_x: list, tuple, ndarray</span>
<span class="sd">    :param rotation_axis_pos: A 2D vector describing the position of the axis of rotation (x,y)</span>
<span class="sd">    :type rotation_axis_pos: list, tuple, ndarray</span>
<span class="sd">    :param units: Label the units of distance used for the configuration</span>
<span class="sd">    :type units: string</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ray_direction</span><span class="p">,</span> <span class="n">detector_pos</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">rotation_axis_pos</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Parallel2D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

        <span class="c1">#source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">ray_direction</span>

        <span class="c1">#detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">detector_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">=</span> <span class="n">detector_direction_x</span>
        
        <span class="c1">#rotate axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_axis_pos</span>


    <span class="k">def</span> <span class="nf">align_reference_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;cil&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Transforms and rotates the system to backend definitions</span>

<span class="sd">        &#39;cil&#39; sets the origin to the rotation axis and aligns the y axis with the ray-direction</span>
<span class="sd">        &#39;tigre&#39; sets the origin to the rotation axis and aligns the y axis with the ray-direction</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#in this instance definitions are the same</span>
        <span class="k">if</span> <span class="n">definition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cil&#39;</span><span class="p">,</span><span class="s1">&#39;tigre&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Geometry can be configured for definition = &#39;cil&#39; or &#39;tigre&#39;  only. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">definition</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">rotation_vec_to_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">system_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns `simple` if the the geometry matches the default definitions with no offsets or rotations,</span>
<span class="sd">            \nReturns `offset` if the the geometry matches the default definitions with centre-of-rotation or detector offsets</span>
<span class="sd">            \nReturns `advanced` if the the geometry has rotated or tilted rotation axis or detector, can also have offsets</span>
<span class="sd">        &#39;&#39;&#39;</span>       


        <span class="n">rays_perpendicular_detector</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>

        <span class="c1">#rotation axis position + ray direction hits detector position</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">):</span> <span class="c1">#points are equal so on ray path</span>
            <span class="n">rotation_axis_centred</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vec_a</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
            <span class="n">rotation_axis_centred</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">vec_a</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rays_perpendicular_detector</span><span class="p">:</span> 
            <span class="n">config</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_ADVANCED</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">rotation_axis_centred</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span>  <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span>  <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_SIMPLE</span>

        <span class="k">return</span> <span class="n">config</span>


    <span class="k">def</span> <span class="nf">rotation_axis_on_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the position, on the detector, of the projection of the rotation axis in the world coordinate system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PositionVector</span>
<span class="sd">            Position in the 3D system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">Pv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">PositionVector</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">Pv</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span> <span class="o">*</span> <span class="n">ratio</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">calculate_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the position, on the detector, of the projection of the rotation axis in the detector coordinate system</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">         - Origin is in the centre of the detector</span>
<span class="sd">         - Axes directions are specified by detector.direction_x, detector.direction_y</span>
<span class="sd">         - Units are the units of distance used to specify the component&#39;s positions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Float</span>
<span class="sd">            Offset position along the detector x_axis at y=0</span>
<span class="sd">        Float</span>
<span class="sd">            Angle between the y_axis and the rotation axis projection, in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#convert to the detector coordinate system</span>
        <span class="n">dp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis_on_detector</span><span class="p">()</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp1</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Configures the geometry to have the requested centre of rotation offset at the detector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_centre_of_rotation</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">offset_new</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">offset_current</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">offset_new</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">csv</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
        
        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;2D Parallel-beam tomography</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;System configuration:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Ray direction: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Rotation axis position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector direction x: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">repres</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> \
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_centre_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">calculate_magnification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Parallel3D</span><span class="p">(</span><span class="n">SystemConfiguration</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates the SystemConfiguration of a parallel beam 3D tomographic system</span>
<span class="sd">                       </span>
<span class="sd">    :param ray_direction: A 3D vector describing the x-ray direction (x,y,z)</span>
<span class="sd">    :type ray_direction: list, tuple, ndarray</span>
<span class="sd">    :param detector_pos: A 3D vector describing the position of the centre of the detector (x,y,z)</span>
<span class="sd">    :type detector_pos: list, tuple, ndarray</span>
<span class="sd">    :param detector_direction_x: A 3D vector describing the direction of the detector_x (x,y,z)</span>
<span class="sd">    :type detector_direction_x: list, tuple, ndarray</span>
<span class="sd">    :param detector_direction_y: A 3D vector describing the direction of the detector_y (x,y,z)</span>
<span class="sd">    :type detector_direction_y: list, tuple, ndarray</span>
<span class="sd">    :param rotation_axis_pos: A 3D vector describing the position of the axis of rotation (x,y,z)</span>
<span class="sd">    :type rotation_axis_pos: list, tuple, ndarray</span>
<span class="sd">    :param rotation_axis_direction: A 3D vector describing the direction of the axis of rotation (x,y,z)</span>
<span class="sd">    :type rotation_axis_direction: list, tuple, ndarray       </span>
<span class="sd">    :param units: Label the units of distance used for the configuration</span>
<span class="sd">    :type units: string</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">ray_direction</span><span class="p">,</span> <span class="n">detector_pos</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">detector_direction_y</span><span class="p">,</span> <span class="n">rotation_axis_pos</span><span class="p">,</span> <span class="n">rotation_axis_direction</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Parallel3D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                    
        <span class="c1">#source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">ray_direction</span>

        <span class="c1">#detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">detector_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">set_direction</span><span class="p">(</span><span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">detector_direction_y</span><span class="p">)</span>

        <span class="c1">#rotate axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_axis_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">rotation_axis_direction</span>

    <span class="k">def</span> <span class="nf">align_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Transforms the system origin to the rotate axis with z direction aligned to the rotate axis direction</span>
<span class="sd">        &#39;&#39;&#39;</span>          
        <span class="bp">self</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="c1">#calculate rotation matrix to align rotation axis direction with z</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">rotation_vec_to_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>

        <span class="c1">#apply transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_y</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">set_direction</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">align_reference_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;cil&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Transforms and rotates the system to backend definitions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#in this instance definitions are the same</span>
        <span class="k">if</span> <span class="n">definition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cil&#39;</span><span class="p">,</span><span class="s1">&#39;tigre&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Geometry can be configured for definition = &#39;cil&#39; or &#39;tigre&#39;  only. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">definition</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">align_z</span><span class="p">()</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">rotation_vec_to_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_direction_x</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_direction_y</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">set_direction</span><span class="p">(</span><span class="n">new_direction_x</span><span class="p">,</span> <span class="n">new_direction_y</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">system_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns `simple` if the the geometry matches the default definitions with no offsets or rotations,</span>
<span class="sd">            \nReturns `offset` if the the geometry matches the default definitions with centre-of-rotation or detector offsets</span>
<span class="sd">            \nReturns `advanced` if the the geometry has rotated or tilted rotation axis or detector, can also have offsets</span>
<span class="sd">        &#39;&#39;&#39;</span>              


<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        simple</span>
<span class="sd">         - rays perpendicular to detector</span>
<span class="sd">         - rotation axis parallel to detector y</span>
<span class="sd">         - rotation axis position + ray direction hits detector with no x offset (y offsets allowed)</span>
<span class="sd">        offset</span>
<span class="sd">         - rays perpendicular to detector</span>
<span class="sd">         - rotation axis parallel to detector y</span>
<span class="sd">        rolled</span>
<span class="sd">         - rays perpendicular to detector</span>
<span class="sd">         - rays perpendicular to rotation axis</span>
<span class="sd">        advanced</span>
<span class="sd">         - not rays perpendicular to detector (for parallel just equates to an effective pixel size change?)</span>
<span class="sd">         or </span>
<span class="sd">         - not rays perpendicular to rotation axis  (tilted, i.e. laminography)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">rays_perpendicular_detector</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">rays_perpendicular_rotation</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_perpendicular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">rotation_parallel_detector_y</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">)</span>

        <span class="c1">#rotation axis to detector is parallel with ray</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">):</span> <span class="c1">#points are equal so on ray path</span>
            <span class="n">rotation_axis_centred</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vec_a</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="p">)</span>
            <span class="n">rotation_axis_centred</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">vec_a</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rays_perpendicular_detector</span> <span class="ow">or</span>\
            <span class="ow">not</span> <span class="n">rays_perpendicular_rotation</span> <span class="ow">or</span>\
            <span class="ow">not</span> <span class="n">rotation_parallel_detector_y</span><span class="p">:</span> 
            <span class="n">config</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_ADVANCED</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">rotation_axis_centred</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span>  <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span>  <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_SIMPLE</span>

        <span class="k">return</span> <span class="n">config</span>
        

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">csv</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;3D Parallel-beam tomography</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;System configuration:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Ray direction: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Rotation axis position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Rotation axis direction: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector direction x: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector direction y: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">))</span>    
        <span class="k">return</span> <span class="n">repres</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> \
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">):</span>
            
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">calculate_magnification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_centre_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the 2D system configuration corresponding to the centre slice</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="n">dp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">dp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dp1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dp2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1">#convert to rotation axis reference frame</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">align_reference_frame</span><span class="p">()</span>

            <span class="n">ray_direction</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">detector_position</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">detector_direction_x</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">rotation_axis_position</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">Parallel2D</span><span class="p">(</span><span class="n">ray_direction</span><span class="p">,</span> <span class="n">detector_position</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">rotation_axis_position</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot convert geometry to 2D. Requires axis of rotation to be perpendicular to ray direction and the detector direction x.&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">rotation_axis_on_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the position, on the detector, of the projection of the rotation axis in the world coordinate system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PositionDirectionVector</span>
<span class="sd">            Position and direction in the 3D system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#calculate the rotation axis line with the detector</span>
        <span class="n">vec_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span>

        <span class="c1">#calculate the intersection with the detector</span>
        <span class="n">Pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">Pv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">vec_a</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">point1</span> <span class="o">=</span> <span class="n">Pv</span> <span class="o">+</span> <span class="n">vec_a</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="n">Pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">Pv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">vec_a</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">point2</span> <span class="o">=</span> <span class="n">Pv</span> <span class="o">+</span> <span class="n">vec_a</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">PositionDirectionVector</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">point1</span>
        <span class="n">out</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">point2</span> <span class="o">-</span> <span class="n">point1</span>
        <span class="k">return</span> <span class="n">out</span>


    <span class="k">def</span> <span class="nf">calculate_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the position, on the detector, of the projection of the rotation axis in the detector coordinate system</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">         - Origin is in the centre of the detector</span>
<span class="sd">         - Axes directions are specified by detector.direction_x, detector.direction_y</span>
<span class="sd">         - Units are the units of distance used to specify the component&#39;s positions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Float</span>
<span class="sd">            Offset position along the detector x_axis at y=0</span>
<span class="sd">        Float</span>
<span class="sd">            Angle between the y_axis and the rotation axis projection, in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rotate_axis_projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis_on_detector</span><span class="p">()</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">rotate_axis_projection</span><span class="o">.</span><span class="n">position</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">rotate_axis_projection</span><span class="o">.</span><span class="n">direction</span>

        <span class="c1">#point1 and point2 are on the detector plane. need to return them in the detector coordinate system</span>
        <span class="n">dp1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp1</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp1</span><span class="p">)</span>
        <span class="n">dp2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp2</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp2</span><span class="p">)</span>

        <span class="c1">#y = m * x + c</span>
        <span class="c1">#c = y1 - m * x1</span>
        <span class="c1">#when y is 0</span>
        <span class="c1">#x=-c/m</span>
        <span class="c1">#x_y0 = -y1/m + x1 </span>
        <span class="n">offset_x_y0</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span><span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span>

        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_x_y0</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Configures the geometry to have the requested centre of rotation offset at the detector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#two points on the detector</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">#convert to 3d coordinates in system frame</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">+</span> <span class="n">y2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span>

        <span class="c1"># find where vec p1 + t * ray dirn intersects plane defined by rotate axis (pos and dir) and det_x direction</span>

        <span class="n">vector_pos</span><span class="o">=</span><span class="n">p1</span>
        <span class="n">vec_dirn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">direction</span>
        <span class="n">plane_pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span>
        <span class="n">plane_normal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>


        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_pos</span> <span class="o">-</span> <span class="n">vector_pos</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">vec_dirn</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">)</span>
        <span class="n">p1_on_plane</span> <span class="o">=</span> <span class="n">vector_pos</span> <span class="o">+</span> <span class="n">vec_dirn</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="n">vector_pos</span><span class="o">=</span><span class="n">p2</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_pos</span> <span class="o">-</span> <span class="n">vector_pos</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">vec_dirn</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">)</span>
        <span class="n">p2_on_plane</span> <span class="o">=</span> <span class="n">vector_pos</span> <span class="o">+</span> <span class="n">vec_dirn</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">p1_on_plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">p2_on_plane</span> <span class="o">-</span> <span class="n">p1_on_plane</span>


<span class="k">class</span> <span class="nc">Cone2D</span><span class="p">(</span><span class="n">SystemConfiguration</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates the SystemConfiguration of a cone beam 2D tomographic system</span>
<span class="sd">                       </span>
<span class="sd">    :param source_pos: A 2D vector describing the position of the source (x,y)</span>
<span class="sd">    :type source_pos: list, tuple, ndarray</span>
<span class="sd">    :param detector_pos: A 2D vector describing the position of the centre of the detector (x,y)</span>
<span class="sd">    :type detector_pos: list, tuple, ndarray</span>
<span class="sd">    :param detector_direction_x: A 2D vector describing the direction of the detector_x (x,y)</span>
<span class="sd">    :type detector_direction_x: list, tuple, ndarray</span>
<span class="sd">    :param rotation_axis_pos: A 2D vector describing the position of the axis of rotation (x,y)</span>
<span class="sd">    :type rotation_axis_pos: list, tuple, ndarray</span>
<span class="sd">    :param units: Label the units of distance used for the configuration</span>
<span class="sd">    :type units: string</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_pos</span><span class="p">,</span> <span class="n">detector_pos</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">rotation_axis_pos</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Cone2D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="s1">&#39;cone&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

        <span class="c1">#source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">source_pos</span>

        <span class="c1">#detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">detector_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">=</span> <span class="n">detector_direction_x</span>

        <span class="c1">#rotate axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_axis_pos</span>


    <span class="k">def</span> <span class="nf">align_reference_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;cil&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Transforms and rotates the system to backend definitions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">definition</span><span class="o">==</span><span class="s1">&#39;cil&#39;</span><span class="p">:</span>
            <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">rotation_vec_to_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">definition</span><span class="o">==</span><span class="s1">&#39;tigre&#39;</span><span class="p">:</span>
            <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">rotation_vec_to_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Geometry can be configured for definition = &#39;cil&#39; or &#39;tigre&#39;  only. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">definition</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">system_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns `simple` if the the geometry matches the default definitions with no offsets or rotations,</span>
<span class="sd">            \nReturns `offset` if the the geometry matches the default definitions with centre-of-rotation or detector offsets</span>
<span class="sd">            \nReturns `advanced` if the the geometry has rotated or tilted rotation axis or detector, can also have offsets</span>
<span class="sd">        &#39;&#39;&#39;</span>           

        <span class="n">vec_src2det</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="n">principal_ray_centred</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="n">vec_src2det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>

        <span class="c1">#rotation axis to detector is parallel with centre ray</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">):</span> <span class="c1">#points are equal</span>
            <span class="n">rotation_axis_centred</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vec_b</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="p">)</span>
            <span class="n">rotation_axis_centred</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="n">vec_src2det</span><span class="p">,</span> <span class="n">vec_b</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">principal_ray_centred</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_ADVANCED</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">rotation_axis_centred</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span>  <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span>  <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_SIMPLE</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">csv</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;2D Cone-beam tomography</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;System configuration:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Source position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Rotation axis position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector direction x: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">))</span> 
        <span class="k">return</span> <span class="n">repres</span>    

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> \
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_centre_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">calculate_magnification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">dist_source_center</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ab</span><span class="p">)))</span>

        <span class="n">ab_unit</span> <span class="o">=</span> <span class="n">ab</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ab</span><span class="p">))</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span>

        <span class="c1">#perpendicular distance between source and detector centre</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ab_unit</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

        <span class="n">source_to_detector</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">/</span> <span class="n">ratio</span>
        <span class="n">dist_center_detector</span> <span class="o">=</span> <span class="n">source_to_detector</span> <span class="o">-</span> <span class="n">dist_source_center</span>
        <span class="n">magnification</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_center_detector</span> <span class="o">+</span> <span class="n">dist_source_center</span><span class="p">)</span> <span class="o">/</span> <span class="n">dist_source_center</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">dist_source_center</span><span class="p">,</span> <span class="n">dist_center_detector</span><span class="p">,</span> <span class="n">magnification</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rotation_axis_on_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the position, on the detector, of the projection of the rotation axis in the world coordinate system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PositionVector</span>
<span class="sd">            Position in the 3D system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#calculate the point the rotation axis intersects with the detector</span>
        <span class="n">vec_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span>

        <span class="n">Pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">Pv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">vec_a</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">PositionVector</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">Pv</span> <span class="o">+</span> <span class="n">vec_a</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="k">return</span> <span class="n">out</span>


    <span class="k">def</span> <span class="nf">calculate_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the position, on the detector, of the projection of the rotation axis in the detector coordinate system</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">         - Origin is in the centre of the detector</span>
<span class="sd">         - Axes directions are specified by detector.direction_x, detector.direction_y</span>
<span class="sd">         - Units are the units of distance used to specify the component&#39;s positions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Float</span>
<span class="sd">            Offset position along the detector x_axis at y=0</span>
<span class="sd">        Float</span>
<span class="sd">            Angle between the y_axis and the rotation axis projection, in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#convert to the detector coordinate system</span>
        <span class="n">dp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis_on_detector</span><span class="p">()</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp1</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Configures the geometry to have the requested centre of rotation offset at the detector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_centre_of_rotation</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">offset_new</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">offset_current</span>

        <span class="n">cofr_shift</span> <span class="o">=</span> <span class="n">offset_new</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_magnification</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">cofr_shift</span>

<span class="k">class</span> <span class="nc">Cone3D</span><span class="p">(</span><span class="n">SystemConfiguration</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class creates the SystemConfiguration of a cone beam 3D tomographic system</span>
<span class="sd">                       </span>
<span class="sd">    :param source_pos: A 3D vector describing the position of the source (x,y,z)</span>
<span class="sd">    :type source_pos: list, tuple, ndarray</span>
<span class="sd">    :param detector_pos: A 3D vector describing the position of the centre of the detector (x,y,z)</span>
<span class="sd">    :type detector_pos: list, tuple, ndarray</span>
<span class="sd">    :param detector_direction_x: A 3D vector describing the direction of the detector_x (x,y,z)</span>
<span class="sd">    :type detector_direction_x: list, tuple, ndarray</span>
<span class="sd">    :param detector_direction_y: A 3D vector describing the direction of the detector_y (x,y,z)</span>
<span class="sd">    :type detector_direction_y: list, tuple, ndarray   </span>
<span class="sd">    :param rotation_axis_pos: A 3D vector describing the position of the axis of rotation (x,y,z)</span>
<span class="sd">    :type rotation_axis_pos: list, tuple, ndarray</span>
<span class="sd">    :param rotation_axis_direction: A 3D vector describing the direction of the axis of rotation (x,y,z)</span>
<span class="sd">    :type rotation_axis_direction: list, tuple, ndarray   </span>
<span class="sd">    :param units: Label the units of distance used for the configuration</span>
<span class="sd">    :type units: string</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_pos</span><span class="p">,</span> <span class="n">detector_pos</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">detector_direction_y</span><span class="p">,</span> <span class="n">rotation_axis_pos</span><span class="p">,</span> <span class="n">rotation_axis_direction</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Cone3D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="s1">&#39;cone&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

        <span class="c1">#source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">source_pos</span>

        <span class="c1">#detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">detector_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">set_direction</span><span class="p">(</span><span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">detector_direction_y</span><span class="p">)</span>

        <span class="c1">#rotate axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_axis_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">rotation_axis_direction</span>

    <span class="k">def</span> <span class="nf">align_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Transforms the system origin to the rotate axis with z direction aligned to the rotate axis direction</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>   
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">rotation_vec_to_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
    
        <span class="c1">#apply transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> 
        <span class="n">new_y</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">set_direction</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">align_reference_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;cil&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Transforms and rotates the system to backend definitions</span>
<span class="sd">        &#39;&#39;&#39;</span>            

        <span class="bp">self</span><span class="o">.</span><span class="n">align_z</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">definition</span><span class="o">==</span><span class="s1">&#39;cil&#39;</span><span class="p">:</span>
            <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">rotation_vec_to_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">definition</span><span class="o">==</span><span class="s1">&#39;tigre&#39;</span><span class="p">:</span>
            <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">rotation_vec_to_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Geometry can be configured for definition = &#39;cil&#39; or &#39;tigre&#39;  only. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">definition</span><span class="p">))</span>
                            
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_direction_x</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_direction_y</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">set_direction</span><span class="p">(</span><span class="n">new_direction_x</span><span class="p">,</span> <span class="n">new_direction_y</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">system_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns `simple` if the the geometry matches the default definitions with no offsets or rotations,</span>
<span class="sd">            \nReturns `offset` if the the geometry matches the default definitions with centre-of-rotation or detector offsets</span>
<span class="sd">            \nReturns `advanced` if the the geometry has rotated or tilted rotation axis or detector, can also have offsets</span>
<span class="sd">        &#39;&#39;&#39;</span>       

        <span class="n">vec_src2det</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="n">principal_ray_centred</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="n">vec_src2det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">centre_ray_perpendicular_rotation</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_perpendicular</span><span class="p">(</span><span class="n">vec_src2det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">rotation_parallel_detector_y</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">)</span>

        <span class="c1">#rotation axis to detector is parallel with centre ray</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">):</span> <span class="c1">#points are equal</span>
            <span class="n">rotation_axis_centred</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vec_b</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">create_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="p">)</span>
            <span class="n">rotation_axis_centred</span> <span class="o">=</span> <span class="n">ComponentDescription</span><span class="o">.</span><span class="n">test_parallel</span><span class="p">(</span><span class="n">vec_src2det</span><span class="p">,</span> <span class="n">vec_b</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">principal_ray_centred</span> <span class="ow">or</span>\
            <span class="ow">not</span> <span class="n">centre_ray_perpendicular_rotation</span> <span class="ow">or</span>\
            <span class="ow">not</span> <span class="n">rotation_parallel_detector_y</span><span class="p">:</span> 
            <span class="n">config</span> <span class="o">=</span> <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_ADVANCED</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">rotation_axis_centred</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span>  <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span>  <span class="n">SystemConfiguration</span><span class="o">.</span><span class="n">SYSTEM_SIMPLE</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">get_centre_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the 2D system configuration corresponding to the centre slice</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1">#requires the rotate axis to be perpendicular to the normal of the detector, and perpendicular to detector_direction_x</span>
        <span class="n">dp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">dp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dp1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dp2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">align_reference_frame</span><span class="p">()</span>
            <span class="n">source_position</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">detector_position</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">detector_direction_x</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">rotation_axis_position</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">Cone2D</span><span class="p">(</span><span class="n">source_position</span><span class="p">,</span> <span class="n">detector_position</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">rotation_axis_position</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot convert geometry to 2D. Requires axis of rotation to be perpendicular to the detector.&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">csv</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;3D Cone-beam tomography</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;System configuration:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Source position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Rotation axis position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Rotation axis direction: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector position: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector direction x: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">))</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detector direction y: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">repres</span>   

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> \
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>\
        <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">):</span>
            
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">calculate_magnification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
        <span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">dist_source_center</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ab</span><span class="p">)))</span>

        <span class="n">ab_unit</span> <span class="o">=</span> <span class="n">ab</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ab</span><span class="p">))</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span>

        <span class="c1">#perpendicular distance between source and detector centre</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ab_unit</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

        <span class="n">source_to_detector</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">/</span> <span class="n">ratio</span>
        <span class="n">dist_center_detector</span> <span class="o">=</span> <span class="n">source_to_detector</span> <span class="o">-</span> <span class="n">dist_source_center</span>
        <span class="n">magnification</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_center_detector</span> <span class="o">+</span> <span class="n">dist_source_center</span><span class="p">)</span> <span class="o">/</span> <span class="n">dist_source_center</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">dist_source_center</span><span class="p">,</span> <span class="n">dist_center_detector</span><span class="p">,</span> <span class="n">magnification</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rotation_axis_on_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the position, on the detector, of the projection of the rotation axis in the world coordinate system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PositionDirectionVector</span>
<span class="sd">            Position and direction in the 3D system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#calculate the intersection with the detector, of source to pv</span>
        <span class="n">Pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span>
        <span class="n">vec_a</span> <span class="o">=</span> <span class="n">Pv</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">Pv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">vec_a</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">point1</span> <span class="o">=</span> <span class="n">Pv</span> <span class="o">+</span> <span class="n">vec_a</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="c1">#calculate the intersection with the detector, of source to pv</span>
        <span class="n">Pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span>
        <span class="n">vec_a</span> <span class="o">=</span> <span class="n">Pv</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">Pv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">vec_a</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">point2</span> <span class="o">=</span> <span class="n">Pv</span> <span class="o">+</span> <span class="n">vec_a</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">PositionDirectionVector</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">point1</span>
        <span class="n">out</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">point2</span> <span class="o">-</span> <span class="n">point1</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">calculate_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the position, on the detector, of the projection of the rotation axis in the detector coordinate system</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">         - Origin is in the centre of the detector</span>
<span class="sd">         - Axes directions are specified by detector.direction_x, detector.direction_y</span>
<span class="sd">         - Units are the units of distance used to specify the component&#39;s positions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Float</span>
<span class="sd">            Offset position along the detector x_axis at y=0</span>
<span class="sd">        Float</span>
<span class="sd">            Angle between the y_axis and the rotation axis projection, in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rotate_axis_projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis_on_detector</span><span class="p">()</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">rotate_axis_projection</span><span class="o">.</span><span class="n">position</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">rotate_axis_projection</span><span class="o">.</span><span class="n">direction</span>

        <span class="c1">#point1 and point2 are on the detector plane. need to return them in the detector coordinate system</span>
        <span class="n">dp1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp1</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp1</span><span class="p">)</span>
        <span class="n">dp2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp2</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dp2</span><span class="p">)</span>

        <span class="c1">#y = m * x + c</span>
        <span class="c1">#c = y1 - m * x1</span>
        <span class="c1">#when y is 0</span>
        <span class="c1">#x=-c/m</span>
        <span class="c1">#x_y0 = -y1/m + x1 </span>
        <span class="n">offset_x_y0</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span><span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span>

        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_x_y0</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">set_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Configures the geometry to have the requested centre of rotation offset at the detector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#two points on the detector</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">#convert to 3d coordinates in system frame</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span> <span class="o">+</span> <span class="n">y2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span>

        <span class="c1"># vectors from source define plane</span>
        <span class="n">sp1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span>
        <span class="n">sp2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span>

        <span class="c1">#find vector intersection with a plane defined by rotate axis (pos and dir) and det_x direction</span>
        <span class="n">plane_normal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_x</span><span class="p">)</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">sp1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">)</span>
        <span class="n">p1_on_plane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">sp1</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">sp2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">plane_normal</span><span class="p">)</span>
        <span class="n">p2_on_plane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">sp2</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">p1_on_plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_axis</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">p2_on_plane</span> <span class="o">-</span> <span class="n">p1_on_plane</span>


<span class="k">class</span> <span class="nc">Panel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This is a class describing the panel of the system. </span>
<span class="sd">                 </span>
<span class="sd">    :param num_pixels: num_pixels_h or (num_pixels_h, num_pixels_v) containing the number of pixels of the panel</span>
<span class="sd">    :type num_pixels: int, list, tuple</span>
<span class="sd">    :param pixel_size: pixel_size_h or (pixel_size_h, pixel_size_v) containing the size of the pixels of the panel</span>
<span class="sd">    :type pixel_size: int, lust, tuple</span>
<span class="sd">    :param origin: the position of pixel 0 (the data origin) of the panel `top-left`, `top-right`, `bottom-left`, `bottom-right`</span>
<span class="sd">    :type origin: string </span>
<span class="sd">     &#39;&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_pixels</span>

    <span class="nd">@num_pixels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">num_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">num_pixels_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">length_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;num_pixels expected int x or [int x, int y]. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>


            <span class="k">if</span> <span class="n">length_val</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">val1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;num_pixels expected int x or [int x, int y]. Got </span><span class="si">{0}</span><span class="s1">,</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

                <span class="n">num_pixels_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">val0</span><span class="p">,</span> <span class="n">val1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;num_pixels expected int x or [int x, int y]. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
   
        <span class="k">if</span> <span class="n">num_pixels_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;2D acquisitions expects a 1D panel. Expected num_pixels[1] = 1. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_pixels_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">num_pixels_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">num_pixels_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;num_pixels (x,y) must be &gt;= (1,1). Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_pixels_temp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_pixels</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">num_pixels_temp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixel_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_size</span>

    <span class="nd">@pixel_size</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pixel_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pixel_size_temp</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">length_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">pixel_size_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">temp</span><span class="p">,</span> <span class="n">temp</span><span class="p">]</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;pixel_size expected float xy or [float x, float y]. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">length_val</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">temp0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
                        <span class="n">temp1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> 
                        <span class="n">pixel_size_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">temp0</span><span class="p">,</span> <span class="n">temp1</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pixel_size expected float xy or [float x, float y]. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pixel_size expected float xy or [float x, float y]. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    
            <span class="k">if</span> <span class="n">pixel_size_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pixel_size_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pixel_size (x,y) at must be &gt; (0.,0.). Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pixel_size_temp</span><span class="p">))</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pixel_size_temp</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span>

    <span class="nd">@origin</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top-left&#39;</span><span class="p">,</span> <span class="s1">&#39;top-right&#39;</span><span class="p">,</span><span class="s1">&#39;bottom-left&#39;</span><span class="p">,</span><span class="s1">&#39;bottom-right&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span><span class="o">=</span><span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;origin expected one of </span><span class="si">{0}</span><span class="s1">. Got </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">allowed</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;Panel configuration:</span><span class="se">\n</span><span class="s2">&quot;</span>             
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Number of pixels: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">)</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Pixel size: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">)</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Pixel origin: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">repres</span>   

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>   
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">dimension</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dimension</span> <span class="o">=</span> <span class="n">dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_pixels</span> <span class="o">=</span> <span class="n">num_pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">pixel_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>

<span class="k">class</span> <span class="nc">Channels</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This is a class describing the channels of the data. </span>
<span class="sd">    This will be created on initialisation of AcquisitionGeometry.</span>
<span class="sd">                       </span>
<span class="sd">    :param num_channels: The number of channels of data</span>
<span class="sd">    :type num_channels: int</span>
<span class="sd">    :param channel_labels: A list of channel labels</span>
<span class="sd">    :type channel_labels: list, optional</span>
<span class="sd">     &#39;&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_channels</span>

    <span class="nd">@num_channels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">num_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>      
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;num_channels expected a positive integer. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_channels</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;num_channels expected a positive integer. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channel_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_labels</span>

    <span class="nd">@channel_labels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">channel_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>      
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_channel_labels</span> <span class="o">=</span> <span class="n">val</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;labels expected to have length </span><span class="si">{0}</span><span class="s1">. Got </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_channels</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;Channel configuration:</span><span class="se">\n</span><span class="s2">&quot;</span>             
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Number of channels: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>
        
        <span class="n">num_print</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>                     
        <span class="k">if</span>  <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;channel_labels&#39;</span><span class="p">):</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Channel labels 0-</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_print</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_print</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">repres</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">num_channels</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;channel_labels&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_labels</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">channel_labels</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
         
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">channel_labels</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">num_channels</span>
        <span class="k">if</span> <span class="n">channel_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_labels</span> <span class="o">=</span> <span class="n">channel_labels</span>

<span class="k">class</span> <span class="nc">Angles</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This is a class describing the angles of the data. </span>

<span class="sd">    :param angles: The angular positions of the acquisition data</span>
<span class="sd">    :type angles: list, ndarray</span>
<span class="sd">    :param initial_angle: The angular offset of the object from the reference frame</span>
<span class="sd">    :type initial_angle: float, optional</span>
<span class="sd">    :param angle_unit: The units of the stored angles &#39;degree&#39; or &#39;radian&#39;</span>
<span class="sd">    :type angle_unit: string</span>
<span class="sd">     &#39;&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">angle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_angle_data</span>

    <span class="nd">@angle_data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">angle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;angle_data expected to be a list of floats&#39;</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_positions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_positions</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_angle_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;angle_data expected to be a list of floats&#39;</span><span class="p">)</span> 

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">initial_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_angle</span>

    <span class="nd">@initial_angle</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">initial_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;initial_angle expected a float. Got </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_angle</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">angle_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_angle_unit</span>

    <span class="nd">@angle_unit</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">angle_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">DEGREE</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">RADIAN</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;angle_unit = </span><span class="si">{}</span><span class="s1"> not recognised please specify </span><span class="se">\&#39;</span><span class="s1">degree</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">radian</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_angle_unit</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;Acquisition description:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Number of positions: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_positions</span><span class="p">)</span>
        <span class="n">num_print</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_positions</span><span class="p">)</span>    
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Angles 0-</span><span class="si">{0}</span><span class="s2"> in </span><span class="si">{1}</span><span class="s2">s:</span><span class="se">\n</span><span class="si">{2}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_print</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_unit</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_print</span><span class="p">],</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">repres</span>   

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_unit</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">angle_unit</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_angle</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">initial_angle</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">angle_data</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
         
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">initial_angle</span><span class="p">,</span> <span class="n">angle_unit</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_data</span> <span class="o">=</span> <span class="n">angles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_angle</span> <span class="o">=</span> <span class="n">initial_angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_unit</span> <span class="o">=</span> <span class="n">angle_unit</span>

<span class="k">class</span> <span class="nc">Configuration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This class holds the description of the system components. </span>
<span class="sd">     &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units_distance</span><span class="o">=</span><span class="s1">&#39;units distance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#has distances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#has angles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#has distances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">Channels</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units_distance</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">configured</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please configure AcquisitionGeometry using one of the following methods:</span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\n\t</span><span class="s2">AcquisitionGeometry.create_Parallel2D()</span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\n\t</span><span class="s2">AcquisitionGeometry.create_Cone3D()</span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\n\t</span><span class="s2">AcquisitionGeometry.create_Parallel2D()</span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\n\t</span><span class="s2">AcquisitionGeometry.create_Cone3D()&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">configured</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please configure angular data using the set_angles() method&quot;</span><span class="p">)</span>
            <span class="n">configured</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please configure the panel using the set_panel() method&quot;</span><span class="p">)</span>
            <span class="n">configured</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">configured</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">panel</span><span class="p">)</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>

            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Distances in units: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">repres</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">system</span>\
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">panel</span>\
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">channels</span>\
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="AcquisitionGeometry"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry">[docs]</a><span class="k">class</span> <span class="nc">AcquisitionGeometry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class holds the AcquisitionGeometry of the system.</span>
<span class="sd">    </span>
<span class="sd">    Please initialise the AcquisitionGeometry using the using the static methods:</span>

<span class="sd">    `AcquisitionGeometry.create_Parallel2D()`</span>

<span class="sd">    `AcquisitionGeometry.create_Cone2D()`</span>

<span class="sd">    `AcquisitionGeometry.create_Parallel3D()`</span>

<span class="sd">    `AcquisitionGeometry.create_Cone3D()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RANDOM</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>
    <span class="n">RANDOM_INT</span> <span class="o">=</span> <span class="s1">&#39;random_int&#39;</span>
    <span class="n">ANGLE_UNIT</span> <span class="o">=</span> <span class="s1">&#39;angle_unit&#39;</span>
    <span class="n">DEGREE</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span>
    <span class="n">RADIAN</span> <span class="o">=</span> <span class="s1">&#39;radian&#39;</span>
    <span class="n">CHANNEL</span> <span class="o">=</span> <span class="s1">&#39;channel&#39;</span>
    <span class="n">ANGLE</span> <span class="o">=</span> <span class="s1">&#39;angle&#39;</span>
    <span class="n">VERTICAL</span> <span class="o">=</span> <span class="s1">&#39;vertical&#39;</span>
    <span class="n">HORIZONTAL</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span>
    <span class="n">PARALLEL</span> <span class="o">=</span> <span class="s1">&#39;parallel&#39;</span>
    <span class="n">CONE</span> <span class="o">=</span> <span class="s1">&#39;cone&#39;</span>
    <span class="n">DIM2</span> <span class="o">=</span> <span class="s1">&#39;2D&#39;</span>
    <span class="n">DIM3</span> <span class="o">=</span> <span class="s1">&#39;3D&#39;</span>

    <span class="c1">#for backwards compatibility</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geom_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">geometry</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_projections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>       

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixel_num_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@pixel_num_h</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pixel_num_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixel_num_v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@pixel_num_v</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pixel_num_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixel_size_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@pixel_size_h</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pixel_size_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixel_size_v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@pixel_size_v</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pixel_size_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">num_channels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">angle_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dist_source_center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">calculate_magnification</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dist_center_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">calculate_magnification</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">magnification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">calculate_magnification</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">dimension</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">shape_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span>
                     <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">num_positions</span><span class="p">,</span>
                     <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>        
                     <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">labels_default</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">CIL_AG_LABELS</span>

        <span class="n">shape_default</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">num_positions</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels_default</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1">#remove from list labels where len == 1</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shape_default</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">labels_default</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#if not in custom list carry on</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
      
    <span class="nd">@dimension_labels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>

        <span class="n">labels_default</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">CIL_AG_LABELS</span>

        <span class="c1">#check input and store. This value is not used directly</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels_default</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Requested axis are not possible. Accepted label names </span><span class="si">{}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels_default</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
                    
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">system_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">system_description</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>

    <span class="nd">@dtype</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">val</span>       


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span>


    <span class="k">def</span> <span class="nf">get_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance_units</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">angle_units</span><span class="o">=</span><span class="s1">&#39;radian&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the system centre of rotation offset at the detector</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">         - Origin is in the centre of the detector</span>
<span class="sd">         - Axes directions are specified by detector.direction_x, detector.direction_y</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        distance_units : string, default=&#39;default&#39;</span>
<span class="sd">            Units of distance used to calculate the return values.</span>
<span class="sd">            &#39;default&#39; uses the same units the system and panel were specified in.</span>
<span class="sd">            &#39;pixels&#39; uses pixels sizes in the horizontal and vertical directions as appropriate.</span>
<span class="sd">        angle_units : string</span>
<span class="sd">            Units to return the angle in. Can take &#39;radian&#39; or &#39;degree&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dictionary</span>
<span class="sd">            {&#39;offset&#39;: (offset, distance_units), &#39;angle&#39;: (angle, angle_units)}</span>
<span class="sd">            where,</span>
<span class="sd">            &#39;offset&#39; gives the position along the detector x_axis at y=0</span>
<span class="sd">            &#39;angle&#39; gives the angle between the y_axis and the projection of the rotation axis on the detector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="s1">&#39;calculate_centre_of_rotation&#39;</span><span class="p">):</span>
            <span class="n">offset_distance</span><span class="p">,</span> <span class="n">angle_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">calculate_centre_of_rotation</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="n">distance_units</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_distance</span>
            <span class="n">offset_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">units</span>
        <span class="k">elif</span> <span class="n">distance_units</span> <span class="o">==</span> <span class="s1">&#39;pixels&#39;</span><span class="p">:</span>

            <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_distance</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">offset_units</span> <span class="o">=</span> <span class="s1">&#39;pixels&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1">#if aspect ratio of pixels isn&#39;t 1:1 need to convert angle by new ratio</span>
                <span class="n">y_pix</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">x_pix</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span><span class="n">y_pix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`distance_units` is not recognised. Must be &#39;default&#39; or &#39;pixels&#39;. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">distance_units</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">angle_units</span> <span class="o">==</span> <span class="s1">&#39;radian&#39;</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_rad</span>
            <span class="n">ang_units</span> <span class="o">=</span> <span class="s1">&#39;radian&#39;</span>
        <span class="k">elif</span> <span class="n">angle_units</span> <span class="o">==</span> <span class="s1">&#39;degree&#39;</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span>
            <span class="n">ang_units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`angle_units` is not recognised. Must be &#39;radian&#39; or &#39;degree&#39;. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">angle_units</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset_units</span><span class="p">),</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">ang_units</span><span class="p">)}</span>


    <span class="k">def</span> <span class="nf">set_centre_of_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">distance_units</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">angle_units</span><span class="o">=</span><span class="s1">&#39;radian&#39;</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configures the system geometry to have the requested centre of rotation offset at the detector.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">         - Origin is in the centre of the detector</span>
<span class="sd">         - Axes directions are specified by detector.direction_x, detector.direction_y</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        offset: float, default 0.0</span>
<span class="sd">            The position of the centre of rotation along the detector x_axis at y=0</span>

<span class="sd">        distance_units : string, default=&#39;default&#39;</span>
<span class="sd">            Units the offset is specified in. Can be &#39;default&#39;or &#39;pixels&#39;.</span>
<span class="sd">            &#39;default&#39; interprets the input as same units the system and panel were specified in.</span>
<span class="sd">            &#39;pixels&#39; interprets the input in horizontal pixels.</span>

<span class="sd">        angle: float, default=0.0</span>
<span class="sd">            The angle between the detector y_axis and the rotation axis direction on the detector</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            If aspect ratio of pixels is not 1:1 ensure the angle is calculated from the x and y values in the correct units.</span>

<span class="sd">        angle_units : string, default=&#39;radian&#39;</span>
<span class="sd">            Units the angle is specified in. Can take &#39;radian&#39; or &#39;degree&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="s1">&#39;set_centre_of_rotation&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">angle_units</span> <span class="o">==</span> <span class="s1">&#39;radian&#39;</span><span class="p">:</span>
            <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">angle</span>
        <span class="k">elif</span> <span class="n">angle_units</span> <span class="o">==</span> <span class="s1">&#39;degree&#39;</span><span class="p">:</span>
            <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`angle_units` is not recognised. Must be &#39;radian&#39; or &#39;degree&#39;. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">angle_units</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">distance_units</span> <span class="o">==</span><span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">offset_distance</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">elif</span> <span class="n">distance_units</span> <span class="o">==</span><span class="s1">&#39;pixels&#39;</span><span class="p">:</span>
            <span class="n">offset_distance</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`distance_units` is not recognised. Must be &#39;default&#39; or &#39;pixels&#39;. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">distance_units</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">set_centre_of_rotation</span><span class="p">(</span><span class="n">offset_distance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">set_centre_of_rotation</span><span class="p">(</span><span class="n">offset_distance</span><span class="p">,</span> <span class="n">angle_rad</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">set_centre_of_rotation_by_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset1</span><span class="p">,</span> <span class="n">slice_index1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slice_index2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configures the system geometry to have the requested centre of rotation offset at the detector.</span>
<span class="sd">        </span>
<span class="sd">        If two slices are passed the rotation axis will be rotated to pass through both points.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">         - Offset is specified in pixels</span>
<span class="sd">         - Offset can be sub-pixels</span>
<span class="sd">         - Offset direction is specified by detector.direction_x</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        offset1: float</span>
<span class="sd">            The offset from the centre of the detector to the projected rotation position at slice_index_1</span>
<span class="sd">        </span>
<span class="sd">        slice_index1: int, optional</span>
<span class="sd">            The slice number of offset1</span>

<span class="sd">        offset2: float, optional</span>
<span class="sd">            The offset from the centre of the detector to the projected rotation position at slice_index_2</span>
<span class="sd">        </span>
<span class="sd">        slice_index2: int, optional</span>
<span class="sd">            The slice number of offset2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="s1">&#39;set_centre_of_rotation&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">offset2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">(</span><span class="s2">&quot;Only offset1 is being used&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_centre_of_rotation</span><span class="p">(</span><span class="n">offset1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">offset2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">offset1</span> <span class="o">==</span> <span class="n">offset2</span><span class="p">:</span>
            <span class="n">offset_x_y0</span> <span class="o">=</span> <span class="n">offset1</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slice_index1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">slice_index2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">slice_index1</span> <span class="o">==</span> <span class="n">slice_index2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot calculate angle. Please specify `slice_index1` and `slice_index2` to define a rotated axis&quot;</span><span class="p">)</span>

            <span class="n">offset_x_y0</span> <span class="o">=</span> <span class="n">offset1</span> <span class="o">-</span><span class="n">slice_index1</span> <span class="o">*</span> <span class="p">(</span><span class="n">offset2</span> <span class="o">-</span> <span class="n">offset1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">slice_index2</span><span class="o">-</span><span class="n">slice_index1</span><span class="p">)</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">offset2</span> <span class="o">-</span> <span class="n">offset1</span><span class="p">,</span> <span class="n">slice_index2</span> <span class="o">-</span> <span class="n">slice_index1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_centre_of_rotation</span><span class="p">(</span><span class="n">offset_x_y0</span><span class="p">,</span> <span class="s1">&#39;pixels&#39;</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="s1">&#39;radian&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="AcquisitionGeometry.set_angles"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.set_angles">[docs]</a>    <span class="k">def</span> <span class="nf">set_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">initial_angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">angle_unit</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This method configures the angular information of an AcquisitionGeometry object. </span>

<span class="sd">        :param angles: The angular positions of the acquisition data</span>
<span class="sd">        :type angles: list, ndarray</span>
<span class="sd">        :param initial_angle: The angular offset of the object from the reference frame</span>
<span class="sd">        :type initial_angle: float, optional</span>
<span class="sd">        :param angle_unit: The units of the stored angles &#39;degree&#39; or &#39;radian&#39;</span>
<span class="sd">        :type angle_unit: string</span>
<span class="sd">        :return: returns a configured AcquisitionGeometry object</span>
<span class="sd">        :rtype: AcquisitionGeometry        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="n">Angles</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">initial_angle</span><span class="p">,</span> <span class="n">angle_unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AcquisitionGeometry.set_panel"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.set_panel">[docs]</a>    <span class="k">def</span> <span class="nf">set_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;bottom-left&#39;</span><span class="p">):</span>

<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This method configures the panel information of an AcquisitionGeometry object. </span>
<span class="sd">                    </span>
<span class="sd">        :param num_pixels: num_pixels_h or (num_pixels_h, num_pixels_v) containing the number of pixels of the panel</span>
<span class="sd">        :type num_pixels: int, list, tuple</span>
<span class="sd">        :param pixel_size: pixel_size_h or (pixel_size_h, pixel_size_v) containing the size of the pixels of the panel</span>
<span class="sd">        :type pixel_size: int, list, tuple, optional</span>
<span class="sd">        :param origin: the position of pixel 0 (the data origin) of the panel &#39;top-left&#39;, &#39;top-right&#39;, &#39;bottom-left&#39;, &#39;bottom-right&#39;</span>
<span class="sd">        :type origin: string, default &#39;bottom-left&#39;</span>
<span class="sd">        :return: returns a configured AcquisitionGeometry object</span>
<span class="sd">        :rtype: AcquisitionGeometry       </span>
<span class="sd">        &#39;&#39;&#39;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">num_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">_dimension</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AcquisitionGeometry.set_channels"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.set_channels">[docs]</a>    <span class="k">def</span> <span class="nf">set_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">channel_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This method configures the channel information of an AcquisitionGeometry object. </span>
<span class="sd">                        </span>
<span class="sd">        :param num_channels: The number of channels of data</span>
<span class="sd">        :type num_channels: int, optional</span>
<span class="sd">        :param channel_labels: A list of channel labels</span>
<span class="sd">        :type channel_labels: list, optional</span>
<span class="sd">        :return: returns a configured AcquisitionGeometry object</span>
<span class="sd">        :rtype: AcquisitionGeometry        </span>
<span class="sd">        &#39;&#39;&#39;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">Channels</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">channel_labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AcquisitionGeometry.set_labels"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.set_labels">[docs]</a>    <span class="k">def</span> <span class="nf">set_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This method configures the dimension labels of an AcquisitionGeometry object. </span>
<span class="sd">                        </span>
<span class="sd">        :param labels:  The order of the dimensions describing the data.\</span>
<span class="sd">                        Expects a list containing at least one of the unique labels: &#39;channel&#39; &#39;angle&#39; &#39;vertical&#39; &#39;horizontal&#39;</span>
<span class="sd">                        default = [&#39;channel&#39;,&#39;angle&#39;,&#39;vertical&#39;,&#39;horizontal&#39;]</span>
<span class="sd">        :type labels: list, optional</span>
<span class="sd">        :return: returns a configured AcquisitionGeometry object</span>
<span class="sd">        :rtype: AcquisitionGeometry        </span>
<span class="sd">        &#39;&#39;&#39;</span>           
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="k">return</span> <span class="bp">self</span></div>
 
<div class="viewcode-block" id="AcquisitionGeometry.create_Parallel2D"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.create_Parallel2D">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_Parallel2D</span><span class="p">(</span><span class="n">ray_direction</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">detector_position</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">detector_direction_x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">rotation_axis_position</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units distance&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This creates the AcquisitionGeometry for a parallel beam 2D tomographic system</span>

<span class="sd">        :param ray_direction: A 2D vector describing the x-ray direction (x,y)</span>
<span class="sd">        :type ray_direction: list, tuple, ndarray, optional</span>
<span class="sd">        :param detector_position: A 2D vector describing the position of the centre of the detector (x,y)</span>
<span class="sd">        :type detector_position: list, tuple, ndarray, optional</span>
<span class="sd">        :param detector_direction_x: A 2D vector describing the direction of the detector_x (x,y)</span>
<span class="sd">        :type detector_direction_x: list, tuple, ndarray</span>
<span class="sd">        :param rotation_axis_position: A 2D vector describing the position of the axis of rotation (x,y)</span>
<span class="sd">        :type rotation_axis_position: list, tuple, ndarray, optional</span>
<span class="sd">        :param units: Label the units of distance used for the configuration, these should be consistent for the geometry and panel</span>
<span class="sd">        :type units: string</span>
<span class="sd">        :return: returns a configured AcquisitionGeometry object</span>
<span class="sd">        :rtype: AcquisitionGeometry</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">AG</span> <span class="o">=</span> <span class="n">AcquisitionGeometry</span><span class="p">()</span>
        <span class="n">AG</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">AG</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">Parallel2D</span><span class="p">(</span><span class="n">ray_direction</span><span class="p">,</span> <span class="n">detector_position</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">rotation_axis_position</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AG</span>    </div>

<div class="viewcode-block" id="AcquisitionGeometry.create_Cone2D"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.create_Cone2D">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_Cone2D</span><span class="p">(</span><span class="n">source_position</span><span class="p">,</span> <span class="n">detector_position</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rotation_axis_position</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units distance&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This creates the AcquisitionGeometry for a cone beam 2D tomographic system          </span>

<span class="sd">        :param source_position: A 2D vector describing the position of the source (x,y)</span>
<span class="sd">        :type source_position: list, tuple, ndarray</span>
<span class="sd">        :param detector_position: A 2D vector describing the position of the centre of the detector (x,y)</span>
<span class="sd">        :type detector_position: list, tuple, ndarray</span>
<span class="sd">        :param detector_direction_x: A 2D vector describing the direction of the detector_x (x,y)</span>
<span class="sd">        :type detector_direction_x: list, tuple, ndarray</span>
<span class="sd">        :param rotation_axis_position: A 2D vector describing the position of the axis of rotation (x,y)</span>
<span class="sd">        :type rotation_axis_position: list, tuple, ndarray, optional</span>
<span class="sd">        :param units: Label the units of distance used for the configuration, these should be consistent for the geometry and panel</span>
<span class="sd">        :type units: string</span>
<span class="sd">        :return: returns a configured AcquisitionGeometry object</span>
<span class="sd">        :rtype: AcquisitionGeometry        </span>
<span class="sd">     &#39;&#39;&#39;</span>    
        <span class="n">AG</span> <span class="o">=</span> <span class="n">AcquisitionGeometry</span><span class="p">()</span>
        <span class="n">AG</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">AG</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">Cone2D</span><span class="p">(</span><span class="n">source_position</span><span class="p">,</span> <span class="n">detector_position</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">rotation_axis_position</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AG</span>   </div>

<div class="viewcode-block" id="AcquisitionGeometry.create_Parallel3D"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.create_Parallel3D">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_Parallel3D</span><span class="p">(</span><span class="n">ray_direction</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">detector_position</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">detector_direction_x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">detector_direction_y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotation_axis_position</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rotation_axis_direction</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units distance&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This creates the AcquisitionGeometry for a parallel beam 3D tomographic system</span>
<span class="sd">                       </span>
<span class="sd">        :param ray_direction: A 3D vector describing the x-ray direction (x,y,z)</span>
<span class="sd">        :type ray_direction: list, tuple, ndarray, optional</span>
<span class="sd">        :param detector_position: A 3D vector describing the position of the centre of the detector (x,y,z)</span>
<span class="sd">        :type detector_position: list, tuple, ndarray, optional</span>
<span class="sd">        :param detector_direction_x: A 3D vector describing the direction of the detector_x (x,y,z)</span>
<span class="sd">        :type detector_direction_x: list, tuple, ndarray</span>
<span class="sd">        :param detector_direction_y: A 3D vector describing the direction of the detector_y (x,y,z)</span>
<span class="sd">        :type detector_direction_y: list, tuple, ndarray</span>
<span class="sd">        :param rotation_axis_position: A 3D vector describing the position of the axis of rotation (x,y,z)</span>
<span class="sd">        :type rotation_axis_position: list, tuple, ndarray, optional</span>
<span class="sd">        :param rotation_axis_direction: A 3D vector describing the direction of the axis of rotation (x,y,z)</span>
<span class="sd">        :type rotation_axis_direction: list, tuple, ndarray, optional</span>
<span class="sd">        :param units: Label the units of distance used for the configuration, these should be consistent for the geometry and panel</span>
<span class="sd">        :type units: string</span>
<span class="sd">        :return: returns a configured AcquisitionGeometry object</span>
<span class="sd">        :rtype: AcquisitionGeometry       </span>
<span class="sd">     &#39;&#39;&#39;</span>
        <span class="n">AG</span> <span class="o">=</span> <span class="n">AcquisitionGeometry</span><span class="p">()</span>
        <span class="n">AG</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">AG</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">Parallel3D</span><span class="p">(</span><span class="n">ray_direction</span><span class="p">,</span> <span class="n">detector_position</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">detector_direction_y</span><span class="p">,</span> <span class="n">rotation_axis_position</span><span class="p">,</span> <span class="n">rotation_axis_direction</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AG</span>            </div>

<div class="viewcode-block" id="AcquisitionGeometry.create_Cone3D"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.create_Cone3D">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_Cone3D</span><span class="p">(</span><span class="n">source_position</span><span class="p">,</span> <span class="n">detector_position</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">detector_direction_y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotation_axis_position</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rotation_axis_direction</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;units distance&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;This creates the AcquisitionGeometry for a cone beam 3D tomographic system</span>
<span class="sd">                        </span>
<span class="sd">        :param source_position: A 3D vector describing the position of the source (x,y,z)</span>
<span class="sd">        :type source_position: list, tuple, ndarray, optional</span>
<span class="sd">        :param detector_position: A 3D vector describing the position of the centre of the detector (x,y,z)</span>
<span class="sd">        :type detector_position: list, tuple, ndarray, optional</span>
<span class="sd">        :param detector_direction_x: A 3D vector describing the direction of the detector_x (x,y,z)</span>
<span class="sd">        :type detector_direction_x: list, tuple, ndarray</span>
<span class="sd">        :param detector_direction_y: A 3D vector describing the direction of the detector_y (x,y,z)</span>
<span class="sd">        :type detector_direction_y: list, tuple, ndarray</span>
<span class="sd">        :param rotation_axis_position: A 3D vector describing the position of the axis of rotation (x,y,z)</span>
<span class="sd">        :type rotation_axis_position: list, tuple, ndarray, optional</span>
<span class="sd">        :param rotation_axis_direction: A 3D vector describing the direction of the axis of rotation (x,y,z)</span>
<span class="sd">        :type rotation_axis_direction: list, tuple, ndarray, optional</span>
<span class="sd">        :param units: Label the units of distance used for the configuration, these should be consistent for the geometry and panel</span>
<span class="sd">        :type units: string</span>
<span class="sd">        :return: returns a configured AcquisitionGeometry object</span>
<span class="sd">        :rtype: AcquisitionGeometry           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">AG</span> <span class="o">=</span> <span class="n">AcquisitionGeometry</span><span class="p">()</span>
        <span class="n">AG</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">AG</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">Cone3D</span><span class="p">(</span><span class="n">source_position</span><span class="p">,</span> <span class="n">detector_position</span><span class="p">,</span> <span class="n">detector_direction_x</span><span class="p">,</span> <span class="n">detector_direction_y</span><span class="p">,</span> <span class="n">rotation_axis_position</span><span class="p">,</span> <span class="n">rotation_axis_direction</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AG</span></div>

    <span class="k">def</span> <span class="nf">get_order_by_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension_labels</span><span class="p">,</span> <span class="n">default_dimension_labels</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">default_dimension_labels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ek</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dimension_labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="n">ek</span><span class="p">:</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">order</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">config</span> <span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a copy of the AcquisitionGeometry&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;alias of clone&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_centre_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a 2D AcquisitionGeometry that corresponds to the centre slice of the input&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
              
        <span class="n">AG_2D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">AG_2D</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">get_centre_slice</span><span class="p">()</span>
        <span class="n">AG_2D</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">AG_2D</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">direction_y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">AG_2D</span>

<div class="viewcode-block" id="AcquisitionGeometry.get_ImageGeometry"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.get_ImageGeometry">[docs]</a>    <span class="k">def</span> <span class="nf">get_ImageGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a default configured ImageGeometry object based on the AcquisitionGeomerty&#39;&#39;&#39;</span>

        <span class="n">num_voxel_xy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">))</span>
        <span class="n">voxel_size_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnification</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
            <span class="n">num_voxel_z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">))</span>
            <span class="n">voxel_size_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnification</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_voxel_z</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">voxel_size_z</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">return</span> <span class="n">ImageGeometry</span><span class="p">(</span><span class="n">num_voxel_xy</span><span class="p">,</span> <span class="n">num_voxel_xy</span><span class="p">,</span> <span class="n">num_voxel_z</span><span class="p">,</span> <span class="n">voxel_size_xy</span><span class="p">,</span> <span class="n">voxel_size_xy</span><span class="p">,</span> <span class="n">voxel_size_z</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>


<div class="viewcode-block" id="AcquisitionGeometry.get_slice"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.get_slice">[docs]</a>    <span class="k">def</span> <span class="nf">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a new AcquisitionGeometry of a single slice of in the requested direction. Will only return reconstructable geometries.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">geometry_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geometry_new</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">geometry_new</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span><span class="s1">&#39;channel_labels&#39;</span><span class="p">):</span>
                <span class="n">geometry_new</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">channel_labels</span> <span class="o">=</span> <span class="n">geometry_new</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">channel_labels</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geometry_new</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">angle_data</span> <span class="o">=</span> <span class="n">geometry_new</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">angle_data</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">vertical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">geometry_new</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">PARALLEL</span> <span class="ow">or</span> <span class="n">vertical</span> <span class="o">==</span> <span class="s1">&#39;centre&#39;</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">geometry_new</span><span class="o">.</span><span class="n">pixel_num_v</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">vertical</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                <span class="n">geometry_new</span> <span class="o">=</span> <span class="n">geometry_new</span><span class="o">.</span><span class="n">get_centre_slice</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can only subset centre slice geometry on cone-beam data. Expected vertical = &#39;centre&#39;. Got vertical = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vertical</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">horizontal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot calculate system geometry for a horizontal slice&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">geometry_new</span></div>

<div class="viewcode-block" id="AcquisitionGeometry.allocate"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionGeometry.allocate">[docs]</a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;allocates an AcquisitionData according to the size expressed in the instance</span>
<span class="sd">        </span>
<span class="sd">        :param value: accepts numbers to allocate an uniform array, or a string as &#39;random&#39; or &#39;random_int&#39; to create a random array or None.</span>
<span class="sd">        :type value: number or string, default None allocates empty memory block</span>
<span class="sd">        :param dtype: numerical type to allocate</span>
<span class="sd">        :type dtype: numpy type, default numpy.float32</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Deprecated: &#39;dimension_labels&#39; cannot be set with &#39;allocate()&#39;. Use &#39;geometry.set_labels()&#39; to modify the geometry before using allocate.&quot;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">AcquisitionData</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> 
                                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                                <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="c1"># it&#39;s created empty, so we make it 0</span>
            <span class="n">out</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">RANDOM_INT</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_value&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">max_value</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value </span><span class="si">{}</span><span class="s1"> unknown&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">out</span></div></div>

<div class="viewcode-block" id="DataContainer"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer">[docs]</a><span class="k">class</span> <span class="nc">DataContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Generic class to hold data</span>
<span class="sd">    </span>
<span class="sd">    Data is currently held in a numpy arrays&#39;&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@geometry</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;DataContainers cannot hold a geometry, use ImageData or AcquisitionData instead&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_dimensions</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_dimensions</span><span class="p">):</span>
                <span class="n">default_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dimension_</span><span class="si">{0:02}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">default_labels</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span>
      
    <span class="nd">@dimension_labels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_dimensions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dimension_labels expected a list containing </span><span class="si">{0}</span><span class="s2"> strings got </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_dimensions</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the shape of the DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the ndim of the DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">ndim</span>        

    <span class="nd">@shape</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deprecated - shape will be set automatically&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">number_of_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the shape of the  of the DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the dtype of the data array.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the number of elements of the DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">size</span>

    <span class="n">__container_priority__</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">deep_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dimension_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Holds the data&#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">deep_copy</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">array</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Array must be NumpyArray, passed </span><span class="si">{0}</span><span class="s1">&#39;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)))</span>

        <span class="c1">#Don&#39;t set for derived classes</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataContainer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">=</span> <span class="n">dimension_labels</span>

        <span class="c1"># finally copy the geometry, and force dtype of the geometry of the data = the dype of the data</span>
        <span class="k">if</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>            
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>    
        
    <span class="k">def</span> <span class="nf">get_dimension_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension_label</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dimension_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dimension_label</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown dimension </span><span class="si">{0}</span><span class="s1">. Should be one of </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dimension_label</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">get_dimension_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension_label</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dimension_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dimension_label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown dimension </span><span class="si">{0}</span><span class="s1">. Should be one of </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dimension_label</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">))</span>
                        
<div class="viewcode-block" id="DataContainer.as_array"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.as_array">[docs]</a>    <span class="k">def</span> <span class="nf">as_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the pointer to the array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span></div>


<div class="viewcode-block" id="DataContainer.get_slice"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.get_slice">[docs]</a>    <span class="k">def</span> <span class="nf">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a new DataContainer containing a single slice of in the requested direction. \</span>
<span class="sd">        Pass keyword arguments &lt;dimension label&gt;=index</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new_array</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#get ordered list of current dimensions</span>
        <span class="n">dimension_labels_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">)</span>

        <span class="c1">#remove axes from array and labels</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">dimension_labels_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">dimension_labels_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_array</span> <span class="o">=</span> <span class="n">new_array</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DataContainer</span><span class="p">(</span><span class="n">new_array</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dimension_labels_list</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">VectorData</span><span class="p">(</span><span class="n">new_array</span><span class="p">,</span> <span class="n">dimension_labels</span><span class="o">=</span><span class="n">dimension_labels_list</span><span class="p">)</span></div>
                    
<div class="viewcode-block" id="DataContainer.reorder"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.reorder">[docs]</a>    <span class="k">def</span> <span class="nf">reorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        reorders the data in memory as requested.</span>

<span class="sd">        :param order: ordered list of labels from self.dimension_labels, or order for engine &#39;astra&#39; or &#39;tigre&#39;</span>
<span class="sd">        :type order: list, sting     </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">ENGINES</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">get_order_for_engine</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>  

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The axes list for resorting must have </span><span class="si">{0}</span><span class="s1"> dimensions. Got </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The order must be an iterable with __len__ implemented, like a list or a tuple. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">order</span><span class="p">)))</span>
        
        <span class="n">correct</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">correct</span> <span class="o">=</span> <span class="n">correct</span> <span class="ow">and</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">correct</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The axes list for resorting must contain the dimension_labels </span><span class="si">{0}</span><span class="s1"> got </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>
            
        <span class="n">new_order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">dimension_labels_new</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
            <span class="n">new_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">dimension_labels_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">new_order</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">=</span> <span class="n">dimension_labels_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">set_labels</span><span class="p">(</span><span class="n">dimension_labels_new</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DataContainer.fill"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.fill">[docs]</a>    <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="o">**</span><span class="n">dimension</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;fills the internal data array with the DataContainer, numpy array or number provided</span>
<span class="sd">        </span>
<span class="sd">        :param array: number, numpy array or DataContainer to copy into the DataContainer</span>
<span class="sd">        :type array: DataContainer or subclasses, numpy array or number</span>
<span class="sd">        :param dimension: dictionary, optional</span>
<span class="sd">        </span>
<span class="sd">        if the passed numpy array points to the same array that is contained in the DataContainer,</span>
<span class="sd">        it just returns</span>

<span class="sd">        In case a DataContainer or subclass is passed, there will be a check of the geometry, </span>
<span class="sd">        if present, and the array will be resorted if the data is not in the appropriate order.</span>

<span class="sd">        User may pass a named parameter to specify in which axis the fill should happen:</span>

<span class="sd">        dc.fill(some_data, vertical=1, horizontal_x=32)</span>
<span class="sd">        will copy the data in some_data into the data container.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot fill with the provided array.&#39;</span> <span class="o">+</span> \
                                     <span class="s1">&#39;Expecting shape </span><span class="si">{0}</span><span class="s1"> got </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> 
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="vm">__class__</span> <span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">!=</span> <span class="n">array</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input array is not in the same order as destination array. Use &quot;array.reorder()&quot;&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot fill with the provided array.&#39;</span> <span class="o">+</span> \
                                     <span class="s1">&#39;Expecting shape </span><span class="si">{0}</span><span class="s1"> got </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Can fill only with number, numpy array or DataContainer and subclasses. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">]</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_dimensions</span>
            <span class="n">dimension_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dimension</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">dimension_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;self.array[&#39;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot;] = array[:]&quot;</span> 
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot;] = array.as_array()[:]&quot;</span> 
            <span class="k">elif</span> <span class="nb">isinstance</span> <span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot;] = array&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Can fill only with number, numpy array or DataContainer and subclasses. Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)))</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">command</span><span class="p">)</span></div>
            
        
    <span class="k">def</span> <span class="nf">check_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="c1">## algebra </span>
    
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        
    
    <span class="c1"># reverse operand</span>
    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">+</span> <span class="n">other</span>
    <span class="c1"># __radd__</span>
    
    <span class="k">def</span> <span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">other</span>
    <span class="c1"># __rsub__</span>
    
    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="n">other</span>
    <span class="c1"># __rmul__</span>
    
    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">*=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">tmp</span>
    <span class="c1"># __rdiv__</span>
    <span class="k">def</span> <span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rdiv__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__rpow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">fother</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">))</span> <span class="o">*</span> <span class="n">other</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">fother</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="p">,</span> 
                           <span class="n">dimension_labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">,</span>
                           <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
    <span class="c1"># __rpow__</span>
    
    <span class="c1"># in-place arithmetic operators:</span>
    <span class="c1"># (+=, -=, *=, /= , //=,</span>
    <span class="c1"># must return self</span>
    
    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__idiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__itruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="bp">self</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;negation operator&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span>   
    
    <span class="k">def</span> <span class="fm">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">representation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Number of dimensions: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_dimensions</span><span class="p">)</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Shape: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Axis labels: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">representation</span><span class="p">:</span>
            <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Representation: </span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">repres</span>
        
<div class="viewcode-block" id="DataContainer.get_data_axes_order"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.get_data_axes_order">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_axes_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns the axes label of self as a list</span>
<span class="sd">        </span>
<span class="sd">        if new_order is None returns the labels of the axes as a sorted-by-key list</span>
<span class="sd">        if new_order is a list of length number_of_dimensions, returns a list</span>
<span class="sd">        with the indices of the axes in new_order with respect to those in </span>
<span class="sd">        self.dimension_labels: i.e.</span>
<span class="sd">          self.dimension_labels = {0:&#39;horizontal&#39;,1:&#39;vertical&#39;}</span>
<span class="sd">          new_order = [&#39;vertical&#39;,&#39;horizontal&#39;]</span>
<span class="sd">          returns [1,0]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">new_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_order</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_dimensions</span><span class="p">:</span>

                <span class="n">axes_order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_order</span><span class="p">):</span>
                    <span class="n">axes_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">axes_order</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expecting </span><span class="si">{0}</span><span class="s1"> axes, got </span><span class="si">{2}</span><span class="s1">&#39;</span>\
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">new_order</span><span class="p">)))</span></div>
        
<div class="viewcode-block" id="DataContainer.clone"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a copy of DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataContainer.copy"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;alias of clone&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span></div>
    
    <span class="c1">## binary operations</span>
            
    <span class="k">def</span> <span class="nf">pixel_wise_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pwop</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>    
        <span class="n">out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="p">,</span> <span class="n">x2</span> <span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">x2</span><span class="o">.</span><span class="vm">__class__</span> <span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="p">,</span> <span class="n">x2</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="p">,</span> <span class="n">x2</span> <span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Expected x2 type as number or DataContainer, got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x2</span><span class="p">)))</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span>
            <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">out</span><span class="p">,</span>
                   <span class="n">deep_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                   <span class="n">dimension_labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">,</span>
                   <span class="n">geometry</span><span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> 
                   <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">DataContainer</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">x2</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
                <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="n">x2</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
                <span class="c1">#return type(self)(out.as_array(),</span>
                <span class="c1">#       deep_copy=False, </span>
                <span class="c1">#       dimension_labels=self.dimension_labels,</span>
                <span class="c1">#       geometry=self.geometry)</span>
                <span class="k">return</span> <span class="n">out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="s2">&quot;Wrong size for data memory: out </span><span class="si">{}</span><span class="s2"> x2 </span><span class="si">{}</span><span class="s2"> expected </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">x2</span><span class="o">.</span><span class="n">shape</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">DataContainer</span><span class="p">)</span> <span class="ow">and</span> \
             <span class="nb">isinstance</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span>\
                    <span class="ow">not</span> <span class="p">(</span><span class="n">x2</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="ow">and</span> <span class="n">x2</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                        <span class="s2">&quot;Wrong size for data memory: out </span><span class="si">{}</span><span class="s2"> x2 </span><span class="si">{}</span><span class="s2"> expected </span><span class="si">{}</span><span class="s2">&quot;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">x2</span><span class="o">.</span><span class="n">shape</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
                <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="n">x2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="s2">&quot;Wrong size for data memory: &quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="n">x2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1">#return type(self)(out,</span>
                <span class="c1">#       deep_copy=False, </span>
                <span class="c1">#       dimension_labels=self.dimension_labels,</span>
                <span class="c1">#       geometry=self.geometry)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>  <span class="s2">&quot;incompatible class:&quot;</span> <span class="p">,</span> <span class="n">pwop</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;__container_priority__&#39;</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__container_priority__</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__container_priority__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_binary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;__container_priority__&#39;</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__container_priority__</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__container_priority__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_binary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">subtract</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;__container_priority__&#39;</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__container_priority__</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__container_priority__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_binary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">multiply</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">divide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;__container_priority__&#39;</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__container_priority__</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__container_priority__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_binary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">divide</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_binary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>    
          
    <span class="k">def</span> <span class="nf">maximum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_binary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">minimum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_binary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="DataContainer.sapyb"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.sapyb">[docs]</a>    <span class="k">def</span> <span class="nf">sapyb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">NUM_THREADS</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;performs a*self + b * y. Can be done in-place</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : multiplier for self, can be a number or a numpy array or a DataContainer</span>
<span class="sd">        y : DataContainer </span>
<span class="sd">        b : multiplier for y, can be a number or a numpy array or a DataContainer</span>
<span class="sd">        out : return DataContainer, if None a new DataContainer is returned, default None. </span>
<span class="sd">            out can be self or y.</span>
<span class="sd">        num_threads : number of threads to use during the calculation, using the CIL C library</span>
<span class="sd">        </span>
<span class="sd">        It will try to use the CIL C library and default to numpy operations, in case the C library does</span>
<span class="sd">        not handle the types.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">        -------</span>

<span class="sd">        a = 2</span>
<span class="sd">        b = 3</span>
<span class="sd">        ig = ImageGeometry(10,11)</span>
<span class="sd">        x = ig.allocate(1)</span>
<span class="sd">        y = ig.allocate(2)</span>
<span class="sd">        out = x.sapyb(a,y,b)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ret_out</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">*</span> <span class="mf">0.</span>
            <span class="n">ret_out</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span> <span class="p">]:</span>
            <span class="c1"># handle with C-lib _axpby</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_axpby</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ret_out</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">out</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">rte</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;sapyb defaulting to Python due to: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rte</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">te</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;sapyb defaulting to Python due to: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">te</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">pass</span>
        

        <span class="c1"># cannot be handled by _axpby</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">*</span> <span class="n">a</span>
        <span class="n">y</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ret_out</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="nf">_axpby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">NUM_THREADS</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;performs axpby with cilacc C library, can be done in-place.</span>
<span class="sd">        </span>
<span class="sd">        Does the operation .. math:: a*x+b*y and stores the result in out, where x is self</span>

<span class="sd">        :param a: scalar</span>
<span class="sd">        :type a: float</span>
<span class="sd">        :param b: scalar</span>
<span class="sd">        :type b: float</span>
<span class="sd">        :param y: DataContainer</span>
<span class="sd">        :param out: DataContainer instance to store the result</span>
<span class="sd">        :param dtype: data type of the DataContainers</span>
<span class="sd">        :type dtype: numpy type, optional, default numpy.float32</span>
<span class="sd">        :param num_threads: number of threads to run on</span>
<span class="sd">        :type num_threads: int, optional, default 1/2 CPU of the system</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c_float_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">)</span>
        <span class="n">c_double_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)</span>

        <span class="c1">#convert a and b to numpy arrays and get the reference to the data (length = 1 or ndx.size)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nda</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">nda</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ndb</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ndb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="n">a_vec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">nda</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">a_vec</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">b_vec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">ndb</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">b_vec</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># get the reference to the data</span>
        <span class="n">ndx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="n">ndy</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="n">ndout</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ndout</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;out array of type </span><span class="si">{0}</span><span class="s2"> does not match requested dtype </span><span class="si">{1}</span><span class="s2">. Using </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndout</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">ndout</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="n">ndx</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="n">ndx</span> <span class="o">=</span> <span class="n">ndx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s1">&#39;safe&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ndy</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="n">ndy</span> <span class="o">=</span> <span class="n">ndy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s1">&#39;safe&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nda</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="n">nda</span> <span class="o">=</span> <span class="n">nda</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s1">&#39;same_kind&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ndb</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="n">ndb</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s1">&#39;same_kind&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
            <span class="n">x_p</span> <span class="o">=</span> <span class="n">ndx</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">)</span>
            <span class="n">y_p</span> <span class="o">=</span> <span class="n">ndy</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">)</span>
            <span class="n">out_p</span> <span class="o">=</span> <span class="n">ndout</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">)</span>
            <span class="n">a_p</span> <span class="o">=</span> <span class="n">nda</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">)</span>
            <span class="n">b_p</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">cilacc</span><span class="o">.</span><span class="n">saxpby</span>

        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
            <span class="n">x_p</span> <span class="o">=</span> <span class="n">ndx</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_double_p</span><span class="p">)</span>
            <span class="n">y_p</span> <span class="o">=</span> <span class="n">ndy</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_double_p</span><span class="p">)</span>
            <span class="n">out_p</span> <span class="o">=</span> <span class="n">ndout</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_double_p</span><span class="p">)</span>
            <span class="n">a_p</span> <span class="o">=</span> <span class="n">nda</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_double_p</span><span class="p">)</span>
            <span class="n">b_p</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_double_p</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">cilacc</span><span class="o">.</span><span class="n">daxpby</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unsupported type </span><span class="si">{}</span><span class="s1">. Expecting numpy.float32 or numpy.float64&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

        <span class="c1">#out = numpy.empty_like(a)</span>

        
        <span class="c1"># int psaxpby(float * x, float * y, float * out, float a, float b, long size)</span>
        <span class="n">cilacc</span><span class="o">.</span><span class="n">saxpby</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">),</span>  <span class="c1"># pointer to the first array </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">),</span>  <span class="c1"># pointer to the second array </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">),</span>  <span class="c1"># pointer to the third array </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">),</span>  <span class="c1"># pointer to A</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>                    <span class="c1"># type of type of A selector (int)</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">),</span>  <span class="c1"># pointer to B</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>                    <span class="c1"># type of type of B selector (int)</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_longlong</span><span class="p">,</span>               <span class="c1"># type of size of first array </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>                    <span class="c1"># number of threads</span>
        <span class="n">cilacc</span><span class="o">.</span><span class="n">daxpby</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span> <span class="c1"># pointer to the first array </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span> <span class="c1"># pointer to the second array </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span> <span class="c1"># pointer to the third array </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span> <span class="c1"># type of A (c_double)</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>                    <span class="c1"># type of type of A selector (int)                                  </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span> <span class="c1"># type of B (c_double)</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>                    <span class="c1"># type of type of B selector (int)                                  </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_longlong</span><span class="p">,</span>               <span class="c1"># type of size of first array </span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>                    <span class="c1"># number of threads</span>

        <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">x_p</span><span class="p">,</span> <span class="n">y_p</span><span class="p">,</span> <span class="n">out_p</span><span class="p">,</span> <span class="n">a_p</span><span class="p">,</span> <span class="n">a_vec</span><span class="p">,</span> <span class="n">b_p</span><span class="p">,</span> <span class="n">b_vec</span><span class="p">,</span> <span class="n">ndx</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;axpby execution failed&#39;</span><span class="p">)</span>
        

    <span class="c1">## unary operations</span>
    <span class="k">def</span> <span class="nf">pixel_wise_unary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pwop</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">out</span><span class="p">,</span>
                       <span class="n">deep_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                       <span class="n">dimension_labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">,</span>
                       <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> 
                       <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
                <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="s2">&quot;Wrong size for data memory: &quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">pwop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>  <span class="s2">&quot;incompatible class:&quot;</span> <span class="p">,</span> <span class="n">pwop</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_unary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_unary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_unary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_unary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">conjugate</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="DataContainer.exp"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.exp">[docs]</a>    <span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Applies exp pixel-wise to the DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_unary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DataContainer.log"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Applies log pixel-wise to the DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_wise_unary</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
    <span class="c1">## reductions</span>
    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="viewcode-block" id="DataContainer.squared_norm"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.squared_norm">[docs]</a>    <span class="k">def</span> <span class="nf">squared_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;return the squared euclidean norm of the DataContainer viewed as a vector&#39;&#39;&#39;</span>
        <span class="c1">#shape = self.shape</span>
        <span class="c1">#size = reduce(lambda x,y:x*y, shape, 1)</span>
        <span class="c1">#y = numpy.reshape(self.as_array(), (size, ))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
        <span class="c1">#return self.dot(self)</span>
<div class="viewcode-block" id="DataContainer.norm"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.norm">[docs]</a>    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;return the euclidean norm of the DataContainer viewed as a vector&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">squared_norm</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="DataContainer.dot"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;return the inner product of 2 DataContainers viewed as vectors</span>
<span class="sd">        </span>
<span class="sd">        applies to real and complex data. In such case the dot method returns</span>

<span class="sd">        a.dot(b.conjugate())</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span><span class="s1">&#39;reduce&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dot: specified method not valid. Expecting numpy or reduce got </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">method</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;reduce&#39;</span><span class="p">:</span>
                <span class="c1"># see https://github.com/vais-ral/CCPi-Framework/pull/273</span>
                <span class="c1"># notice that Python seems to be smart enough to use</span>
                <span class="c1"># the appropriate type to hold the result of the reduction</span>
                <span class="n">sf</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                <span class="n">other</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()),</span>
                            <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">sf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Shapes are not aligned: </span><span class="si">{}</span><span class="s1"> != </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="DataContainer.min"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the min pixel value in the DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DataContainer.max"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the max pixel value in the DataContainer&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DataContainer.mean"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataContainer.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the mean pixel value of the DataContainer&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="c1"># Logic operators between DataContainers and floats    </span>
    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns boolean array of DataContainer less or equal than DataContainer/float&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">other</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">other</span>
    
    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns boolean array of DataContainer less than DataContainer/float&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">&lt;</span><span class="n">other</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">&lt;</span><span class="n">other</span>    
    
    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns boolean array of DataContainer greater or equal than DataContainer/float&#39;&#39;&#39;</span>        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">&gt;=</span><span class="n">other</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">&gt;=</span><span class="n">other</span>  
    
    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns boolean array of DataContainer greater than DataContainer/float&#39;&#39;&#39;</span>        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">&gt;</span><span class="n">other</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">&gt;</span><span class="n">other</span>      
    
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns boolean array of DataContainer equal to DataContainer/float&#39;&#39;&#39;</span>          
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">==</span><span class="n">other</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">==</span><span class="n">other</span>  

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns boolean array of DataContainer negative to DataContainer/float&#39;&#39;&#39;</span>           
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">!=</span><span class="n">other</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">!=</span><span class="n">other</span>      </div>
        
<div class="viewcode-block" id="ImageData"><a class="viewcode-back" href="../../../framework.html#cil.framework.ImageData">[docs]</a><span class="k">class</span> <span class="nc">ImageData</span><span class="p">(</span><span class="n">DataContainer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;DataContainer for holding 2D or 3D DataContainer&#39;&#39;&#39;</span>
    <span class="n">__container_priority__</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span>

    <span class="nd">@geometry</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span>
      
    <span class="nd">@dimension_labels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to set the dimension_labels directly. Use geometry.set_labels() instead&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">deep_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">geometry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    

        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;ImageData requires a geometry&quot;</span><span class="p">)</span>
            

        <span class="n">labels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">labels</span> <span class="o">!=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Deprecated: &#39;dimension_labels&#39; cannot be set with &#39;allocate()&#39;. Use &#39;geometry.set_labels()&#39; to modify the geometry before using allocate.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                                   
            <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;array must be a CIL type DataContainer or numpy.ndarray got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)))</span>
            
        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Shape mismatch </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of dimensions are not 2 or 3 or 4 : </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
    
        <span class="nb">super</span><span class="p">(</span><span class="n">ImageData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">deep_copy</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                               

<div class="viewcode-block" id="ImageData.get_slice"><a class="viewcode-back" href="../../../framework.html#cil.framework.ImageData.get_slice">[docs]</a>    <span class="k">def</span> <span class="nf">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">horizontal_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">horizontal_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a new ImageData of a single slice of in the requested direction.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">geometry_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="n">vertical</span><span class="p">,</span> <span class="n">horizontal_x</span><span class="o">=</span><span class="n">horizontal_x</span><span class="p">,</span> <span class="n">horizontal_y</span><span class="o">=</span><span class="n">horizontal_y</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">geometry_new</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Unable to return slice of requested ImageData. Use &#39;force=True&#39; to return DataContainer instead.&quot;</span><span class="p">)</span>

        <span class="c1">#if vertical = &#39;centre&#39; slice convert to index and subset, this will interpolate 2 rows to get the center slice value</span>
        <span class="k">if</span> <span class="n">vertical</span> <span class="o">==</span> <span class="s1">&#39;centre&#39;</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>  
            <span class="n">centre_slice_pos</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">ind0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">centre_slice_pos</span><span class="p">))</span>
            
            <span class="n">w2</span> <span class="o">=</span> <span class="n">centre_slice_pos</span> <span class="o">-</span> <span class="n">ind0</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">DataContainer</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="n">ind0</span><span class="p">,</span> <span class="n">horizontal_x</span><span class="o">=</span><span class="n">horizontal_x</span><span class="p">,</span> <span class="n">horizontal_y</span><span class="o">=</span><span class="n">horizontal_y</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">w2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out2</span> <span class="o">=</span> <span class="n">DataContainer</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="n">ind0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">horizontal_x</span><span class="o">=</span><span class="n">horizontal_x</span><span class="p">,</span> <span class="n">horizontal_y</span><span class="o">=</span><span class="n">horizontal_y</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w2</span><span class="p">)</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">*</span> <span class="n">w2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">DataContainer</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="n">vertical</span><span class="p">,</span> <span class="n">horizontal_x</span><span class="o">=</span><span class="n">horizontal_x</span><span class="p">,</span> <span class="n">horizontal_y</span><span class="o">=</span><span class="n">horizontal_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">geometry_new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">deep_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry_new</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                            </div>


<div class="viewcode-block" id="ImageData.apply_circular_mask"><a class="viewcode-back" href="../../../framework.html#cil.framework.ImageData.apply_circular_mask">[docs]</a>    <span class="k">def</span> <span class="nf">apply_circular_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Apply a circular mask to the horizontal_x and horizontal_y slices. Values outside this mask will be set to zero.</span>

<span class="sd">        This will most commonly be used to mask edge artefacts from standard CT reconstructions with FBP.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        radius : float, default 0.99</span>
<span class="sd">            radius of mask by percentage of size of horizontal_x or horizontal_y, whichever is greater</span>

<span class="sd">        in_place : boolean, default True</span>
<span class="sd">            If `True` masks the current data, if `False` returns a new `ImageData` object.</span>
<span class="sd">            </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ImageData</span>
<span class="sd">            If `in_place = False` returns a new ImageData object with the masked data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span>

        <span class="c1"># grid</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">ig</span><span class="o">.</span><span class="n">voxel_num_y</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">ig</span><span class="o">.</span><span class="n">voxel_num_x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

        <span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[</span><span class="o">-</span><span class="n">y_range</span><span class="p">:</span><span class="n">y_range</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">x_range</span><span class="p">:</span><span class="n">x_range</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># use centre from geometry in units distance to account for aspect ratio of pixels</span>
        <span class="n">dist_from_center</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span><span class="o">*</span><span class="n">ig</span><span class="o">.</span><span class="n">voxel_size_x</span><span class="o">+</span> <span class="n">ig</span><span class="o">.</span><span class="n">center_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span><span class="o">*</span><span class="n">ig</span><span class="o">.</span><span class="n">voxel_size_y</span><span class="o">+</span><span class="n">ig</span><span class="o">.</span><span class="n">center_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">size_x</span> <span class="o">=</span> <span class="n">ig</span><span class="o">.</span><span class="n">voxel_num_x</span> <span class="o">*</span> <span class="n">ig</span><span class="o">.</span><span class="n">voxel_size_x</span>
        <span class="n">size_y</span> <span class="o">=</span> <span class="n">ig</span><span class="o">.</span><span class="n">voxel_num_y</span> <span class="o">*</span> <span class="n">ig</span><span class="o">.</span><span class="n">voxel_size_y</span>

        <span class="k">if</span> <span class="n">size_x</span> <span class="o">&gt;</span> <span class="n">size_y</span><span class="p">:</span>
            <span class="n">radius_applied</span> <span class="o">=</span><span class="n">radius</span> <span class="o">*</span> <span class="n">size_x</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radius_applied</span> <span class="o">=</span><span class="n">radius</span> <span class="o">*</span> <span class="n">size_y</span><span class="o">/</span><span class="mi">2</span>

        <span class="c1"># approximate the voxel as a circle and get the radius</span>
        <span class="c1"># ie voxel area = 1, circle of area=1 has r = 0.56</span>
        <span class="n">r</span><span class="o">=</span><span class="p">((</span><span class="n">ig</span><span class="o">.</span><span class="n">voxel_size_x</span> <span class="o">*</span> <span class="n">ig</span><span class="o">.</span><span class="n">voxel_size_y</span> <span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># we have the voxel centre distance to mask. voxels with distance greater than |r| are fully inside or outside.</span>
        <span class="c1"># values on the border region between -r and r are preserved</span>
        <span class="n">mask</span> <span class="o">=</span><span class="p">(</span><span class="n">radius_applied</span><span class="o">-</span><span class="n">dist_from_center</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>

        <span class="c1">#  rescale to -pi/2-&gt;+pi/2</span>
        <span class="n">mask</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">r</span>

        <span class="c1"># the sin of the linear distance gives us an approximation of area of the circle to include in the mask</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">mask</span><span class="p">)</span>

        <span class="c1"># rescale the data 0 - 1</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">mask</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="c1"># reorder dataset so &#39;horizontal_y&#39; and &#39;horizontal_x&#39; are the final dimensions</span>
        <span class="n">labels_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels_orig</span><span class="p">)</span>

        <span class="n">labels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;horizontal_y&#39;</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;horizontal_x&#39;</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;horizontal_y&#39;</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;horizontal_x&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">in_place</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">labels_orig</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_data_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">image_data_out</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">image_data_out</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">image_data_out</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
            <span class="n">image_data_out</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">labels_orig</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">image_data_out</span></div></div>


<div class="viewcode-block" id="AcquisitionData"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionData">[docs]</a><span class="k">class</span> <span class="nc">AcquisitionData</span><span class="p">(</span><span class="n">DataContainer</span><span class="p">,</span> <span class="n">Partitioner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;DataContainer for holding 2D or 3D sinogram&#39;&#39;&#39;</span>
    <span class="n">__container_priority__</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span>

    <span class="nd">@geometry</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span>

    <span class="nd">@dimension_labels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to set the dimension_labels directly. Use geometry.set_labels() instead&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">deep_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">geometry</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;AcquisitionData requires a geometry&quot;</span><span class="p">)</span>
        
        <span class="n">labels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">labels</span> <span class="o">!=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Deprecated: &#39;dimension_labels&#39; cannot be set with &#39;allocate()&#39;. Use &#39;geometry.set_labels()&#39; to modify the geometry before using allocate.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                                   
            <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="p">,</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;array must be a CIL type DataContainer or numpy.ndarray got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">array</span><span class="p">)))</span>
            
        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Shape mismatch got </span><span class="si">{}</span><span class="s1"> expected </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    
        <span class="nb">super</span><span class="p">(</span><span class="n">AcquisitionData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">deep_copy</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  

<div class="viewcode-block" id="AcquisitionData.get_slice"><a class="viewcode-back" href="../../../framework.html#cil.framework.AcquisitionData.get_slice">[docs]</a>    <span class="k">def</span> <span class="nf">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a new dataset of a single slice of in the requested direction. \</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">geometry_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="n">vertical</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="n">horizontal</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">geometry_new</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Unable to return slice of requested AcquisitionData. Use &#39;force=True&#39; to return DataContainer instead.&quot;</span><span class="p">)</span>

        <span class="c1">#get new data</span>
        <span class="c1">#if vertical = &#39;centre&#39; slice convert to index and subset, this will interpolate 2 rows to get the center slice value</span>
        <span class="k">if</span> <span class="n">vertical</span> <span class="o">==</span> <span class="s1">&#39;centre&#39;</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
            
            <span class="n">centre_slice_pos</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">ind0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">centre_slice_pos</span><span class="p">))</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="n">centre_slice_pos</span> <span class="o">-</span> <span class="n">ind0</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">DataContainer</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="n">ind0</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="n">horizontal</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">w2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out2</span> <span class="o">=</span> <span class="n">DataContainer</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="n">ind0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="n">horizontal</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w2</span><span class="p">)</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">*</span> <span class="n">w2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">DataContainer</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="n">vertical</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="n">horizontal</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">geometry_new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AcquisitionData</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">deep_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry_new</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Processor"><a class="viewcode-back" href="../../../framework.html#cil.framework.Processor">[docs]</a><span class="k">class</span> <span class="nc">Processor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;Defines a generic DataContainer processor</span>
<span class="sd">                       </span>
<span class="sd">    accepts a DataContainer as input</span>
<span class="sd">    returns a DataContainer</span>
<span class="sd">    `__setattr__` allows additional attributes to be defined</span>

<span class="sd">    `store_output` boolian defining whether a copy of the output is stored. Default is False.</span>
<span class="sd">    If no attributes are modified get_output will return this stored copy bypassing `process`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;store_output&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;store_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;shouldRun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;shouldRun&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;shouldRun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>            
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;shouldRun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Attribute </span><span class="si">{0}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    
<div class="viewcode-block" id="Processor.set_input"><a class="viewcode-back" href="../../../framework.html#cil.framework.Processor.set_input">[docs]</a>    <span class="k">def</span> <span class="nf">set_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the input data to the processor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input : DataContainer</span>
<span class="sd">            The input DataContainer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">DataContainer</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;shouldRun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input data not compatible&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input type mismatch: got </span><span class="si">{0}</span><span class="s2"> expecting </span><span class="si">{1}</span><span class="s2">&quot;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">DataContainer</span><span class="p">))</span></div>
    

<div class="viewcode-block" id="Processor.check_input"><a class="viewcode-back" href="../../../framework.html#cil.framework.Processor.check_input">[docs]</a>    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Checks parameters of the input DataContainer</span>
<span class="sd">        </span>
<span class="sd">        Should raise an Error if the DataContainer does not match expectation, e.g.</span>
<span class="sd">        if the expected input DataContainer is 3D and the Processor expects 2D.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Implement basic checks for input DataContainer&#39;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Processor.get_output"><a class="viewcode-back" href="../../../framework.html#cil.framework.Processor.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the configured processor and returns the processed data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out : DataContainer, optional</span>
<span class="sd">           Fills the referenced DataContainer with the processed data and suppresses the return</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataContainer</span>
<span class="sd">            The processed data. Suppressed if `out` is passed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shouldRun</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_output</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
            
    
    <span class="k">def</span> <span class="nf">set_input_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">processor</span><span class="p">),</span> <span class="n">DataProcessor</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input type mismatch: got </span><span class="si">{0}</span><span class="s2"> expecting </span><span class="si">{1}</span><span class="s2">&quot;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">processor</span><span class="p">),</span> <span class="n">DataProcessor</span><span class="p">))</span>
        
<div class="viewcode-block" id="Processor.get_input"><a class="viewcode-back" href="../../../framework.html#cil.framework.Processor.get_input">[docs]</a>    <span class="k">def</span> <span class="nf">get_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns the input DataContainer</span>
<span class="sd">        </span>
<span class="sd">        It is useful in the case the user has provided a DataProcessor as</span>
<span class="sd">        input</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input has been deallocated externally&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()),</span> <span class="n">DataProcessor</span><span class="p">):</span>
            <span class="n">dsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dsi</span></div>
        
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;process must be implemented&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>    

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>      
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="DataProcessor"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataProcessor">[docs]</a><span class="k">class</span> <span class="nc">DataProcessor</span><span class="p">(</span><span class="n">Processor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Basically an alias of Processor Class&#39;&#39;&#39;</span>
    <span class="k">pass</span></div>

<span class="k">class</span> <span class="nc">DataProcessor23D</span><span class="p">(</span><span class="n">DataProcessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Regularizers DataProcessor</span>
<span class="sd">    &#39;&#39;&#39;</span>
            
    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Checks number of dimensions input DataContainer</span>
<span class="sd">        </span>
<span class="sd">        Expected input is 2D or 3D</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">number_of_dimensions</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> \
           <span class="n">dataset</span><span class="o">.</span><span class="n">number_of_dimensions</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
               <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected input dimensions is 2 or 3, got </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">number_of_dimensions</span><span class="p">))</span>
    
<span class="c1">###### Example of DataProcessors</span>

<span class="k">class</span> <span class="nc">AX</span><span class="p">(</span><span class="n">DataProcessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Example DataProcessor</span>
<span class="sd">    The AXPY routines perform a vector multiplication operation defined as</span>

<span class="sd">    y := a*x</span>
<span class="sd">    where:</span>

<span class="sd">    a is a scalar</span>

<span class="sd">    x a DataContainer.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scalar&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="s1">&#39;input&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="p">}</span>
        
        <span class="c1">#DataProcessor.__init__(self, **kwargs)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AX</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
        
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="n">dsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">DataContainer</span><span class="p">(</span> <span class="n">a</span> <span class="o">*</span> <span class="n">dsi</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="p">,</span> <span class="kc">True</span><span class="p">,</span> 
                        <span class="n">dimension_labels</span><span class="o">=</span><span class="n">dsi</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="p">)</span>
            <span class="c1">#self.setParameter(output_dataset=y)</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">dsi</span><span class="o">.</span><span class="n">as_array</span><span class="p">())</span>
    

<span class="c1">###### Example of DataProcessors</span>

<span class="k">class</span> <span class="nc">CastDataContainer</span><span class="p">(</span><span class="n">DataProcessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Example DataProcessor</span>
<span class="sd">    Cast a DataContainer array to a different type.</span>

<span class="sd">    y := a*x</span>
<span class="sd">    where:</span>

<span class="sd">    a is a scalar</span>

<span class="sd">    x a DataContainer.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span><span class="n">dtype</span><span class="p">,</span> 
                  <span class="s1">&#39;input&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="p">}</span>
        
        <span class="c1">#DataProcessor.__init__(self, **kwargs)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CastDataContainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
        
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="n">dsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">()</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dsi</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">dsi</span><span class="p">)(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dsi</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                                <span class="n">dimension_labels</span><span class="o">=</span><span class="n">dsi</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dsi</span><span class="o">.</span><span class="n">as_array</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span>
    
<span class="k">class</span> <span class="nc">PixelByPixelDataProcessor</span><span class="p">(</span><span class="n">DataProcessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Example DataProcessor</span>
<span class="sd">    </span>
<span class="sd">    This processor applies a python function to each pixel of the DataContainer</span>
<span class="sd">    </span>
<span class="sd">    f is a python function</span>

<span class="sd">    x a DataSet.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pyfunc&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="s1">&#39;input&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="p">}</span>
        <span class="c1">#DataProcessor.__init__(self, **kwargs)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PixelByPixelDataProcessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="n">pyfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyfunc</span>
        <span class="n">dsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">()</span>
        
        <span class="n">eval_func</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frompyfunc</span><span class="p">(</span><span class="n">pyfunc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        
        <span class="n">y</span> <span class="o">=</span> <span class="n">DataContainer</span><span class="p">(</span> <span class="n">eval_func</span><span class="p">(</span> <span class="n">dsi</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="p">)</span> <span class="p">,</span> <span class="kc">True</span><span class="p">,</span> 
                    <span class="n">dimension_labels</span><span class="o">=</span><span class="n">dsi</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>
    

<div class="viewcode-block" id="VectorData"><a class="viewcode-back" href="../../../framework.html#cil.framework.VectorData">[docs]</a><span class="k">class</span> <span class="nc">VectorData</span><span class="p">(</span><span class="n">DataContainer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;DataContainer to contain 1D array&#39;&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span>

    <span class="nd">@geometry</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geometry</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span>

    <span class="nd">@dimension_labels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dimension_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">=</span> <span class="n">val</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_dimension_labels</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please specify either a geometry or an array&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incompatible size: expected 1D got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">array</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">VectorGeometry</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span>
                
            <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">array</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incompatible size: expecting </span><span class="si">{}</span><span class="s1"> got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,),</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">deep_copy</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># need to pass the geometry, othewise None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VectorData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">deep_copy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">VectorGeometry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Geometry describing VectorData to contain 1D array&#39;&#39;&#39;</span>
    <span class="n">RANDOM</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>
    <span class="n">RANDOM_INT</span> <span class="o">=</span> <span class="s1">&#39;random_int&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>

    <span class="nd">@dtype</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">val</span>      
        
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">length</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a copy of VectorGeometry&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;alias of clone&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">length</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repres</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Length: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Shape: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">repres</span> <span class="o">+=</span> <span class="s2">&quot;Dimension_labels: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">repres</span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;allocates an VectorData according to the size expressed in the instance</span>
<span class="sd">        </span>
<span class="sd">        :param value: accepts numbers to allocate an uniform array, or a string as &#39;random&#39; or &#39;random_int&#39; to create a random array or None.</span>
<span class="sd">        :type value: number or string, default None allocates empty memory block</span>
<span class="sd">        :param dtype: numerical type to allocate</span>
<span class="sd">        :type dtype: numpy type, default numpy.float32</span>
<span class="sd">        :param seed: seed for the random number generator</span>
<span class="sd">        :type seed: int, default None</span>
<span class="sd">        :param max_value: max value of the random int array</span>
<span class="sd">        :type max_value: int, default 100&#39;&#39;&#39;</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># self.dtype = kwargs.get(&#39;dtype&#39;, numpy.float32)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">VectorData</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">VectorGeometry</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> 
                <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="n">VectorGeometry</span><span class="o">.</span><span class="n">RANDOM_INT</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_value&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">max_value</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>             
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value </span><span class="si">{}</span><span class="s1"> unknown&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="DataOrder"><a class="viewcode-back" href="../../../framework.html#cil.framework.DataOrder">[docs]</a><span class="k">class</span> <span class="nc">DataOrder</span><span class="p">():</span>

    <span class="n">ENGINES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;astra&#39;</span><span class="p">,</span><span class="s1">&#39;tigre&#39;</span><span class="p">,</span><span class="s1">&#39;cil&#39;</span><span class="p">]</span>

    <span class="n">ASTRA_IG_LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">ImageGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_Y</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_X</span><span class="p">]</span>
    <span class="n">TIGRE_IG_LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">ImageGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_Y</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_X</span><span class="p">]</span>
    <span class="n">ASTRA_AG_LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">]</span>
    <span class="n">TIGRE_AG_LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">]</span>
    <span class="n">CIL_IG_LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">ImageGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_Y</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_X</span><span class="p">]</span>
    <span class="n">CIL_AG_LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">]</span> 
    <span class="n">TOMOPHANTOM_IG_LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">ImageGeometry</span><span class="o">.</span><span class="n">CHANNEL</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_Y</span><span class="p">,</span> <span class="n">ImageGeometry</span><span class="o">.</span><span class="n">HORIZONTAL_X</span><span class="p">]</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_order_for_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">geometry</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;astra&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="p">):</span>
                <span class="n">dim_order</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">ASTRA_AG_LABELS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dim_order</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">ASTRA_IG_LABELS</span>
        <span class="k">elif</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;tigre&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="p">):</span>
                <span class="n">dim_order</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">TIGRE_AG_LABELS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dim_order</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">TIGRE_IG_LABELS</span>
        <span class="k">elif</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;cil&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">AcquisitionGeometry</span><span class="p">):</span>
                <span class="n">dim_order</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">CIL_AG_LABELS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dim_order</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">CIL_IG_LABELS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown engine expected one of </span><span class="si">{0}</span><span class="s2"> got </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DataOrder</span><span class="o">.</span><span class="n">ENGINES</span><span class="p">,</span> <span class="n">engine</span><span class="p">))</span>
        
        <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">dim_order</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">:</span>
                <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dimensions</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_order_for_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">geometry</span><span class="p">):</span>
        <span class="n">order_requested</span> <span class="o">=</span> <span class="n">DataOrder</span><span class="o">.</span><span class="n">get_order_for_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">geometry</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order_requested</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected dimension_label order </span><span class="si">{0}</span><span class="s2">, got </span><span class="si">{1}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Try using `data.reorder(&#39;</span><span class="si">{2}</span><span class="s2">&#39;)` to permute for </span><span class="si">{2}</span><span class="s2">&quot;</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">order_requested</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">dimension_labels</span><span class="p">),</span> <span class="n">engine</span><span class="p">))</span></div>



        
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2017-2021 UKRI-STFC, University of Manchester.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.4.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>