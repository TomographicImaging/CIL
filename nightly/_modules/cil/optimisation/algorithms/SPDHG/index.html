
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cil.optimisation.algorithms.SPDHG &#8212; CIL 24.3.1.dev33+ge8874967 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=38847caffe24bbc62201" rel="stylesheet" />
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=38847caffe24bbc62201" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery.css?v=d2d258e8" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../../_static/scripts/fontawesome.js?digest=38847caffe24bbc62201"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/bootstrap.js?digest=38847caffe24bbc62201" />
<link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=38847caffe24bbc62201" />

    <script src="../../../../../_static/documentation_options.js?v=3ade84f7"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/cil/optimisation/algorithms/SPDHG';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.2dev0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = '/CIL/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '24.3.1.dev33+ge8874967';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <script>DOCUMENTATION_OPTIONS.search_as_you_type = false;</script>
    <link rel="index" title="Index" href="../../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../../search/" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="24.3.1.dev33+ge8874967" />
  
    
    <script src="../../../../../_static/searchtools.js"></script>
    <script src="../../../../../_static/language_data.js"></script>
    <script src="../../../../../searchindex.js"></script>
  
  </head>
  <body data-default-mode="">
  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>

  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header id="pst-header" class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
     
  

<a class="navbar-brand logo" href="/">
  
  
  
  
  
    
    
      
    
    
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB.svg" class="logo__image only-light" alt="CIL - Home"/>
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB-reversed.svg" class="logo__image only-dark pst-js-only" alt="CIL - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../developer_guide/">
    Developers’ Guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../../../demos/">
    Tutorials
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../developer_guide/">
    Developers’ Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../demos/">
    Tutorials
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../../../../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        <div class="sidebar-primary-item">
<h3><a href="../../../../../">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../introduction/">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../framework/">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../io/">Read/ write AcquisitionData and ImageData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../optimisation/">Optimisation framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../optimisation/#block-framework">Block Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../processors/">Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../recon/">Recon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../utilities/">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plugins/">CIL Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/">Developers’ Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../demos/">Tutorials</a></li>
</ul>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">cil.optimisation.algorithms.SPDHG</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for cil.optimisation.algorithms.SPDHG</h1><div class="highlight"><pre>
<span></span><span class="c1">#  Copyright 2020 United Kingdom Research and Innovation</span>
<span class="c1">#  Copyright 2020 The University of Manchester</span>
<span class="c1">#</span>
<span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#  you may not use this file except in compliance with the License.</span>
<span class="c1">#  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#  See the License for the specific language governing permissions and</span>
<span class="c1">#  limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># Authors:</span>
<span class="c1"># CIL Developers, listed at: https://github.com/TomographicImaging/CIL/blob/master/NOTICE.txt</span>
<span class="c1"># Claire Delplancke (University of Bath)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.algorithms</span><span class="w"> </span><span class="kn">import</span> <span class="n">Algorithm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.operators</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockOperator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sampler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Number</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockDataContainer</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="SPDHG">
<a class="viewcode-back" href="../../../../../optimisation/#cil.optimisation.algorithms.SPDHG">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SPDHG</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Stochastic Primal Dual Hybrid Gradient (SPDHG) solves separable optimisation problems of the type: </span>
<span class="sd">    </span>
<span class="sd">      .. math:: \min_{x} f(Kx) + g(x) = \min_{x} \sum f_i(K_i x) + g(x)</span>

<span class="sd">    where :math:`f_i` and the regulariser :math:`g` need to be proper, convex and lower semi-continuous.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : BlockFunction</span>
<span class="sd">        Each must be a convex function with a &quot;simple&quot; proximal method of its conjugate</span>
<span class="sd">    g : Function</span>
<span class="sd">        A convex function with a &quot;simple&quot; proximal</span>
<span class="sd">    operator : BlockOperator</span>
<span class="sd">        BlockOperator must contain Linear Operators</span>
<span class="sd">    tau : positive float, optional</span>
<span class="sd">        Step size parameter for the primal problem. If `None` will be computed by algorithm, see note for details. </span>
<span class="sd">    sigma : list of positive float, optional</span>
<span class="sd">        List of Step size parameters for dual problem.  If `None` will be computed by algorithm, see note for details. </span>
<span class="sd">    initial : DataContainer, optional</span>
<span class="sd">        Initial point for the SPDHG algorithm. The default value is a zero DataContainer in the range of the `operator`.</span>
<span class="sd">    gamma : float, optional</span>
<span class="sd">            Parameter controlling the trade-off between the primal and dual step sizes</span>
<span class="sd">    sampler: `cil.optimisation.utilities.Sampler`, optional </span>
<span class="sd">            A `Sampler` controllingthe selection of the next index for the SPDHG update. If `None`, a sampler will be created for uniform random sampling with replacement. See notes.  </span>

<span class="sd">    prob_weights: list of floats, optional,  </span>
<span class="sd">             Consider that the sampler is called a large number of times this argument holds the expected number of times each index would be called,  normalised to 1. Note that this should not be passed if the provided sampler has it as an attribute: if the sampler has a `prob_weight` attribute it will take precedence on this parameter. Should be a list of floats of length `num_indices` that sum to 1. If no sampler with `prob_weights` is passed, it defaults to `[1/len(operator)]*len(operator)`.</span>


<span class="sd">    Note  </span>
<span class="sd">    -----  </span>
<span class="sd">    The `sampler` can be an instance of the `cil.optimisation.utilities.Sampler` class or a custom class with the `__next__(self)` method implemented, which outputs an integer index from {1, ..., len(operator)}. </span>

<span class="sd">    Note  </span>
<span class="sd">    -----  </span>
<span class="sd">    &quot;Random sampling with replacement&quot; will select the next index with equal probability from  `1 - len(operator)`.  </span>


<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; data = dataexample.SIMULATED_PARALLEL_BEAM_DATA.get()</span>
<span class="sd">    &gt;&gt;&gt; data.reorder(&#39;astra&#39;)</span>
<span class="sd">    &gt;&gt;&gt; data = data.get_slice(vertical=&#39;centre&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ig = ag.get_ImageGeometry()</span>

<span class="sd">    &gt;&gt;&gt; data_partitioned = data.partition(num_batches=10, mode=&#39;staggered&#39;)</span>
<span class="sd">    &gt;&gt;&gt; A_partitioned = ProjectionOperator(ig, data_partitioned.geometry, device = &quot;cpu&quot;)</span>


<span class="sd">    &gt;&gt;&gt; F = BlockFunction(*[L2NormSquared(b=data_partitioned[i])</span>
<span class="sd">                            for i in range(10)])</span>

<span class="sd">    &gt;&gt;&gt; alpha = 0.025</span>
<span class="sd">    &gt;&gt;&gt; G = alpha * TotalVariation()</span>
<span class="sd">    &gt;&gt;&gt; spdhg = SPDHG(f=F, g=G, operator=A_partitioned, sampler=Sampler.sequential(len(A)),</span>
<span class="sd">                      initial=A.domain_geometry().allocate(1), update_objective_interval=10)</span>
<span class="sd">    &gt;&gt;&gt; spdhg.run(100)</span>


<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    Further examples of usage see the [CIL demos.](https://github.com/vais-ral/CIL-Demos/blob/master/Tomography/Simulated/Single%20Channel/PDHG_vs_SPDHG.py)</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    When setting `sigma` and `tau`, there are 4 possible cases considered by setup function. In all cases the probabilities :math:`p_i` are set by a default or user defined sampler:</span>

<span class="sd">    - Case 1: If neither `sigma` or `tau` are provided then `sigma` is set using the formula:</span>

<span class="sd">    .. math:: \sigma_i= \frac{0.99}{\|K_i\|^2}</span>

<span class="sd">    and `tau` is set as per case 2</span>

<span class="sd">    - Case 2: If `sigma` is provided but not `tau` then `tau` is calculated using the formula </span>

<span class="sd">    .. math:: \tau = 0.99\min_i( \frac{p_i}{ (\sigma_i  \|K_i\|^2) })</span>

<span class="sd">    - Case 3: If `tau` is provided but not `sigma` then `sigma` is calculated using the formula</span>

<span class="sd">    .. math:: \sigma_i= \frac{0.99 p_i}{\tau\|K_i\|^2}</span>

<span class="sd">    - Case 4: Both `sigma` and `tau` are provided.</span>


<span class="sd">    Note</span>
<span class="sd">    ----</span>

<span class="sd">    Convergence is guaranteed provided that [2, eq. (12)]:</span>

<span class="sd">    .. math:: \|\sigma[i]^{1/2}  K[i]  \tau^{1/2} \|^2  &lt; p_i \text{ for all } i</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    [1]&quot;Stochastic primal-dual hybrid gradient algorithm with arbitrary </span>
<span class="sd">    sampling and imaging applications&quot;,</span>
<span class="sd">    Chambolle, Antonin, Matthias J. Ehrhardt, Peter Richtárik, and Carola-Bibiane Schonlieb,</span>
<span class="sd">    SIAM Journal on Optimization 28, no. 4 (2018): 2783-2808.   https://doi.org/10.1137/17M1134834 </span>

<span class="sd">    [2]&quot;Faster PET reconstruction with non-smooth priors by randomization and preconditioning&quot;,</span>
<span class="sd">    Matthias J Ehrhardt, Pawel Markiewicz and Carola-Bibiane Schönlieb,</span>
<span class="sd">    Physics in Medicine &amp; Biology, Volume 64, Number 22, 2019. https://doi.org/10.1088/1361-6560/ab3d07</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prob_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">update_objective_interval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;update_objective_interval&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SPDHG</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">update_objective_interval</span><span class="o">=</span><span class="n">update_objective_interval</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_up</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">operator</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
                    <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span>  <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">prob_weights</span><span class="o">=</span><span class="n">prob_weights</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SPDHG.set_up">
<a class="viewcode-back" href="../../../../../optimisation/#cil.optimisation.algorithms.SPDHG.set_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>   <span class="n">sampler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prob_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">deprecated_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;set-up of the algorithm</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> setting up&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># algorithmic parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">operator</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="n">BlockOperator</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;operator should be a BlockOperator&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ndual_subsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="s1">&#39;prob_weights&#39;</span><span class="p">,</span> <span class="n">prob_weights</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_deprecated_set_prob</span><span class="p">(</span><span class="n">deprecated_kwargs</span><span class="p">,</span> <span class="n">sampler</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndual_subsets</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndual_subsets</span>
        
        <span class="k">if</span>  <span class="n">prob_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span> <span class="o">!=</span> <span class="n">prob_weights</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39; You passed a `prob_weights` argument and a sampler with a different attribute `prob_weights`, please remove the `prob_weights` argument.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">random_with_replacement</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">operator</span><span class="p">),</span> <span class="n">prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span> <span class="o">=</span> <span class="n">sampler</span>
        
        <span class="c1">#Set the norms of the operators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deprecated_set_norms</span><span class="p">(</span><span class="n">deprecated_kwargs</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_norms</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">get_norms_as_list</span><span class="p">()</span>
        <span class="c1">#Check for other kwargs</span>
        <span class="k">if</span> <span class="n">deprecated_kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Additional keyword arguments passed but not used: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deprecated_kwargs</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_step_sizes</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>

        <span class="c1"># initialize primal variable</span>
        <span class="k">if</span> <span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">()</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">()</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># initialize dual variable to 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">range_geometry</span><span class="p">()</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">,</span> <span class="n">BlockDataContainer</span><span class="p">):</span> <span class="c1">#This can be removed once #1863 is fixed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span> <span class="o">=</span><span class="n">BlockDataContainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">)</span>

        <span class="c1"># initialize variable z corresponding to back-projected dual variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">()</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zbar</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">()</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># relaxation parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_theta</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> configured&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">))</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_deprecated_set_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deprecated_kwargs</span><span class="p">,</span> <span class="n">sampler</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle deprecated keyword arguments for backward compatibility.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        deprecated_kwargs : dict</span>
<span class="sd">            Dictionary of keyword arguments.</span>
<span class="sd">        sampler : Sampler           </span>
<span class="sd">            Sampler class for selecting the next index for the SPDHG update.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method is called by the set_up method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">prob</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;prob&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;`prob` is being deprecated to be replaced with a sampler class and `prob_weights`. To randomly sample with replacement use &quot;sampler=Sampler.randomWithReplacement(number_of_subsets,  prob=prob). To pass probabilities to the calculation for `sigma` and `tau` please use `prob_weights`. &#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span> <span class="o">=</span> <span class="n">prob</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;`prob` is being deprecated to be replaced with a sampler class and `prob_weights`. You passed  a `prob` argument, and either a `prob_weights` argument or a sampler. Please remove the `prob` argument.&#39;</span><span class="p">)</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">_deprecated_set_norms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deprecated_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle deprecated keyword arguments for backward compatibility.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        deprecated_kwargs : dict</span>
<span class="sd">            Dictionary of keyword arguments.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method is called by the set_up method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">norms</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;norms&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">norms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">set_norms</span><span class="p">(</span><span class="n">norms</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39; `norms` is being deprecated, use instead the `BlockOperator` function `set_norms`&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tau</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span>

<div class="viewcode-block" id="SPDHG.set_step_sizes_from_ratio">
<a class="viewcode-back" href="../../../../../optimisation/#cil.optimisation.algorithms.SPDHG.set_step_sizes_from_ratio">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_step_sizes_from_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">0.99</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; Sets gamma, the step-size ratio for the SPDHG algorithm. Currently gamma takes a scalar value.</span>

<span class="sd">        The step sizes `sigma` and `tau` are set using the equations:</span>

<span class="sd">        .. math:: \sigma_i= \frac{\gamma\rho }{\|K_i\|^2}</span>

<span class="sd">        .. math::  \tau = \rho\min_i([ \frac{p_i }{\sigma_i  \|K_i\|^2})</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            gamma : Positive float</span>
<span class="sd">                parameter controlling the trade-off between the primal and dual step sizes</span>
<span class="sd">            rho : Positive float</span>
<span class="sd">                 parameter controlling the size of the product :math:`\sigma\tau`</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gamma</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The step-sizes of SPDHG are positive, gamma should also be positive&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;We currently only support scalar values of gamma&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rho</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The step-sizes of SPDHG are positive, rho should also be positive&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;We currently only support scalar values of gamma&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">/</span> <span class="n">ni</span> <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norms</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">rho</span><span class="o">*</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">si</span> <span class="o">*</span> <span class="n">ni</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">pi</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span>
                  <span class="n">si</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">])</span></div>


<div class="viewcode-block" id="SPDHG.set_step_sizes">
<a class="viewcode-back" href="../../../../../optimisation/#cil.optimisation.algorithms.SPDHG.set_step_sizes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_step_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; Sets sigma and tau step-sizes for the SPDHG algorithm after the initial set-up. The step sizes can be either scalar or array-objects.</span>

<span class="sd">        When setting `sigma` and `tau`, there are 4 possible cases considered by setup function: </span>

<span class="sd">        - Case 1: If neither `sigma` or `tau` are provided then `sigma` is set using the formula:</span>

<span class="sd">        .. math:: \sigma_i= \frac{0.99}{\|K_i\|^2}</span>

<span class="sd">        and `tau` is set as per case 2</span>

<span class="sd">        - Case 2: If `sigma` is provided but not `tau` then `tau` is calculated using the formula </span>

<span class="sd">        .. math:: \tau = 0.99\min_i( \frac{p_i}{ (\sigma_i  \|K_i\|^2) })</span>

<span class="sd">        - Case 3: If `tau` is provided but not `sigma` then `sigma` is calculated using the formula</span>

<span class="sd">        .. math:: \sigma_i= \frac{0.99 p_i}{\tau\|K_i\|^2}</span>

<span class="sd">        - Case 4: Both `sigma` and `tau` are provided.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            sigma : list of positive float, optional, default= see docstring</span>
<span class="sd">                List of Step size parameters for dual problem</span>
<span class="sd">            tau : positive float, optional, default= see docstring</span>
<span class="sd">                Step size parameter for primal problem</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="mf">.99</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndual_subsets</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sigma</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Sigma expected to be a positive number.&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Please pass a list of floats to sigma with the same number of entries as number of operators&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span> <span class="o">=</span> <span class="n">sigma</span>

        <span class="k">elif</span> <span class="n">tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">/</span> <span class="n">ni</span> <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norms</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">rho</span><span class="o">*</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">ni</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">ni</span><span class="p">,</span> <span class="n">pi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_norms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">rho</span><span class="o">*</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">si</span> <span class="o">*</span> <span class="n">ni</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">pi</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span>
                      <span class="n">si</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tau</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The step-sizes of SPDHG must be positive, passed tau = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">=</span> <span class="n">tau</span></div>


<div class="viewcode-block" id="SPDHG.check_convergence">
<a class="viewcode-back" href="../../../../../optimisation/#cil.optimisation.algorithms.SPDHG.check_convergence">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Checks whether convergence criterion for SPDHG is satisfied with the current scalar values of tau and sigma</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Boolean</span>
<span class="sd">            True if convergence criterion is satisfied. False if not satisfied or convergence is unknown. </span>

<span class="sd">        Note</span>
<span class="sd">        -----</span>
<span class="sd">        Convergence criterion currently can only be checked for scalar values of tau.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This checks the convergence criterion. Numerical errors may mean some sigma and tau values that satisfy the convergence criterion may not converge. </span>
<span class="sd">        Alternatively, step sizes outside the convergence criterion may still allow (fast) convergence. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndual_subsets</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Number</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Convergence criterion currently can only be checked for scalar values of tau and sigma[i].&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SPDHG.update">
<a class="viewcode-back" href="../../../../../optimisation/#cil.optimisation.algorithms.SPDHG.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Runs one iteration of SPDHG </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Gradient descent for the primal variable</span>
        <span class="c1"># x_tmp = x - tau * zbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zbar</span><span class="o">.</span><span class="n">sapyb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_tmp</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_tmp</span><span class="o">*=-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">proximal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Choose subset</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">)</span>

        <span class="c1"># Gradient ascent for the dual variable</span>
        <span class="c1"># y_k = y_old[i] + sigma[i] * K[i] x</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">y_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">direct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                <span class="s1">&#39;The sampler has outputted an index larger than the number of operators to sample from. Please ensure your sampler samples from {0,1,...,len(operator)-1} only.&#39;</span><span class="p">)</span>

        <span class="n">y_k</span><span class="o">.</span><span class="n">sapyb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">y_k</span><span class="p">)</span>

        <span class="n">y_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">proximal_conjugate</span><span class="p">(</span><span class="n">y_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Back-project</span>
        <span class="c1"># x_tmp = K[i]^*(y_k - y_old[i])</span>
        <span class="n">y_k</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_tmp</span><span class="p">)</span>
        <span class="c1"># Update backprojected dual variable and extrapolate</span>
        <span class="c1"># zbar = z + (1 + theta/p[i]) x_tmp</span>

        <span class="c1"># z = z + x_tmp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_tmp</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">)</span>
        <span class="c1"># zbar = z + (theta/p[i]) * x_tmp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">sapyb</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta</span> <span class="o">/</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_prob_weights</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_zbar</span><span class="p">)</span>

        <span class="c1"># save previous iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_previous_iteration</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">y_k</span><span class="p">)</span></div>


<div class="viewcode-block" id="SPDHG.update_objective">
<a class="viewcode-back" href="../../../../../optimisation/#cil.optimisation.algorithms.SPDHG.update_objective">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># p1 = self.f(self.operator.direct(self.x)) + self.g(self.x)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">operators</span><span class="p">):</span>
            <span class="n">p1</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">op</span><span class="o">.</span><span class="n">direct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
        <span class="n">p1</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="n">d1</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">convex_conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">d1</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">convex_conjugate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">p1</span><span class="o">-</span><span class="n">d1</span><span class="p">])</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;The saved primal objectives. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The saved primal objectives from `update_objective`. The number of saved values depends on the `update_objective_interval` kwarg. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dual_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;The saved dual objectives. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The saved dual objectives from `update_objective`. The number of saved values depends on the `update_objective_interval` kwarg. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">primal_dual_gap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;The saved primal-dual gap. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The saved primal dual gap from `update_objective`. The number of saved values depends on the `update_objective_interval` kwarg. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_previous_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">y_current</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Internal function used to save the previous iteration </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_old</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">y_current</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../../_static/scripts/bootstrap.js?digest=38847caffe24bbc62201"></script>
<script defer src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=38847caffe24bbc62201"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2017-2024.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>