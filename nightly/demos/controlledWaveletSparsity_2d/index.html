
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Controlled Wavelet Sparsity using callbacks (2D data) &#8212; CIL 25.0.1.dev20+ga01618ef8 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3357575206ef0862cebd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3357575206ef0862cebd" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- So that users can add custom icons -->
  <script defer src="../../_static/scripts/fontawesome.js?digest=3357575206ef0862cebd"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3357575206ef0862cebd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3357575206ef0862cebd" />

    <script src="../../_static/documentation_options.js?v=8fa00a57"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'demos/controlledWaveletSparsity_2d';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.2dev0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = '/CIL/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '25.0.1.dev20+ga01618ef8';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <script>DOCUMENTATION_OPTIONS.search_as_you_type = false;</script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Controlled Wavelet Sparsity using callbacks (3D data)" href="../controlledWaveletSparsity_3d/" />
    <link rel="prev" title="Exciscope Polaris phase contrast reconstruction with CIL" href="../recon_phasecontrast_exciscope/" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="25.0.1.dev20+ga01618ef8" />
  
    
    <script src="../../_static/searchtools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../searchindex.js"></script>
  
  </head>
  <body data-default-mode="">
  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>

  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header id="pst-header" class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
     
  

<a class="navbar-brand logo" href="https://tomographicimaging.github.io/CIL">
  
  
  
  
  
    
    
      
    
    
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB.svg" class="logo__image only-light" alt="CIL - Home"/>
    <img src="https://ccpi.ac.uk/wp-content/uploads/2022/11/CIL-logo-RGB-reversed.svg" class="logo__image only-dark pst-js-only" alt="CIL - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer_guide/">
    Developers’ Guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../">
    Tutorials
  </a>
</li>


<li class=" current active">
  <a class="nav-link dropdown-item nav-internal" href="../../usershowcase/">
    User showcase
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../introduction/">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../framework/">
    Framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../io/">
    Read/ write AcquisitionData and ImageData
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../optimisation/">
    Optimisation framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../processors/">
    Processors
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../recon/">
    Recon
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../utilities/">
    Utilities
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../plugins/">
    CIL Plugins
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer_guide/">
    Developers’ Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../usershowcase/">
    User showcase
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        <div class="sidebar-primary-item">
<h3><a href="../../">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../framework/">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/">Read/ write AcquisitionData and ImageData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimisation/">Optimisation framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimisation/#block-framework">Block Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../processors/">Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recon/">Recon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities/">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/">CIL Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/">Developers’ Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../usershowcase/">User showcase</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Multibang_Hackathon2023/">Multibang Regularisation in CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Showcase_of_the_algorithms_for_deblurring_and_denoising/">Showcase of the algorithms for deblurring and denoising</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deriv2_cgls/">1D inverse problem demo using deriv2 from regtools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stempo2d_v2_1/">TV-regularized reconstruction of the dynamix STEMPO dataset in CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamic_mr_recon/">Dynamic MR Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/">a gVXR data reader for CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Aims-of-this-session">Aims of this session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Main-steps">Main steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Create-directories">Create directories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Import-packages">Import packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-1.-Download-and-extract-the-phantom-data-from-a-ZIP-file.">Step 1. Download and extract the phantom data from a ZIP file.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-2.-Extract-surface-meshes-from-the-voxelied-phantom.">Step 2. Extract surface meshes from the voxelied phantom.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-3.-Simulate-an-X-ray-radiograph-of-the-virtual-patient.">Step 3. Simulate an X-ray radiograph of the virtual patient.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-4.-Select-the-number-of-incident-photons-per-pixel">Step 4. Select the number of incident photons per pixel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-5.-Add-the-corresponding-amount-of-Photonic-noise">Step 5. Add the corresponding amount of Photonic noise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-6.-Create-the-flat-field-images-with-the-corresponding-amount-of-Photonic-noise.">Step 6. Create the flat-field images with the corresponding amount of Photonic noise.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-7.-Simulate-a-CT-scan">Step 7. Simulate a CT scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Step-8.-Reconstruct-the-CT-volume-using-the-Core-Imaging-Library-(CIL)">Step 8. Reconstruct the CT volume using the Core Imaging Library (CIL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CBCT-acquisition-with-noise-and-reconstruction/#Cleaning-up">Cleaning up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Hyperspectral_regularisation/">Reconstruction and regularisation for a hyperspectral dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/">Comparison between the Least Square and the Weighted Least Square and the Kullback Leibler Divergence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Reconstructing-the-noisy-data-using-KL-divergence-with-TV-regularisation">Reconstructing the noisy data using KL divergence with TV regularisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Compare-all-the-reconstructions">Compare all the reconstructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LS_WLS_KL_TotalVariation/#Comparisons-between-LS,-WLS-and-KL-loss-for-a-range-of-counts">Comparisons between LS, WLS and KL loss for a range of counts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Apple_offset_reconstruction/">Cone-beam offset reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/">microCT reconstruction with Bruker data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Set-variables-and-paths">Set variables and paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Create-acquisition-geometry">Create acquisition geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Read-files">Read files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Data-processing">Data processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Prepare-back-projection">Prepare back-projection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Review-projection-data-before-running-the-recontruction">Review projection data before running the recontruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Perform-reconstruction">Perform reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Display-results">Display results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Optional:-Save-results-as-tiff-files">Optional: Save results as tiff files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bruker2cil/#Optional:-Save-results-as-json-files">Optional: Save results as json files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../recon_phasecontrast_exciscope/">Exciscope Polaris phase contrast reconstruction with CIL</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Controlled Wavelet Sparsity using callbacks (2D data)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#2D-laboratory-micro-CT,-fan-beam-data-of-a-walnut">2D laboratory micro-CT, fan-beam data of a walnut</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Image-geometry-and-data">Image geometry and data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Wavelet-based-regularization">Wavelet based regularization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Wavelet-transform">Wavelet transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Fast-Iterative-Soft-Thresholding-Algorithm-(FISTA)">Fast Iterative Soft Thresholding Algorithm (FISTA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Sparsity-levels-of-the-bulk-reconstruction">Sparsity levels of the bulk reconstruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Limitations-of-the-method">Limitations of the method</a></li>
<li class="toctree-l3"><a class="reference internal" href="#How-to-pick-desired-sparsity?">How to pick <em>desired sparsity</em>?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_3d/">Controlled Wavelet Sparsity using callbacks (3D data)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controlledWaveletSparsity_3d/#Wavelet-based-regularization">Wavelet based regularization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../013_Anisotropic_regularisation_FILD_measurements/">CIL User Showcase 13: Anisotropic Regularization for FILD Measurements using CIL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/">Simulation using gVXR and CPU reconstruction using CIL of a twisted hexagonal object with helical flow channels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Read-projections">Read projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Reconstruction">Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Simulation_and_CPU_reconstruction/#Conclusion">Conclusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory_profiling_sandstone/">Memory and Performance Profiling CIL Algorithms: CGLS vs. LSQR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fista_with_denoiser/">A CIL-pytorch example using DeepInverse using a pre-trained denoiser in the CIL FISTA algorithm</a></li>
</ul>
</li>
</ul>
</div>
        <div class="sidebar-primary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/TomographicImaging/CIL/edit/master/docs/source/demos/controlledWaveletSparsity_2d.ipynb">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../usershowcase/" class="nav-link">User showcase</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Controlled Wavelet Sparsity using callbacks (2D data)</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#  you may not use this file except in compliance with the License.</span>
<span class="c1">#  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#  See the License for the specific language governing permissions and</span>
<span class="c1">#  limitations under the License.</span>

<span class="c1">#</span>
<span class="c1">#  Authored by:    Tommi Heikkilä (LUT)</span>
<span class="c1">#  Review by:      Margaret Duff (STFC-UKRI), Jakob Jørgensen (DTU)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cil</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using CIL version </span><span class="si">{</span><span class="n">cil</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Using CIL version 24.2.0
</pre></div></div>
</div>
<section id="Controlled-Wavelet-Sparsity-using-callbacks-(2D-data)">
<h1>Controlled Wavelet Sparsity using callbacks (2D data)<a class="headerlink" href="#Controlled-Wavelet-Sparsity-using-callbacks-(2D-data)" title="Link to this heading">#</a></h1>
<p>This notebook showcases an automated method for tuning the regularization parameter towards a good value during the optimization process. It is organized as follows.</p>
<ol class="arabic simple">
<li><p>Set up the data and the appropriate <a class="reference internal" href="#Create-geometry"><span class="std std-ref">geometry</span></a></p></li>
<li><p>Brief introduction to a representation system called wavelets and explaining what <a class="reference internal" href="#Wavelet-based-regularization"><span class="std std-ref">wavelet regularization</span></a> should do.</p>
<ul class="simple">
<li><p>Traditional run with fixed regularization parameter using FISTA</p></li>
</ul>
</li>
<li><p>Perform multiple runs with different (fixed) regularization parameter values for comparison and motivating later steps.</p></li>
<li><p>Brief explanation of the <a class="reference internal" href="#Automated-Controlled-Sparsity"><span class="std std-ref">controlled wavelet sparsity method</span></a> including the original source and how the CIL implementation is done.</p></li>
<li><p>Some comments on the <a class="reference internal" href="#Limitations-of-the-method"><span class="std std-ref">limitations</span></a> of the method and how to pick the importat parameter values.</p></li>
</ol>
<section id="2D-laboratory-micro-CT,-fan-beam-data-of-a-walnut">
<h2>2D laboratory micro-CT, fan-beam data of a walnut<a class="headerlink" href="#2D-laboratory-micro-CT,-fan-beam-data-of-a-walnut" title="Link to this heading">#</a></h2>
<p>This example uses the walnut dataset <code class="docutils literal notranslate"><span class="pre">Data328.mat</span></code> from <a class="reference external" href="https://doi.org/10.5281/zenodo.1254206">https://doi.org/10.5281/zenodo.1254206</a> :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://zenodo.org/records/1254206/files/Data328.mat?download=1">https://zenodo.org/records/1254206/files/Data328.mat?download=1</a></p></li>
</ul>
<p>If running locally please download the data and update the ‘path’ variable below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./data&#39;</span>
</pre></div>
</div>
</div>
<p>Set the logging level</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;dxchange&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>First import all of the modules we will need:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># cil imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageData</span><span class="p">,</span> <span class="n">ImageGeometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">AcquisitionGeometry</span><span class="p">,</span> <span class="n">AcquisitionData</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LeastSquares</span><span class="p">,</span> <span class="n">L1Sparsity</span><span class="p">,</span> <span class="n">ScaledFunction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.operators</span><span class="w"> </span><span class="kn">import</span> <span class="n">WaveletOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cil.optimisation.algorithms</span><span class="w"> </span><span class="kn">import</span> <span class="n">FISTA</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cil.plugins.astra</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProjectionOperator</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cil.utilities.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">show2D</span><span class="p">,</span> <span class="n">show_geometry</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.io</span>
</pre></div>
</div>
</div>
<p>Load the 2D fan-beam sinogram of walnut:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Data328.mat&quot;</span><span class="p">)</span>

<span class="n">matdata</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">matdata</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="c1"># Matlab is column-major, numpy is row-major</span>
<span class="n">num_angles</span><span class="p">,</span> <span class="n">num_pixels</span> <span class="o">=</span> <span class="n">sinogram</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<section id="Create-geometry">
<h3>Create geometry<a class="headerlink" href="#Create-geometry" title="Link to this heading">#</a></h3>
<p>We have to manually set the values for the correct geometry. These can be found in the <a class="reference external" href="https://arxiv.org/abs/1502.04064">documentation</a> of the data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Acquisition geometry parameters</span>
<span class="n">SOD</span> <span class="o">=</span> <span class="mi">110</span> <span class="c1"># Source-Origin-distance</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SOD: </span><span class="si">{</span><span class="n">SOD</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> mm&#39;</span><span class="p">)</span>
<span class="n">SDD</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1"># Source-Detector-distance</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SDD: </span><span class="si">{</span><span class="n">SDD</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> mm&#39;</span><span class="p">)</span>
<span class="n">ODD</span> <span class="o">=</span> <span class="n">SDD</span> <span class="o">-</span> <span class="n">SOD</span> <span class="c1"># Origin-detector-distance</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ODD: </span><span class="si">{</span><span class="n">ODD</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> mm&#39;</span><span class="p">)</span>
<span class="n">pixelSize</span> <span class="o">=</span> <span class="mf">114.8</span> <span class="o">/</span> <span class="n">num_pixels</span> <span class="c1"># Detector pixel width after binning</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Detector pixel size: </span><span class="si">{</span><span class="n">pixelSize</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> mm&#39;</span><span class="p">)</span>

<span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">360.</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SOD: 110.000 mm
SDD: 300.000 mm
ODD: 190.000 mm
Detector pixel size: 0.350 mm
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ag</span> <span class="o">=</span> <span class="n">AcquisitionGeometry</span><span class="o">.</span><span class="n">create_Cone2D</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">SOD</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ODD</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span><span class="n">detector_direction_x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ag</span><span class="o">.</span><span class="n">set_panel</span><span class="p">(</span><span class="n">num_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixelSize</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;bottom-left&#39;</span><span class="p">)</span>
<span class="n">ag</span><span class="o">.</span><span class="n">set_angles</span><span class="p">(</span><span class="o">-</span><span class="n">angles</span><span class="p">)</span>
<span class="n">ag</span><span class="o">.</span><span class="n">set_labels</span><span class="p">((</span><span class="s1">&#39;angle&#39;</span><span class="p">,</span><span class="s1">&#39;horizontal&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ag</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2D Cone-beam tomography
System configuration:
        Source position: [   0., -110.]
        Rotation axis position: [0., 0.]
        Detector position: [  0., 190.]
        Detector direction x: [1., 0.]
Panel configuration:
        Number of pixels: [328   1]
        Pixel size: [0.35 0.35]
        Pixel origin: bottom-left
Channel configuration:
        Number of channels: 1
Acquisition description:
        Number of positions: 120
        Angles 0-9 in degrees: [ -0.,  -3.,  -6.,  -9., -12., -15., -18., -21., -24., -27.]
        Angles 110-119 in degrees: [-330., -333., -336., -339., -342., -345., -348., -351., -354., -357.]
        Full angular array can be accessed with acquisition_data.geometry.angles
Distances in units: mm
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_geometry</span><span class="p">(</span><span class="n">ag</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_14_0.png" src="../../_images/demos_controlledWaveletSparsity_2d_14_0.png" />
</div>
</div>
</section>
</section>
<section id="Image-geometry-and-data">
<h2>Image geometry and data<a class="headerlink" href="#Image-geometry-and-data" title="Link to this heading">#</a></h2>
<p>Notice in particular how the <code class="docutils literal notranslate"><span class="pre">voxel_size</span></code> (or image pixel size) matches the reported value of 0.128 mm.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup image geometry</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">num_pixels</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">ig</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">get_ImageGeometry</span><span class="p">()</span>
<span class="n">ig</span><span class="o">.</span><span class="n">voxel_num_x</span> <span class="o">=</span> <span class="n">n</span>
<span class="n">ig</span><span class="o">.</span><span class="n">voxel_num_y</span> <span class="o">=</span> <span class="n">n</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ig</span><span class="p">)</span>

<span class="c1"># Setup data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">AcquisitionData</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">deep_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">ag</span><span class="p">)</span>
<span class="n">show2D</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of channels: 1
channel_spacing: 1.0
voxel_num : x327,y327
voxel_size : x0.12833333333333333,y0.12833333333333333
center : x0,y0

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_16_1.png" src="../../_images/demos_controlledWaveletSparsity_2d_16_1.png" />
</div>
</div>
<section id="Reconstructions">
<h3>Reconstructions<a class="headerlink" href="#Reconstructions" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">ProjectionOperator</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="n">x_bp</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># Simple backprojection</span>
<span class="n">show2D</span><span class="p">(</span><span class="n">x_bp</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Naive backprojection&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_18_0.png" src="../../_images/demos_controlledWaveletSparsity_2d_18_0.png" />
</div>
</div>
</section>
</section>
</section>
<section id="Wavelet-based-regularization">
<h1>Wavelet based regularization<a class="headerlink" href="#Wavelet-based-regularization" title="Link to this heading">#</a></h1>
<p>Classical approach in imaging problems (such as CT, denoising, etc.) is to try represent the key information about the solution using a wavelet basis. By construction a relatively sparse solution (i.e. only few nonzero components) should suffice, as opposed to pixel-based representation.</p>
<p>In short, we have the least squares data mismatch term of form</p>
<div class="math notranslate nohighlight">
\[\frac{1}{2} \| A x - m_\delta \|_2^2,\]</div>
<p>where <span class="math notranslate nohighlight">\(A\)</span> is the forward operator, <span class="math notranslate nohighlight">\(m_\delta\)</span> is the noisy data and <span class="math notranslate nohighlight">\(x\)</span> is the unknown solution. Then we add a regularization term of the form</p>
<div class="math notranslate nohighlight">
\[\alpha \| W(x) \|_1 = \alpha \sum_{j,k} | c(x)_{j,k} |,\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha &gt; 0\)</span> is the regularization term (balacing our trust in data and need in regularization) and <span class="math notranslate nohighlight">\(W\)</span> is the Discrete Wavelet Transform operator which decomposes any input <span class="math notranslate nohighlight">\(x\)</span> (signal, image or volume) into a sequence of coefficients <span class="math notranslate nohighlight">\(c(x)_{j,k}\)</span> of varying scale (<span class="math notranslate nohighlight">\(j \in \mathbb{N}\)</span>) and location (<span class="math notranslate nohighlight">\(k \in \mathbb{Z}^d\)</span>), such that</p>
<div class="math notranslate nohighlight">
\[x = \sum_{j,k} c(x)_{j,k} \psi_{j,k}.\]</div>
<section id="Wavelet-transform">
<h2>Wavelet transform<a class="headerlink" href="#Wavelet-transform" title="Link to this heading">#</a></h2>
<p>Classical choice is one of the orthogonal wavelets of <a class="reference external" href="https://en.wikipedia.org/wiki/Ingrid_Daubechies">Ingrid Daubechies</a>, usually distinguished by their smoothness properties. For example the Daubechies-2 wavelets always give continuous approximations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wname</span> <span class="o">=</span> <span class="s1">&#39;db2&#39;</span>
<span class="n">level</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">WaveletOperator</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">wname</span><span class="o">=</span><span class="n">wname</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Fast-Iterative-Soft-Thresholding-Algorithm-(FISTA)">
<h2>Fast Iterative Soft Thresholding Algorithm (FISTA)<a class="headerlink" href="#Fast-Iterative-Soft-Thresholding-Algorithm-(FISTA)" title="Link to this heading">#</a></h2>
<div class="line-block">
<div class="line">Equally classic choice of minimization algrorithm in the (Fast) Iterative Soft Thresholding Algorithm (ISTA), originally developed for wavelet-based denoising in</div>
<div class="line">&gt; Daubechies, I, Defrise, M, &amp; De Mol, C..</div>
<div class="line"><em>An iterative thresholding algorithm for linear inverse problems with a sparsity constraint.</em></div>
<div class="line">Communications on Pure and Applied Mathematics: A Journal Issued by the Courant Institute of Mathematical Sciences 57.11 (2004): 1413-1457.</div>
</div>
<p>Although we will run the accelerated version.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">LeastSquares</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">L1Sparsity</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

<span class="n">tau</span> <span class="o">=</span> <span class="mf">1e-5</span>  <span class="c1"># Regularization parameter</span>

<span class="n">fista</span> <span class="o">=</span> <span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">tau</span><span class="o">*</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s run arbitrary number of iterations (200)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fista</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bcdc5062b0cf40b1baaa2604f340abab", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_fista</span> <span class="o">=</span> <span class="n">fista</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
<span class="n">show2D</span><span class="p">(</span><span class="n">x_fista</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">fix_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;FISTA with </span><span class="si">{</span><span class="n">tau</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_26_0.png" src="../../_images/demos_controlledWaveletSparsity_2d_26_0.png" />
</div>
</div>
<p>Looks okay but how do we know the choice of regularization parameter was good? Could we get a better result with another value? Do we have the patience to try out dozens or even hundreds of values?</p>
<section id="Bulk-reconstruction-(slow)">
<h3>Bulk reconstruction (slow)<a class="headerlink" href="#Bulk-reconstruction-(slow)" title="Link to this heading">#</a></h3>
<p>Let’s try to reconstruct with a variety of different regularization parameters</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">J</span> <span class="o">=</span> <span class="mi">6</span>
<span class="nb">iter</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">regParams</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">recons</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">L2Vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">J</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">regVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">J</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>


<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">tau</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regParams</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tau</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fista</span> <span class="o">=</span> <span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">tau</span><span class="o">*</span><span class="n">g</span><span class="p">)</span>
    <span class="n">fista</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fista</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
    <span class="c1"># Store reconstruction</span>
    <span class="n">recons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># Evaluate data and regularization terms</span>
    <span class="n">L2Vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">regVals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tau = 1e-06
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "26fbfb42b6244c12beda4a0c84fd7d60", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tau = 3.9810717055349695e-05
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "73005e2d73fc45cda72a5f15a4e7034a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tau = 0.001584893192461114
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c9431c7b5ec646738f5ebc6972b77c38", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tau = 0.06309573444801943
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "efd0440edff840de94dc80b0cd397200", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tau = 2.511886431509582
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "13c0d1395fc84588a571667bdc0ad3fb", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tau = 100.0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ef31db44f513447ebfd35a1bd41f3b52", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot reconstructions</span>
<span class="n">show2D</span><span class="p">(</span><span class="n">recons</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tau = </span><span class="si">{</span><span class="n">tau</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="n">regParams</span><span class="p">],</span> <span class="n">fix_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">));</span>
<span class="c1"># Plot data mismatch vs. regularization term of each minimizer</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">regVals</span><span class="p">,</span> <span class="n">L2Vals</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Space of minimizers&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Data mismatch&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Regularizer&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_30_0.png" src="../../_images/demos_controlledWaveletSparsity_2d_30_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_30_1.png" src="../../_images/demos_controlledWaveletSparsity_2d_30_1.png" />
</div>
</div>
<p>Methods like L-curve can help choose suitable value from such curves but require many runs of the algorithm (most of which are “wasted” computations).</p>
</section>
</section>
<section id="Sparsity-levels-of-the-bulk-reconstruction">
<h2>Sparsity levels of the bulk reconstruction<a class="headerlink" href="#Sparsity-levels-of-the-bulk-reconstruction" title="Link to this heading">#</a></h2>
<p>Let’s compute the ration of “meaningful” wavelet coefficients in the minimizers</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sparsityLevels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">J</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">Wlen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># Number of Approximation Coefficients</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">level</span><span class="p">):</span>
    <span class="n">Wlen</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">W</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">()</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">_shapes</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">W</span><span class="o">.</span><span class="n">domain_geometry</span><span class="p">()</span><span class="o">.</span><span class="n">ndim</span><span class="o">*</span><span class="s1">&#39;d&#39;</span><span class="p">])</span> <span class="c1"># Number of Detail Coefficients for level ´l´</span>
<span class="n">kappa</span> <span class="o">=</span> <span class="mf">1e-7</span> <span class="c1"># Threshold for &quot;meaningful&quot; or &quot;big&quot; coefficients</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
    <span class="n">Wx</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">direct</span><span class="p">(</span><span class="n">recons</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">sparsityLevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wx</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">Wlen</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">regParams</span><span class="p">,</span> <span class="n">sparsityLevels</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sparsity levels&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Regularization parameter&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Wavelet sparsity (%)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_33_0.png" src="../../_images/demos_controlledWaveletSparsity_2d_33_0.png" />
</div>
</div>
<p>The not-so-good reconstructions seem to either have very high (~100%) or very low (~0%) amount of “meaningful” wavelet coefficients since they are either dominated by noise or lack all details. Maybe we can use this to our advantage?</p>
<section id="Automated-Controlled-Sparsity">
<h3>Automated Controlled Sparsity<a class="headerlink" href="#Automated-Controlled-Sparsity" title="Link to this heading">#</a></h3>
<div class="line-block">
<div class="line">We follow the automated tuning strategy as introduced in</div>
<div class="line">&gt; Purisha, Z., Rimpeläinen, J., Bubba, T., &amp; Siltanen, S. (2017).</div>
<div class="line"><em>Controlled wavelet domain sparsity for x-ray tomography</em>.</div>
<div class="line">Measurement Science and Technology, 29(1), 014002.</div>
<div class="line"><a class="reference external" href="https://doi.org/10.1088/1361-6501/aa9260">DOI:10.1088/1361-6501/aa9260</a></div>
</div>
<p>We’ll try to implement it as a <code class="docutils literal notranslate"><span class="pre">StepSizeRule</span></code> and <code class="docutils literal notranslate"><span class="pre">callback</span></code>. However we are NOT actually changing the <code class="docutils literal notranslate"><span class="pre">step_size</span></code> (which is based on the Lipschitz constant of the data mistmatch term) but the regularization parameter <code class="docutils literal notranslate"><span class="pre">tau</span></code>. However, we can update it every iterate by using <code class="docutils literal notranslate"><span class="pre">StepSizeRule</span></code> (in fact we could pass it an actual <code class="docutils literal notranslate"><span class="pre">StepSizeRule</span></code> to perform but let’s just stick with constant value for now).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">SparsityControl</span><span class="w"> </span><span class="kn">import</span> <span class="n">ControlledSparsity</span><span class="p">,</span> <span class="n">DesiredSparsity</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg_weight</span> <span class="o">=</span> <span class="mf">1e-2</span> <span class="c1"># Initial value</span>
<span class="c1"># Automated tuning of regularization parameter</span>
<span class="n">desired_sparsity</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="c1"># Let&#39;s require that 30% of the wavelet coefficients must be &quot;meaningful&quot;</span>
<span class="n">sparsity_ctrl</span> <span class="o">=</span> <span class="n">ControlledSparsity</span><span class="p">(</span><span class="n">desired_sparsity</span><span class="o">=</span><span class="n">desired_sparsity</span><span class="p">)</span>
<span class="n">fista_controlled</span> <span class="o">=</span> <span class="n">FISTA</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">reg_weight</span><span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">sparsity_ctrl</span><span class="p">,</span> <span class="n">max_iteration</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sparsity based stopping rule</span>
<span class="n">sparsity_stop</span> <span class="o">=</span> <span class="n">DesiredSparsity</span><span class="p">(</span><span class="n">print_stuff</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rel_change_tol</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fista_controlled</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">sparsity_stop</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iteration : 5 | Current sparsity: 0.973 | Regularization param.: 9.56e-03 | Desired sparsity: 0.300 | Difference: 0.673 | Beta: 5.90e-05 | Relative change: 8.82e-02
Iteration : 10 | Current sparsity: 0.965 | Regularization param.: 9.76e-03 | Desired sparsity: 0.300 | Difference: 0.665 | Beta: 5.90e-05 | Relative change: 5.13e-02
Iteration : 15 | Current sparsity: 0.950 | Regularization param.: 9.95e-03 | Desired sparsity: 0.300 | Difference: 0.650 | Beta: 5.90e-05 | Relative change: 3.04e-02
Iteration : 20 | Current sparsity: 0.931 | Regularization param.: 1.01e-02 | Desired sparsity: 0.300 | Difference: 0.631 | Beta: 5.90e-05 | Relative change: 1.78e-02
Iteration : 25 | Current sparsity: 0.908 | Regularization param.: 1.03e-02 | Desired sparsity: 0.300 | Difference: 0.608 | Beta: 5.90e-05 | Relative change: 1.17e-02
Iteration : 30 | Current sparsity: 0.884 | Regularization param.: 1.05e-02 | Desired sparsity: 0.300 | Difference: 0.584 | Beta: 5.90e-05 | Relative change: 8.16e-03
Iteration : 35 | Current sparsity: 0.857 | Regularization param.: 1.07e-02 | Desired sparsity: 0.300 | Difference: 0.557 | Beta: 5.90e-05 | Relative change: 6.29e-03
Iteration : 40 | Current sparsity: 0.826 | Regularization param.: 1.08e-02 | Desired sparsity: 0.300 | Difference: 0.526 | Beta: 5.90e-05 | Relative change: 5.30e-03
Iteration : 45 | Current sparsity: 0.792 | Regularization param.: 1.10e-02 | Desired sparsity: 0.300 | Difference: 0.492 | Beta: 5.90e-05 | Relative change: 4.57e-03
Iteration : 50 | Current sparsity: 0.757 | Regularization param.: 1.11e-02 | Desired sparsity: 0.300 | Difference: 0.457 | Beta: 5.90e-05 | Relative change: 3.99e-03
Iteration : 55 | Current sparsity: 0.722 | Regularization param.: 1.12e-02 | Desired sparsity: 0.300 | Difference: 0.422 | Beta: 5.90e-05 | Relative change: 3.58e-03
Iteration : 60 | Current sparsity: 0.687 | Regularization param.: 1.14e-02 | Desired sparsity: 0.300 | Difference: 0.387 | Beta: 5.90e-05 | Relative change: 3.27e-03
Iteration : 65 | Current sparsity: 0.653 | Regularization param.: 1.15e-02 | Desired sparsity: 0.300 | Difference: 0.353 | Beta: 5.90e-05 | Relative change: 3.03e-03
Iteration : 70 | Current sparsity: 0.621 | Regularization param.: 1.16e-02 | Desired sparsity: 0.300 | Difference: 0.321 | Beta: 5.90e-05 | Relative change: 2.84e-03
Iteration : 75 | Current sparsity: 0.592 | Regularization param.: 1.17e-02 | Desired sparsity: 0.300 | Difference: 0.292 | Beta: 5.90e-05 | Relative change: 2.66e-03
Iteration : 80 | Current sparsity: 0.565 | Regularization param.: 1.17e-02 | Desired sparsity: 0.300 | Difference: 0.265 | Beta: 5.90e-05 | Relative change: 2.50e-03
Iteration : 85 | Current sparsity: 0.540 | Regularization param.: 1.18e-02 | Desired sparsity: 0.300 | Difference: 0.240 | Beta: 5.90e-05 | Relative change: 2.38e-03
Iteration : 90 | Current sparsity: 0.518 | Regularization param.: 1.19e-02 | Desired sparsity: 0.300 | Difference: 0.218 | Beta: 5.90e-05 | Relative change: 2.26e-03
Iteration : 95 | Current sparsity: 0.498 | Regularization param.: 1.19e-02 | Desired sparsity: 0.300 | Difference: 0.198 | Beta: 5.90e-05 | Relative change: 2.15e-03
Iteration : 100 | Current sparsity: 0.480 | Regularization param.: 1.20e-02 | Desired sparsity: 0.300 | Difference: 0.180 | Beta: 5.90e-05 | Relative change: 2.05e-03
Iteration : 105 | Current sparsity: 0.464 | Regularization param.: 1.20e-02 | Desired sparsity: 0.300 | Difference: 0.164 | Beta: 5.90e-05 | Relative change: 1.97e-03
Iteration : 110 | Current sparsity: 0.449 | Regularization param.: 1.21e-02 | Desired sparsity: 0.300 | Difference: 0.149 | Beta: 5.90e-05 | Relative change: 1.89e-03
Iteration : 115 | Current sparsity: 0.436 | Regularization param.: 1.21e-02 | Desired sparsity: 0.300 | Difference: 0.136 | Beta: 5.90e-05 | Relative change: 1.82e-03
Iteration : 120 | Current sparsity: 0.425 | Regularization param.: 1.22e-02 | Desired sparsity: 0.300 | Difference: 0.125 | Beta: 5.90e-05 | Relative change: 1.75e-03
Iteration : 125 | Current sparsity: 0.415 | Regularization param.: 1.22e-02 | Desired sparsity: 0.300 | Difference: 0.115 | Beta: 5.90e-05 | Relative change: 1.69e-03
Iteration : 130 | Current sparsity: 0.405 | Regularization param.: 1.22e-02 | Desired sparsity: 0.300 | Difference: 0.105 | Beta: 5.90e-05 | Relative change: 1.63e-03
Iteration : 135 | Current sparsity: 0.397 | Regularization param.: 1.23e-02 | Desired sparsity: 0.300 | Difference: 0.097 | Beta: 5.90e-05 | Relative change: 1.58e-03
Iteration : 140 | Current sparsity: 0.390 | Regularization param.: 1.23e-02 | Desired sparsity: 0.300 | Difference: 0.090 | Beta: 5.90e-05 | Relative change: 1.53e-03
Iteration : 145 | Current sparsity: 0.383 | Regularization param.: 1.23e-02 | Desired sparsity: 0.300 | Difference: 0.083 | Beta: 5.90e-05 | Relative change: 1.48e-03
Iteration : 150 | Current sparsity: 0.377 | Regularization param.: 1.23e-02 | Desired sparsity: 0.300 | Difference: 0.077 | Beta: 5.90e-05 | Relative change: 1.43e-03
Iteration : 155 | Current sparsity: 0.371 | Regularization param.: 1.24e-02 | Desired sparsity: 0.300 | Difference: 0.071 | Beta: 5.90e-05 | Relative change: 1.39e-03
Iteration : 160 | Current sparsity: 0.367 | Regularization param.: 1.24e-02 | Desired sparsity: 0.300 | Difference: 0.067 | Beta: 5.90e-05 | Relative change: 1.34e-03
Iteration : 165 | Current sparsity: 0.363 | Regularization param.: 1.24e-02 | Desired sparsity: 0.300 | Difference: 0.063 | Beta: 5.90e-05 | Relative change: 1.30e-03
Iteration : 170 | Current sparsity: 0.358 | Regularization param.: 1.24e-02 | Desired sparsity: 0.300 | Difference: 0.058 | Beta: 5.90e-05 | Relative change: 1.26e-03
Iteration : 175 | Current sparsity: 0.354 | Regularization param.: 1.24e-02 | Desired sparsity: 0.300 | Difference: 0.054 | Beta: 5.90e-05 | Relative change: 1.22e-03
Iteration : 180 | Current sparsity: 0.350 | Regularization param.: 1.24e-02 | Desired sparsity: 0.300 | Difference: 0.050 | Beta: 5.90e-05 | Relative change: 1.18e-03
Iteration : 185 | Current sparsity: 0.347 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.047 | Beta: 5.90e-05 | Relative change: 1.15e-03
Iteration : 190 | Current sparsity: 0.343 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.043 | Beta: 5.90e-05 | Relative change: 1.11e-03
Iteration : 195 | Current sparsity: 0.341 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.041 | Beta: 5.90e-05 | Relative change: 1.08e-03
Iteration : 200 | Current sparsity: 0.337 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.037 | Beta: 5.90e-05 | Relative change: 1.04e-03
Iteration : 205 | Current sparsity: 0.335 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.035 | Beta: 5.90e-05 | Relative change: 1.01e-03
Iteration : 210 | Current sparsity: 0.332 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.032 | Beta: 5.90e-05 | Relative change: 9.84e-04
Iteration : 215 | Current sparsity: 0.329 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.029 | Beta: 5.90e-05 | Relative change: 9.56e-04
Iteration : 220 | Current sparsity: 0.327 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.027 | Beta: 5.90e-05 | Relative change: 9.28e-04
Iteration : 225 | Current sparsity: 0.325 | Regularization param.: 1.25e-02 | Desired sparsity: 0.300 | Difference: 0.025 | Beta: 5.90e-05 | Relative change: 9.03e-04
Iteration : 230 | Current sparsity: 0.323 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.023 | Beta: 5.90e-05 | Relative change: 8.78e-04
Iteration : 235 | Current sparsity: 0.321 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.021 | Beta: 5.90e-05 | Relative change: 8.51e-04
Iteration : 240 | Current sparsity: 0.320 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.020 | Beta: 5.90e-05 | Relative change: 8.27e-04
Iteration : 245 | Current sparsity: 0.318 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.018 | Beta: 5.90e-05 | Relative change: 8.01e-04
Iteration : 250 | Current sparsity: 0.317 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.017 | Beta: 5.90e-05 | Relative change: 7.79e-04
Iteration : 255 | Current sparsity: 0.315 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.015 | Beta: 5.90e-05 | Relative change: 7.57e-04
Iteration : 260 | Current sparsity: 0.314 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.014 | Beta: 5.90e-05 | Relative change: 7.35e-04
Iteration : 265 | Current sparsity: 0.313 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.013 | Beta: 5.90e-05 | Relative change: 7.13e-04
Iteration : 270 | Current sparsity: 0.312 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.012 | Beta: 5.90e-05 | Relative change: 6.93e-04
Iteration : 275 | Current sparsity: 0.310 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.010 | Beta: 5.90e-05 | Relative change: 6.73e-04
Iteration : 280 | Current sparsity: 0.310 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.010 | Beta: 5.90e-05 | Relative change: 6.53e-04
Iteration : 285 | Current sparsity: 0.309 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.009 | Beta: 5.90e-05 | Relative change: 6.33e-04
Iteration : 290 | Current sparsity: 0.308 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.008 | Beta: 5.90e-05 | Relative change: 6.16e-04
Iteration : 295 | Current sparsity: 0.307 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.007 | Beta: 5.90e-05 | Relative change: 5.99e-04
Iteration : 300 | Current sparsity: 0.306 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.006 | Beta: 5.90e-05 | Relative change: 5.83e-04
Iteration : 305 | Current sparsity: 0.305 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.005 | Beta: 5.90e-05 | Relative change: 5.68e-04
Iteration : 310 | Current sparsity: 0.305 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.005 | Beta: 5.90e-05 | Relative change: 5.55e-04
Iteration : 315 | Current sparsity: 0.304 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.004 | Beta: 5.90e-05 | Relative change: 5.43e-04
Iteration : 320 | Current sparsity: 0.303 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.003 | Beta: 5.90e-05 | Relative change: 5.30e-04
Iteration : 325 | Current sparsity: 0.302 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.002 | Beta: 5.90e-05 | Relative change: 5.17e-04
Iteration : 330 | Current sparsity: 0.302 | Regularization param.: 1.26e-02 | Desired sparsity: 0.300 | Difference: 0.002 | Beta: 5.90e-05 | Relative change: 5.05e-04
Desired sparsity reached after 332 iterations!
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_controlled</span> <span class="o">=</span> <span class="n">fista_controlled</span><span class="o">.</span><span class="n">solution</span>
<span class="n">show2D</span><span class="p">([</span><span class="n">x_fista</span><span class="p">,</span> <span class="n">x_controlled</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Fixed reg. param.&quot;</span><span class="p">,</span> <span class="s2">&quot;Automated reg. param.&quot;</span><span class="p">],</span> <span class="n">fix_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_40_0.png" src="../../_images/demos_controlledWaveletSparsity_2d_40_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">N</span> <span class="o">=</span> <span class="n">fista_controlled</span><span class="o">.</span><span class="n">iterations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sparsity_ctrl</span><span class="o">.</span><span class="n">sparsity_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Current sparsity&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">sparsity_ctrl</span><span class="o">.</span><span class="n">desired_sparsity</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Desired sparsity&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Sparsity level&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">sparsity_ctrl</span><span class="o">.</span><span class="n">reg_param_vals</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Regularization parameter&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">label_outer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_controlledWaveletSparsity_2d_41_0.png" src="../../_images/demos_controlledWaveletSparsity_2d_41_0.png" />
</div>
</div>
<p>Here we can see how increasing the regularization parameter (lower plot) drives the sparsity level down towards the desired level (top plot). The iteration can be stopped once the suitable level has been reached (and the relative change is small enough).</p>
<p>Notice also how the tuning is adaptive, in the sense that as we get closer to the desired sparsity level, the incremental changes in the regularization parameter get finer.</p>
</section>
</section>
<section id="Limitations-of-the-method">
<h2>Limitations of the method<a class="headerlink" href="#Limitations-of-the-method" title="Link to this heading">#</a></h2>
<p>The method does not fully automate the choice of regularization parameter as the desired sparsity level and some of the tuning parameters still need to be chosen. However, chosing a good level of sparsity is much easier, the values are clearly bounded between 0 and 1 (corresponding to 0% and 100% of coefficients being “meaningful”) and the tuning parameters mostly affect the speed on the method. Moreover, with bit of experience, it is relatively easy to tell early whether the choice will be good
and restart the algorithm if needed.</p>
</section>
<section id="How-to-pick-desired-sparsity?">
<h2>How to pick <em>desired sparsity</em>?<a class="headerlink" href="#How-to-pick-desired-sparsity?" title="Link to this heading">#</a></h2>
<p>In the original paper it is assumed that a reference image or reconstruction could give the desired sparsity level. In practice this depends a lot on the data and the reconstruction method and an educated guess (c.f. <a class="reference external" href="https://www.urbandictionary.com/define.php?term=Stetson-Harrison%20method">Stetson-Harrison</a>) often works fine.</p>
<p>For example a TV regularized solution will be much smoother than filtered backprojection and hence the reference sparsity would be lower. In general values around 25-40% seem to work fine. Very rarely is the sparsity level &gt; 60% with wavelets. Other representation systems (like <a class="reference external" href="doi.org/10.1088/1361-6420/ab9c15">shearlets</a>) usually require higher levels.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../recon_phasecontrast_exciscope/"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Exciscope Polaris phase contrast reconstruction with CIL</p>
      </div>
    </a>
    <a class="right-next"
       href="../controlledWaveletSparsity_3d/"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Controlled Wavelet Sparsity using callbacks (3D data)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=3357575206ef0862cebd"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=3357575206ef0862cebd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2017-2024.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>